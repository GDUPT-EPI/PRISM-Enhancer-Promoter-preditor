# PRISM项目编程规范

## 🎯 项目背景与目标

### 核心任务
- **任务**: 仅使用DNA序列信息预测增强子-启动子(EP)互作
- **挑战**: 不同细胞系间特异性差异巨大，单一模型在未见细胞系上容易失效
- **目标**: 解耦"跨细胞系共性表征(z_I)"和"细胞系特异模块(z_F)"，提升泛化能力
- **验收标准**: domain-kl/test及各细胞系AUPR ≥ 0.75

### 当前技术瓶颈
- **S1 vs S2竞争问题**: S2在同等输入条件下无法战胜S1，导致Pull失效
- **上下文感知缺失**: S1为Pointwise模型，无法利用Batch信息推断环境
- **域泛化挑战**: 需要在保持共性表征的同时适应细胞系特异性
- **记录点15状态**: 正在尝试"注入上帝视角的作弊者"和"赋予学生上下文感知"方案

## 🔥 核心原则 (首要执行)

### 函数依赖管理
- **严格处理函数间依赖关系**：确保函数参数传递、返回值和数据流的正确性
- **逻辑完整性原则**：每一行代码都必须经过逻辑验证，避免引入任何潜在错误
- **数据一致性检查**：所有输入输出必须验证数据类型、形状和值域范围
- **张量维度追踪**：对于复杂的张量操作，必须明确标注每步的维度变化

### 代码质量标准
- **功能注释强制要求**：每个函数必须包含输入、输出、功能说明的完整注释
- **复杂逻辑详细解释**：对于算法核心部分(如能量耗散、域对抗)，逐步解释计算逻辑和数学原理
- **模块级文档**：类和模块需要包含设计思路和使用场景说明
- **生物学意义说明**：对于生物信息学相关的计算，需要解释其生物学含义

## ⚡ 简洁性与直接性原则 (技术债务控制)

### 代码简洁性要求
- **直接、简单、非冗长**：优先选择最直接的解决方案，避免过度复杂的实现
- **拒绝过度工程化**：不要为了"鲁棒性"而添加不必要的复杂度
- **禁止防御性编程过度**：避免循环导入、回退性策略等过度过程化的错误手段
  ```python
  # ❌ 避免这样做
  try:
      import pandas as pd
  except ImportError:
      print("请安装pandas")
      
  # ✅ 直接导入
  import pandas as pd
  ```

### 技术债务控制
- **避免回避式解决方案**：禁止创建"备用"、"替代"或"fallback"函数来绕过问题
- **直接修复优先**：在当前函数内直接解决问题，不要创建绕过性的替代函数
- **拒绝过度调试架构**：
  - 不引入复杂的调试框架
  - 不添加大量的样板错误处理代码
  - 不使用第三方调试库（除非绝对必要）

### 清晰度优于鲁棒性
- **代码清晰度是第一优先级**：代码需要尽可能清晰明确，不要为了"万无一失"而复杂化
- **添加必要注释**：对复杂逻辑添加清晰的注释，并对必要参数写好行尾注释以明确调参策略
- **避免过度类型检查**：不要为每个变量都添加类型验证

## 📁 PRISM项目结构规则

### 路径管理
- **集中配置**: 所有路径在`config.py`中定义，使用`PROJECT_ROOT`作为基准
- **相对路径**: 禁止硬编码绝对路径，所有路径基于项目根目录
- **目录约定**:
  - `/models/`: 模型架构和组件
  - `/domain-kl/`: PRISM专用训练数据（`DOMAIN_KL_DIR`）
  - `/_cache/`: PyTorch张量缓存（`CACHE_DIR`）
  - `/docx/记录点n/`: 实验方案和分析文档
  - `{PRISM_SAVE_MODEL_DIR}/`: 模型检查点保存（`save_model/{SAVEMODEL_NAME}/`）
  - `{PRISM_SAVE_MODEL_DIR}/log/`: 训练日志存储
  - `compete/{SAVEMODEL_NAME}/`: 预测结果存储

### 命名规范
- **文件**: snake_case (如`data_loader.py`, `PRISM.py`)
- **类**: PascalCase (如`PRISMBackbone`, `CBATTransformerEncoderLayer`)
- **函数**: snake_case，描述性命名 (如`load_prism_data`, `compute_loss`)
- **常量**: UPPER_CASE在config.py中 (如`BATCH_SIZE`, `LEARNING_RATE`)
- **变量**: snake_case，生物学术语保持原样 (如`enhancer_ids`, `z_I`, `U_I`)

### 日志管理
- **训练日志路径**: 使用`{PRISM_SAVE_MODEL_DIR}/log/`存储训练日志
- **预测结果路径**: 使用`compete/{SAVEMODEL_NAME}/`存储预测结果
- **实验记录路径**: 使用`./docx/记录点n/`管理实验方案和分析
- **记录点结构**: 每个记录点包含三个文件：
  - 实验配置和参数
  - 训练日志和指标
  - 结果分析和总结

## 🧠 编程思考模型优化

### 问题分析思维
1. **需求拆解**：将复杂任务分解为可验证的小步骤
2. **数据流追踪**：明确每个变量的来源、变换过程和去向
3. **边界条件考虑**：提前处理空值、异常值和极端情况
4. **性能影响评估**：考虑内存使用、计算复杂度和IO效率
5. **生物学合理性**：确保算法设计符合生物学原理

### 代码设计策略
- **单一职责原则**：每个函数只做一件事情，且做到极致
- **可测试性设计**：函数接口清晰，便于单元测试和调试
- **配置集中管理**：超参数、路径等配置统一在`config.py`中定义
- **路径相对化**：使用基于项目的集中式路径配置模式
- **错误处理机制**：预见性地处理可能的异常情况（但不过度）

### PRISM特定设计原则
- **解耦优先**：始终考虑如何分离共性表征(z_I)和细胞系特异性(z_F)
- **物理启发**：能量耗散框架U_I - R_E必须有明确的物理意义
- **域对抗设计**：使用梯度反转层确保z_I不包含细胞系信息
- **正交约束**：确保z_I ⊥ z_F的数学严格性

## ⚙️ 技术实现规范

### Python代码标准
- **版本**：Python 3.10+
- **PEP 8严格遵守**：代码风格、导入顺序、行长度等符合标准
- **类型提示**：所有函数参数和返回值必须包含类型注解
- **文档字符串**：使用Google风格的docstring格式

### PyTorch特定规范
- **张量操作**：明确标注每个张量的形状 `# [B, L, D]`
- **设备管理**：统一使用`device`变量，避免硬编码cuda
- **梯度管理**：明确标注`requires_grad`和`with torch.no_grad()`的使用
- **内存优化**：合理使用`del`和`torch.cuda.empty_cache()`

### 命令行调用原则
- **禁止命令行参数**：所有配置通过`config.py`内部常量定义，不依赖外部参数
- **执行方式**：
  - 训练：`python PRISM.py`
  - 评估：`python predict.py`
  - 快速执行：`bash run.sh`

## 🐛 调试与问题解决

### 简单调试优先
- **print()语句调试**：首选最简单的print()输出进行调试
- **基础logging**：仅在必要时使用Python标准库的logging
- **逐步验证**：通过中间结果输出，验证每个计算步骤的正确性
- **避免复杂调试工具**：不使用第三方调试框架、profiler等复杂工具

### 根因分析方法
- **直接修复原则**：在当前函数内部直接解决问题
- **不创建绕过函数**：绝对禁止为了规避错误而创建"备用"函数
- **设计问题识别**：如果无法直接修复，明确说明设计层面的根本问题
- **拒绝复杂错误处理**：不添加大量的try-except嵌套和样板错误处理

### PRISM特定调试策略
- **损失分解**：分别监控base_loss, adaptive_loss, penalty_loss, sparse_loss, orth_loss
- **特征可视化**：定期检查z_I和z_F的分布和正交性
- **细胞系泛化**：重点关注未见细胞系的AUPR指标
- **能量物理检查**：验证U_I和R_E的数值合理性和物理意义

## 📊 实验管理规范

### 记录点管理
- **方案目录结构**：`./docx/记录点n/`
- **训练日志路径**：`{PRISM_SAVE_MODEL_DIR}/log/`
- **预测结果路径**：`compete/{SAVEMODEL_NAME}/`
- **必需文件**：
  - `docx/记录点n/记录点n方案.md`: 实验方案和理论
  - `{PRISM_SAVE_MODEL_DIR}/log/记录点n训练日志.log`: 训练过程和指标
  - `compete/{SAVEMODEL_NAME}/记录点n预测结果.txt`: 预测结果和分析
- **版本控制**：每个记录点对应一个完整的实验版本

### 指标监控
- **主要指标**：AUPR ≥ 0.75 (验收标准)
- **辅助指标**：AUC, F1, Precision, Recall
- **泛化指标**：未见细胞系的性能表现
- **损失监控**：各组件损失的平衡性