EP互作预测整体工作流（纯序列 + 细胞系模块解耦）
==============================================

目标与约束
----------
- 任务：在仅使用 DNA 序列信息的前提下，挖掘增强子–启动子 (Enhancer/Promoter, E/P) 互作。
- 核心难点：不同细胞系之间的特异性差异大，单一模型容易在未见细胞系上失效。
- 设计目标：在 Backbone 主干上解耦“跨细胞系共性表征”和“细胞系特异模块”，提升未见细胞系上的鲁棒性。
- 验收标准：domain-kl/test 及各细胞系 AUPR ≥ 0.75。

关键代码位置
----------
- 模型主干：`models/PRISMModel.py`
- 蒸馏与竞争机制：`models/layers/distill.py`
- 主训练脚本：`PRISM.py`
- 推理与评估脚本：`predict.py`

统一工作流总览
--------------
1. 阅读与对齐最新历史记录
   - 打开 `docx/基线结果.log`，获取当前基线性能和评估指标定义。
   - 打开 `docx/历史索引.md`，了解从记录点1到最新记录点 (如记录点13) 的设计演化、问题和结论。
   - 明确当前“记录点 n”和本轮工作的起点，例如当前为 n=13。

2. 确认当前性能与目标差距
   - 基于 `基线结果.log` 和最近一轮 `log/记录点n训练日志.log`、`log/记录点n预测结果.txt`：
     - 统计各细胞系 AUPR/AUC，关注未见细胞系 (domain-kl/test)。
     - 与 AUPR ≥ 0.75 的目标对比，记录每个细胞系的差距和典型失败模式（如 Recall≈1, Precision 低）。
   - 如果当前 AUPR 已 ≥ 0.75，则只需做小修复与稳定性验证，无需大改架构。

3. 形成“记录点 n 的反思”
   - 在 `docx/记录点n/记录点n反思.md` 中补充本轮观察（若文件已存在，则在末尾追加本次总结）：
     - 本轮使用的模型版本和关键开关（Backbone 结构、蒸馏/对抗设置、采样策略等）。
     - 各细胞系上的核心现象：是否存在模式坍缩、某些细胞系极端高 Recall/低 Precision、未见细胞系性能。
     - 针对 `历史索引.md` 中记录点 n 的“结论”，评估这些结论在当前实验中是否被验证或否决。
     - 结合“细胞系共性 vs 特性解耦”的目标，明确：
       - 共性通路（Backbone）是否稳定，排序是否可靠。
       - 特性通路（细胞系模块/蒸馏模块）是否真正参与推理，是否在未见细胞系上产生帮助。

4. 设计“记录点 n+1 的方案”
   - 在 `docx/记录点(n+1)/记录点(n+1)方案.md` 中撰写下一轮计划，内容必须包括：
     - 本轮要保留的稳定组件（例如：现有 PRISMBackbone 的 E/P 直接交互路径，已验证有效的注意力形式）。
     - 本轮要修改或重构的部分：
       - 细胞系模块的位置（Backbone 旁路/能量头旁路/蒸馏分支）。
       - 细胞系模块输入（显式 ID、Batch 上下文、原型图等）以及如何与 Backbone 表征结合。
       - 蒸馏/竞争/对抗损失的目标函数与权重，避免过多目标叠加在单一通路上。
     - 明确本轮要验证的科学假设，例如：
       - “在 Backbone 旁路引入轻量细胞系向量 z_c，并在推理时通过少量 Support 样本自适应 z_c，可以提升未见细胞系 AUPR。”
       - “将能量头公式固定为 `P(y=1) = σ((U_I - R_E)/T)`，并限制 Student 仅预测 R_E，可缓解模式坍缩。”
     - 定义本轮的成功判据：
       - 至少一个未见细胞系相对上一记录点 AUPR 提升 ≥ 0.03。
       - 训练集与 domain-kl/test 的 AUPR 差距收敛，而非单纯拉高训练集。

5. 更新 `docx/历史索引.md`
   - 在历史索引中追加“记录点 n+1”的条目，简要记录：
     - 主要结构改动。
     - 预期解决的问题（对应过往记录点的哪几条反思）。
     - 本轮判定成功/失败的标准。
   - 保持描述风格与现有记录点1–13一致，便于后续模型快速通读演化路径。

6. 代码修改阶段（本工作流只规划，不在此步骤写代码）
   - 在开始写代码前，完整阅读：
     - `models/PRISMModel.py`（关注 Backbone 结构、能量头、细胞系相关分支）；
     - `models/layers/distill.py`（Teacher/Student/Opportunist 或其他蒸馏模块的实现）；
     - `PRISM.py`（训练循环、采样策略、损失组合）；
     - `predict.py`（推理路径，特别是是否真正使用了细胞系模块和上下文）。
   - 确认数据流是否满足当前“记录点(n+1)方案”中的设想：
     - 训练和推理时是否使用一致形式的输入（特别是细胞系模块的输入）。
     - 细胞系模块是否仅在训练损失中出现，还是也真正影响最终预测。
   - 然后再根据方案进行最小必要的代码修改，避免引入新一轮不可控复杂度。

7. 训练与预测执行顺序
   - 训练：
     - 运行 `PRISM.py`，确保：
       - 使用与方案对应的配置（例如是否启用 CellBatchSampler、是否启用蒸馏分支等）。
       - 日志输出保存到新的 `log/记录点(n+1)训练日志.log` 中，便于后续对比。
   - 预测：
     - 训练完成后，运行 `predict.py`：
       - 确认预测脚本与本轮架构一致，例如是否使用细胞系模块、是否按细胞系分组推理。
       - 输出写入 `log/记录点(n+1)预测结果.txt`。
   - 记录：
     - 在 `docx/记录点(n+1)/记录点(n+1)结果.md` 中整理关键曲线与表格（各细胞系 AUPR/AUC）。

8. 循环迭代直至达到 AUPR≥75%
   - 每完成一轮 n→n+1：
     - 回到第2步，对照 AUPR≥0.75 的目标重新评估。
     - 若仍未达标，则继续按“反思 → 方案 → 修改 → 训练 → 预测 → 记录”的流程迭代。
   - 严格避免“只改代码不写反思/方案”的跳跃式尝试，确保每一次变化都在历史索引中有明确位置。

新模型/新助理的使用指引
----------------------
所有后续接入本项目的模型或助理在开始任何修改前，必须按如下顺序阅读：
1. `docx/历史索引.md`：了解从记录点1到当前的所有关键设计、失败模式与结论。
2. 最新两个记录点的详细文档：
   - `docx/记录点n/记录点n反思.md`
   - `docx/记录点n/记录点n方案.md`
3. 当前工作流文档：`workflow/EP_workflow.md`（本文件）。

在完成上述阅读后，新模型应：
- 明确当前所处记录点编号 n；
- 明确上一轮实验的失败模式及其根因；
- 按照本文件第4步为记录点 n+1 设计方案，再进入代码修改与训练阶段。

