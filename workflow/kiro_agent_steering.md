Kiro Agent Steering（EP互作预测）
===============================

本文件定义 Agent 在本项目中的“决策准则与默认策略”，用于在不改动总体工作流的前提下，约束每次迭代的行为方式。
它与 `workflow/kiro_agent_hooks.md` 配合使用：
- Hook 负责“什么时候做什么、产出什么文件”。
- Steering 负责“怎么做决策、优先级是什么、什么情况禁止做”。


一、任务边界（Scope）
------------------
- 任务：仅基于 DNA 序列信息进行 E/P 互作预测。
- 禁止：引入任何外部生物学辅助信号（例如活性、TAD、ChIP、ATAC 等）
- 验收：以 AUPR 为硬指标，目标为 AUPR ≥ 0.75（优先关注未见细胞系 domain-kl/test）。


二、核心设计信念（Non-Negotiables）
------------------------------
1. 共性/特性解耦
   - Backbone 负责跨细胞系稳定的“互作兼容性/排序能力”。
   - 细胞系模块作为旁路，负责“环境/特异性校准”，必须在推理端真实生效。

2. 训练-推理一致性
   - 训练时出现的关键条件（例如 Context Batch、Support Set、细胞系模块输入形式）必须在 `predict.py` 中可复现。
   - 任何“只在 loss 里出现、但不影响最终预测”的模块默认判定为无效。

3. 迭代闭环优先于代码推进
   - 在完成 `反思 → 方案 → 历史索引更新` 之前，不进入代码修改。
   - 每轮只允许 1–2 个核心改动，避免变量爆炸。


三、指标优先级（Metric Priorities）
------------------------------
1. 首要指标：domain-kl/test 的 AUPR。
2. 次要指标：各细胞系 AUPR 的均值与最差值（min）。
3. 警戒指标（出现则优先排查模式坍缩/校准问题）：
   - Recall≈1 且 Precision≈0.5（或显著偏低）
   - 预测概率极端 0/1 或接近常数
   - 训练集 AUPR 很高但 domain-kl/test 接近随机


四、默认诊断路径（Default Debug Path）
-----------------------------------
当 AUPR 未达标时，按以下顺序归因（从最常见、最致命到次要）：
1. 推理断裂：`predict.py` 是否实际调用细胞系模块/上下文推理。
2. 训练-推理输入不一致：训练的采样/上下文形式在推理是否可复用。
3. 输出校准问题：概率整体上移/下移导致 PR 面积下降。
4. 模式坍缩：损失博弈叠加导致输出收缩或极化。
5. Backbone 排序能力不足：在确保 1–4 不存在后才考虑。


五、改动策略（Change Policy）
--------------------------
1. 最小改动原则
   - 每一轮只改动 1–2 个核心机制。
   - 其余组件保持不变以获得可归因性。

2. 先修“逻辑错误”，后调“超参数”
   - 如果存在损失方向、detach/梯度流向、推理路径未使用模块等逻辑问题，优先修复。
   - 超参数仅用于微调已正确的机制。

3. 先修“推理端”，后修“训练端”
   - 本任务目标是未见细胞系上的预测表现，推理端不正确则训练端优化无意义。


六、产出与命名规范（Artifacts）
----------------------------
- 所有思考与决策必须落在 `docx/` 的记录点体系中：
  - `docx/记录点n/记录点n反思.md`
  - `docx/记录点(n+1)/记录点(n+1)方案.md`
  - `docx/记录点(n+1)/记录点(n+1)结果.md`
  - `docx/历史索引.md`
- 所有运行输出必须可追溯：
  - `log/记录点(n+1)训练日志.log`
  - `log/记录点(n+1)预测结果.txt`


七、协作与分支策略（Git Policy）
------------------------------
- 代码提交后、训练开始前：必须执行 `git push origin plan15-C`，保证长耗时训练可追溯。


八、停止条件（Stop Conditions）
-----------------------------
- 达标停止：domain-kl/test 与各细胞系 AUPR ≥ 0.75。
- 转入稳定性验证：达标后只允许进行复现实验与小修复，不再做结构性大改。
