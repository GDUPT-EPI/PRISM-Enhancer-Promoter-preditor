# 背景
E/P互作预测任务中 enhancer和promoter互作受细胞系局限。为了能解决鲁棒性问题，准确识别一个从未见过的细胞系中的E/P对，因此有必要在backbone的旁路单独训练一个细胞系模块解耦共性和特性并指导E/P互作。

我的课题是仅基于序列预测E/P互作。backbone已被证实对训练过的有限细胞系是有效的(最终为每对E/P对赋值0或1)，我的backbone通过双编码器并行分别处理E/P，而旁路的解耦模块进行单独预训练，维护一个基于细胞系的上下文，每个细胞系构建一个1024维的EP对特征来提供上下文表示该细胞系的整体分布特征M_celltype，在实际训练时冻结旁路网络的参数后直接导入，将EP对的序列序列同时送入backbone和旁路后，查询EP对在对应细胞系上下文的分布特征M'得到该EP样本的特征矩阵M，将M参数化为FiLM，通过FiLM(FourierKAN(Feature_backbone))来影响输出

对于旁路网路的训练任务设计是基于对抗学习的，共性特征G应当使得判别器分辨不出这是哪个细胞系的(需要防止塌陷)，特性特征F应当使得判别器可以分辨出是哪个细胞系的


```数据格式
细胞系数据和0/1数据(是否互作)和序列数据，比如{HELA-S3,0, chr1 100-600(enhancer), chr1 1000-2000(promoter)}
这是一个纯序列数据集，没有任何活性监督信号。
```

# 预期
1. 预期输出一个包含三个特征维度的分布特征M[共性G, 特性F, EP互作关联度I]，其中共性应该保持跨细胞系保守。
2. 对于一个绝对陌生的细胞系，在推理脚本中仅通过少量步数对细胞系分布特性进行观测，即可微调得出准确的EP判断，而不是过拟合到某一细胞系，需要一些公平性分解保证
3. 对于分布特征M的准确定义：G代表该样本在跨细胞中的公共特征信息，F代表样本在该细胞系中的特有特征信息，EP代表该样本对于EP事件的整体关联程度
4. M的评估不是样本级或是任何严格对应的字符串级的，应该抽象到序列特征级的。比如说EP互作关联度，由于数据集id是基于严格的位点对应生成的，也许同一段基因序列会对应到多个样本，所以即使一个负样本其EP互作关联度也可以很高；再比方说同一段序列（可能存在轻微变异）在多个细胞系多个不同位点中重复出现，但是id不同，不能直接将它们视为全然不同的特征。



---

# 方案
这是一个针对E/P（Enhancer/Promoter）互作预测中**跨细胞系泛化（Domain Generalization）**与**解耦表征（Disentangled Representation）**的完整数学方案。

该方案的核心思想是将“序列本身包含的静态互作势能”与“细胞环境赋予的动态调控状态”在数学上进行正交分解，并通过元学习（Meta-learning）的思想处理未知细胞系的快速适应。

---

# 数学模型设计方案：基于解耦对抗与傅里叶神经算子（FourierKAN）的E/P互作预测

## 1. 符号定义与问题形式化

设 $\mathcal{X}$ 为序列空间，$\mathcal{C}$ 为细胞系空间，$\mathcal{Y} = \{0, 1\}$ 为互作标签。
数据集 $\mathcal{D} = \{(x_i^E, x_i^P, c_i, y_i)\}_{i=1}^N$，其中 $x^E, x^P \in \mathcal{X}$ 分别为Enhancer和Promoter序列，$c \in \mathcal{C}$ 为已知细胞系，$y$ 为互作标签。

我们的目标是学习两个函数：
1.  **旁路解耦映射（Bypass Decoupler）**：$\Phi_{bypass}: \mathcal{X} \times \mathcal{X} \to \mathbb{R}^{d_M}$，用于生成分布特征 $M$。
2.  **主干预测器（Backbone Predictor）**：$\Psi_{main}: \mathcal{X} \times \mathcal{X} \times \mathbb{R}^{d_M} \to [0, 1]$，结合序列和特征 $M$ 进行最终预测。

---

## 2. 旁路模块：三元特征解耦 (The Decoupling Module)

旁路模块的目标是生成特征矩阵 $M = [G, F, I]$。我们需要构建一个编码器 $E_{by}$，将输入的序列对 $x = (x^E, x^P)$ 映射到潜变量空间，并强制分解为三个子空间。

定义潜变量向量 $z = E_{by}(x)$，其中 $z \in \mathbb{R}^{1024}$。我们将 $z$ 切分为三个部分：
$$ z = [z_G \oplus z_F \oplus z_I] $$

*   $z_G$ (Global/Common): 跨细胞系的共性特征（如序列模体保守性）。
*   $z_F$ (Specific/Private): 当前细胞系的特异性特征（如特异性转录因子结合偏好）。
*   $z_I$ (Interaction): EP本身的序列兼容性/关联度（与环境无关的互作势能）。

### 2.1 对抗训练策略 (Adversarial Training Objective)

为了保证特征的语义纯度，我们引入以下损失函数进行约束：

**A. 特性鉴别损失 (Specificity Loss)**
为了确保 $z_F$ 包含细胞系身份信息，引入细胞系分类器 $D_{cls}$：
$$ \mathcal{L}_{spec} = -\mathbb{E}_{(x, c) \sim \mathcal{D}} \left[ \log P(c | D_{cls}(z_F)) \right] $$
*目的：让 $z_F$ 能够准确区分样本来自哪个细胞系。*

**B. 共性对抗损失 (Invariance Adversarial Loss)**
为了确保 $z_G$ **不包含**细胞系信息（防止过拟合到特定Domain），引入域判别器 $D_{adv}$，采用梯度反转层（GRL）或Minimax博弈：
$$ \mathcal{L}_{inv} = \min_{E_{by}} \max_{D_{adv}} \mathbb{E}_{(x, c) \sim \mathcal{D}} \left[ \log P(c | D_{adv}(z_G)) \right] $$
或者使用熵最大化：
$$ \mathcal{L}_{inv} = - H(D_{adv}(z_G)) $$
*目的：使得判别器无法通过 $z_G$ 猜测出细胞系，迫使 $z_G$ 学习序列的底层共性。*

**C. 互作关联预训练 (Interaction Potential Loss)**
虽然最终预测由Backbone完成，但旁路需要提取 $z_I$。我们可以假设存在某种“固有互作概率”。由于标签 $y$ 是环境依赖的，我们不能直接用 $z_I$ 预测 $y$。
我们采用**一致性约束**：同一对序列在不同细胞系中，$z_I$ 和 $z_G$ 应当是不变的，只有 $z_F$ 改变。
$$ \mathcal{L}_{consist} = \| z_G(x) - z_G(x') \|_2 + \| z_I(x) - z_I(x') \|_2 $$
其中 $x, x'$ 是同一序列对在不同细胞系中的实例（如果数据集中存在这种情况），或者通过数据增强（序列微扰）构造 $x'$。

**D. 正交性约束 (Orthogonality Constraint)**
为了防止特征纠缠，强制三个向量相互正交：
$$ \mathcal{L}_{orth} = \| z_G^T z_F \|_F^2 + \| z_G^T z_I \|_F^2 + \| z_F^T z_I \|_F^2 $$

### 2.2 旁路总损失
$$ \mathcal{L}_{bypass} = \lambda_1 \mathcal{L}_{spec} + \lambda_2 \mathcal{L}_{inv} + \lambda_3 \mathcal{L}_{orth} + \lambda_4 \mathcal{L}_{consist} $$

---

## 3. 细胞系上下文建模 (Cell-Type Context Modeling)

这是实现“对陌生细胞系鲁棒”的关键。我们不直接使用单个样本的 $z_F$，而是构建一个基于统计的上下文分布。

### 3.1 训练阶段的上下文构建
对于已知细胞系 $c$，我们维护一个**原型中心 (Prototype)** $\mu_c$ 和 **分布协方差** $\Sigma_c$：
$$ \mu_c = \mathbb{E}_{x \in \mathcal{D}_c} [z_F(x)] $$
$$ \Sigma_c = \mathbb{E}_{x \in \mathcal{D}_c} [(z_F(x) - \mu_c)(z_F(x) - \mu_c)^T] $$

对于输入样本 $x_i$，其分布特征矩阵 $M_i$ 由样本自身特征与其所属（或推断的）细胞系上下文共同定义：
$$ M_i = \text{MLP}_{context}([z_G^{(i)}, z_I^{(i)}, z_F^{(i)}, \mu_{c_i}]) $$
这里 $\mu_{c_i}$ 提供了该细胞系的全局“风格”或“环境偏好”。

---

## 4. 融合与预测：FiLM + FourierKAN

### 4.1 Backbone 特征提取
Backbone (双塔编码器) 提取序列的高维特征：
$$ H_{backbone} = \text{Encoder}_{backbone}(x^E, x^P) $$

### 4.2 FiLM 参数生成
将旁路生成的分布特征 $M_i$ 映射为 FiLM (Feature-wise Linear Modulation) 的缩放因子 $\gamma$ 和平移因子 $\beta$：
$$ \gamma = f_{\gamma}(M_i), \quad \beta = f_{\beta}(M_i) $$
其中 $f_\gamma, f_\beta$ 为全连接层。

### 4.3 FourierKAN 调制与输出
传统的KAN（Kolmogorov-Arnold Networks）使用样条函数，而FourierKAN使用傅里叶级数作为基函数，适合捕捉序列数据中的高频周期性模式（如DNA模体周期性）。

调制过程：
1.  **特征调制**：应用 FiLM 到 Backbone 特征：
    $$ \tilde{H} = \gamma \odot H_{backbone} + \beta $$
2.  **FourierKAN 处理**：
    $$ H_{out} = \text{FourierKAN}(\tilde{H}) = \sum_{k=1}^K \left( a_k \cos(k \omega \tilde{H}) + b_k \sin(k \omega \tilde{H}) \right) $$
3.  **最终预测**：
    $$ \hat{y} = \sigma(\text{Linear}(H_{out})) $$

在训练此阶段时，**冻结**旁路网络 $E_{by}$，仅训练 Backbone 和 FourierKAN 模块。

---

## 5. 推理阶段：未知细胞系的少样本自适应 (Few-Shot Inference)

面对一个全新的细胞系 $c_{new}$（没有标签，或者仅有少量观测数据），我们需要快速建立其上下文 $\mu_{c_{new}}$。

### 步骤 1：上下文观测 (Context Observation)
随机抽取该新细胞系的 $K$ 个样本（无监督序列数据）作为支持集 (Support Set) $\mathcal{S}_{new} = \{x_1, ..., x_K\}$。
将其输入冻结的旁路网络，计算特异性特征的均值：
$$ \hat{\mu}_{c_{new}} = \frac{1}{K} \sum_{j=1}^K z_F(x_j) $$
这个 $\hat{\mu}_{c_{new}}$ 即代表了新细胞系的**环境嵌入 (Environment Embedding)**。

### 步骤 2：公平性推断 (Robust Inference)
对于该细胞系的任意待预测样本 $x_{query}$：
1.  通过旁路得到 $z(x_{query}) = [z_G, z_F, z_I]$。
2.  构建特征矩阵 $M_{query} = \text{MLP}_{context}([z_G, z_I, z_F, \hat{\mu}_{c_{new}}])$。
    *   *注：这里引入 $\hat{\mu}_{c_{new}}$ 是为了校准 $z_F$ 的漂移，确保输入到 FiLM 的特征符合该细胞系的整体分布。*
3.  Backbone 提取特征，结合 $M_{query}$ 进行 FiLM + FourierKAN 预测。

---

## 6. 总结：该方案如何满足需求

1.  **三个特征维度 [G, F, I]**：通过对抗学习（G vs F）和一致性/正交约束（G/F vs I）实现了严格的数学解耦。
    *   $G$：通过 $D_{adv}$ 保证了跨细胞系保守。
    *   $F$：通过 $D_{cls}$ 保证了包含细胞系特有信息。
    *   $I$：作为序列内在属性被保留。
2.  **未知细胞系适应**：不依赖过拟合，而是通过计算新细胞系的统计量 $\hat{\mu}_{c_{new}}$（Steps for Context Observation）来动态调整 FiLM 参数。这是一种基于**原型网络 (Prototypical Network)** 的元学习思路。
3.  **抽象到特征级**：所有操作均在 Latent Space $z$ 中进行，而非字符串匹配。即使序列由轻微变异或ID不同，只要其在 Embedding 空间距离相近，其 $z_I$ 和 $z_G$ 就会相似。
4.  **鲁棒性与公平性**：FourierKAN 提供了强大的非线性拟合能力，而基于 $G$（共性）和 calibrated $F$（校准后的特性）的 FiLM 调制，确保了模型不是死记硬背某个细胞系的规则，而是理解了“在环境 $F$ 下，序列特征 $G$ 如何产生互作”。
