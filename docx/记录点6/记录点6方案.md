# CBAT 修复方案 (记录点6)：能量耗散系统与环境阻抗建模
# (Solution Point 6: Energy Dissipation System & Environmental Resistance Modeling)

## 1. 核心目标

修复记录点4/5中出现的“高置信度漂移”和“低 Precision”问题，同时保留其在 AUPR/AUC 上的优异表现（Ranking 能力）。
构建一个完整的**物理能量耗散系统**，而非简单的二分类器。

## 2. 数学模型修正

原模型：
$$ P(y=1) = \sigma(U_I) $$
其中 $U_I$ 是无界的物理内势。这导致了 Sigmoid 饱和。

新模型（能量耗散系统）：
$$ P(y=1) = \sigma\left( \frac{U_I(Seq) - R_E(Env)}{T} \right) $$

*   **$U_I(Seq)$**: 内在互作势能（Intrinsic Interaction Potential）。由 DNA 序列决定，代表物理化学层面的结合倾向。
    *   **特性**：细胞系无关（Invariant），通过对抗训练（GRL）保持纯净。
    *   **作用**：提供 Ranking 的基准（Base Score），决定 AUPR。

*   **$R_E(Env)$**: 环境阻抗（Environmental Resistance）。由细胞系特定的环境因子决定（如染色质闭合、抑制蛋白）。
    *   **特性**：细胞系特异（Specific），**非负值**（$R_E \ge 0$）。
    *   **作用**：作为“刹车”机制，抑制假阳性，提升 Precision。

*   **$T$**: 温度系数（Temperature）。
    *   **特性**：可学习参数，必须大于 0。
    *   **作用**：校准物理能量与概率空间的标度，防止 Sigmoid 饱和。

## 3. 具体实施步骤

### 3.1 模块一：内势生成器 ($U_I$) - 保持现状但增强

*   继续使用 `FourierEnergyKAN` 生成 $U_I$。
*   继续使用 GRL + Domain Discriminator 清洗 $U_I$ 中的细胞系信息。
*   **改进**：确保 $U_I$ 的输出不经过任何激活函数（保持为 Logits 形式），但在输入 Sigmoid 前必须除以 $T$。

### 3.2 模块二：环境阻抗生成器 ($R_E$) - 新增模块

我们需要一个专门的模块来预测当前细胞环境对该 EP 对的“阻力”。

*   **输入**：
    *   $z_I$（序列特征，即 `PRISMBackbone` 提取的特征）。
    *   **Cell Embedding**：我们需要为每个细胞系学习一个 Embedding $e_{cell}$。
*   **架构**：
    *   将 $z_I$ 和 $e_{cell}$ 融合（例如 concat 或 FiLM）。
    *   通过一个 MLP 或 KAN 输出标量 $R_E$。
    *   **关键约束**：$R_E$ 必须非负。使用 Softplus 激活函数：$R_E = \text{Softplus}(\text{Net}(z_I, e_{cell}))$。
*   **训练策略**：
    *   在训练时，随机采样细胞系 Embedding（模拟环境扰动）。
    *   或者使用 Manifold Mixup：$e_{mix} = \lambda e_A + (1-\lambda) e_B$。

### 3.3 模块三：温度校准 ($T$)

*   引入一个可学习的标量参数 `self.temperature`。
*   初始化为一个较大的值（例如 2.0 或 5.0），以防止初始阶段梯度消失或爆炸。
*   约束：$T = \text{Softplus}(\tau) + \epsilon$。

### 3.4 损失函数调整

除了二分类交叉熵损失，我们还需要约束 $U_I$ 和 $R_E$ 的行为：

1.  **稀疏阻抗损失 (Sparse Resistance Loss)**：
    我们希望环境阻抗 $R_E$ 是稀疏的，即大部分时候环境是不阻碍的，只有在特定抑制情况下才开启。
    $$ \mathcal{L}_{sparse} = \lambda_{sparse} \cdot \| R_E \|_1 $$

2.  **正交性损失 (Orthogonality Loss)**：
    确保 $U_I$ 和 $R_E$ 关注不同的特征。
    $$ \mathcal{L}_{orth} = \| \nabla U_I \cdot \nabla R_E \|_2 $$
    (可选，实现较复杂，暂不作为首选)

## 4. 代码变更计划

1.  **修改 `PRISMModel.py`**:
    *   在 `PRISMBackbone` 中添加 `self.cell_embedding` 层（如果尚未存在，或者利用现有的 cell label 输入）。
    *   添加 `ResistanceGenerator` 子模块（可以是简单的 MLP 或 KAN）。
    *   添加 `self.temperature` 参数。
    *   重写 `forward` 函数，实现 $logits = (U_I - R_E) / T$。
    *   修改 Loss 计算，加入稀疏阻抗正则化。

2.  **修改 `models/layers/attn.py`**:
    *   无需重大修改，继续使用记录点4的双向 CBAT 结构，因为它提供了高质量的 $z_I$。

3.  **验证策略**:
    *   重点观察 Precision 是否回升。
    *   观察置信度分布是否从两极（0/1）回归到合理的钟形或长尾分布。
    *   检查未见细胞系的 AUPR 是否保持稳定。

## 5. 预期效果

*   **鲁棒性**：由于 $U_I$ 是纯序列推断，未见细胞系的 Ranking 依然准确。
*   **特异性**：由于引入了 $R_E$，模型学会了在特定细胞环境下“闭嘴”（输出低分），从而减少假阳性，提升 Precision。
*   **校准**：温度系数 $T$ 将使输出概率更具有统计意义。
