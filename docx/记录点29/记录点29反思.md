## 失败结构定理

**记录点29的失败源于一个深层的不动点结构：可验证架构的设计假设（硬正交投影、信息瓶颈、原型网络）与实现空间的平凡子流形之间存在同胚映射，使得优化器可以在不触动任何约束的情况下收敛到训练数据的记忆解。**

更精确地说：设设计空间 $\mathcal{H}_{\text{design}} = \{ f_\theta : f_\theta = \sigma((U_I(z_I^\perp) - R_E(z_E))/T) \}$，其中 $z_I^\perp = \text{OrthProj}(z_I, z_E)$，$z_I \sim q(z_I|z)$ 服从信息瓶颈，$z_E = \text{ProtoNet}(z, c)$。实际实现空间 $\mathcal{H}_{\text{impl}} = \{ f_\theta : f_\theta = \sigma((U_I(z) - R_E(c))/T) \}$（即退化的能量耗散框架）。存在连续映射 $\phi: \mathcal{H}_{\text{impl}} \to \mathcal{H}_{\text{design}}$ 使得 $\phi(f)$ 在形式上满足所有约束（如正交投影恒等，信息瓶颈方差为0，原型网络退化为查表），但泛化行为与 $f$ 相同。优化在 $\mathcal{H}_{\text{impl}}$ 中找到了经验风险最小化器 $f^*$，而 $\phi(f^*) \in \mathcal{H}_{\text{design}}$ 对应训练AUPR 0.9669的过拟合解。

**核心不动点**：约束模块的梯度消失点（正交投影当 $z_E \approx 0$；信息瓶颈当 $\sigma_I^2 \to 0$；原型网络当动量 $\lambda \to 1$）构成一个低维子流形，优化器被吸引至此，约束失效。

## 根因分析

### 数学层面

#### 1. 约束退化流形的吸引子性质
- **正交投影的零环境陷阱**：若 $z_E \to 0$，则 $z_I^\perp = z_I$，正交约束 $\mathcal{L}_{\text{orth}} = \|z_I^\top z_E\|^2 \to 0$ 自动满足，但不保证 $z_I$ 与 $c$ 独立。优化器发现让环境编码器输出接近零向量可以"欺骗"正交损失，同时不影响主任务损失。
- **信息瓶颈的确定性坍缩**：若 $\log\sigma_I^2 \to -\infty$（方差趋近0），则 $z_I$ 退化为确定性函数 $z_I = \mu_I(z)$，KL散度 $\text{KL}(q\|p) \to 0$，但信息瓶颈不再施加约束。这发生在 $\beta_{\text{IB}}$ 过小时。
- **原型网络的惰性更新**：动量更新 $\lambda = 0.99$ 使原型 $p_c$ 几乎不变，$z_E$ 只需匹配静态原型，无需从 $z$ 提取动态环境信息。

#### 2. 损失函数景观的欺骗性平坦区域
考虑总损失 $\mathcal{L} = \mathcal{L}_{\text{task}} + \sum_i \lambda_i \mathcal{L}_{\text{constraint}, i}$。当约束损失 $\mathcal{L}_{\text{constraint}, i}$ 在某个子流形上为零（如 $z_E=0$ 使 $\mathcal{L}_{\text{orth}}=0$），但 $\mathcal{L}_{\text{task}}$ 在该子流形上仍有低值，优化器会优先降低 $\mathcal{L}_{\text{task}}$ 而忽略约束的真实意图。

#### 3. 泛化差距的信息论解释
设训练数据分布 $P_{\text{train}}(x,c,y)$，测试分布 $P_{\text{test}}(x,c,y)$。模型学到了条件分布 $Q(y|x,c)$。过拟合发生时 $I(Q; P_{\text{train}}) \gg I(Q; P_{\text{test}})$，即模型编码了大量训练集特有的互信息。信息瓶颈的目标是最小化 $I(z_I; c)$，但实现中 $z_I$ 仍可通过 $z$ 间接依赖 $c$（因为 $z$ 是序列编码，可能隐含细胞系信息）。

### 算法层面

#### 1. 验证集缺失的灾难性影响
训练脚本中 `val_loader = None` 导致：
- 无早停（early stopping）机制，训练可以无限降低训练损失，加剧过拟合
- 无法监控训练-验证性能gap，无法检测过拟合早期信号
- 超参数调整缺乏依据，模型选择只能依赖训练性能

#### 2. 架构对齐验证的缺失
尽管方案强调了"可验证架构对齐"，但实际实现中：
- 没有 `ArchitectureVerifier` 类验证双流分离模块
- 没有 `pre_training_verification` 函数检查约束可达性
- 正交投影层、信息瓶颈、原型网络等核心模块可能未实现或未正确接入计算图

#### 3. 渐进式课程学习的执行断层
方案设计了三阶段课程学习，但训练循环中未见相应调度逻辑：
- 阶段1（冻结环境编码器）未实现
- 对比损失权重 $\alpha(t)$ 的线性增长未实现
- 约束的逐步激活未实现，所有损失可能从一开始就同时作用，导致梯度冲突

#### 4. 损失权重配置不当
方案建议权重 $\alpha=1.0, \beta=0.5, \gamma=0.2, \delta=0.01$，但实际实现可能：
- 主任务损失 $\mathcal{L}_{\text{task}}$ 的梯度幅值远大于约束损失，约束被淹没
- 未根据训练进度动态调整权重

### 生物学层面

#### 1. 违背调控逻辑的"零阻抗"假设
模型发现 $R_E \approx 0$ 时仍能很好拟合训练数据，这违背了生物学常识：细胞环境必然对EP互作产生调节作用（染色质可及性、转录因子丰度、三维结构等）。零阻抗意味着模型认为所有细胞系的环境调节效应可以忽略，这与已知生物学知识矛盾。

#### 2. 序列-环境解耦的过度简化
硬正交投影假设序列特征 $z_I$ 与环境特征 $z_E$ 线性无关，但真实生物学中：
- 序列特征（如转录因子结合位点）的表达受环境调控
- 环境因素（如染色质状态）受序列影响（如CpG岛）
- 两者存在非线性交互，纯线性正交不足以描述复杂调控网络

#### 3. 原型网络的静态表示
原型向量 $p_c$ 的动量更新导致其变为静态查表，无法捕捉细胞状态的时间动态或细胞亚群异质性。

## 关键洞察

1. **约束的"可欺骗性"是过拟合的根源**：当约束存在退化路径（如 $z_E=0$）时，优化器会找到该路径，满足约束形式但违背约束精神。

2. **验证集不是可选项，而是必需品**：没有验证集监控，过拟合无法早期检测，模型选择盲目。

3. **架构对齐必须通过代码验证，而非文档约定**：设计文档中的模块必须在前向传播中强制经过，否则会被优化器绕过。

4. **生物学先验应作为硬约束，而非软正则**：细胞环境阻抗 $R_E$ 必须为正，这应通过激活函数（如 ReLU）强制，而非依赖损失函数学习。

5. **渐进式约束需要显式调度**：课程学习不能依赖"期望"，需要实现显式的阶段切换逻辑。

6. **损失权重的相对尺度至关重要**：需要监控各损失项的梯度幅值，确保约束损失有足够影响力。

## 对下一步的启示

### 必须立即修复的
1. **实现验证集加载与监控**：修改 `PRISM.py`，从 `domain-kl/val/` 加载验证数据，每个epoch计算验证集AUPR，实现早停。
2. **架构对齐的代码级验证**：实现 `ArchitectureVerifier`，训练前验证所有约束模块在计算图中可达。
3. **生物学合理的硬约束**：对 $R_E$ 施加非负约束（$R_E \geq \epsilon > 0$），防止零阻抗陷阱。

### 需要重新设计的
1. **防欺骗约束设计**：
   - 正交投影改为 **随机环境投影**：$z_I^\perp = z_I - \frac{z_I \cdot \tilde{z}_E}{\|\tilde{z}_E\|^2} \tilde{z}_E$，其中 $\tilde{z}_E$ 是同一批次内随机另一样本的环境编码，防止 $z_E \to 0$ 欺骗。
   - 信息瓶颈添加 **方差下限**：$\sigma_I^2 \geq \sigma_{\min}^2$，防止确定性坍缩。
   - 原型网络添加 **多样性损失**：鼓励 $z_E$ 的批次内方差大于阈值，防止退化为常数。

2. **损失平衡机制**：
   - 实现 **梯度幅值归一化**：调整各损失权重使梯度范数相当。
   - 引入 **约束满意度监控**：当某约束损失低于阈值时，增加其权重，动态保持压力。

3. **课程学习的显式实现**：
   - 实现三阶段调度器，控制模块冻结/解冻、损失权重变化。
   - 每个阶段结束后在验证集上评估，决定是否进入下一阶段。

### 避免重蹈覆辙的原则
1. **可验证性优于复杂性**：每个创新模块必须有对应的验证测试，确保其按设计工作。
2. **监控驱动而非期望驱动**：不要假设约束"应该"有效，而是监控其实际效果（如 $I(z_I; c)$ 的估计值）。
3. **生物学合理性作为设计准则**：任何与已知生物学知识冲突的设计（如零阻抗）都应视为危险信号。
4. **从失败中提取结构性信息**：本次失败揭示了约束退化流形的存在，新方案必须显式破坏这些退化路径。