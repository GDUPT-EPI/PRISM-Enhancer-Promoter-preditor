# CBAT 终极方案 (记录点4)：正交解耦与能量耗散架构
# (The Ultimate Solution: Orthogonal Decoupling & Energy Dissipation Architecture)

## 1. 痛定思痛：拒绝“比烂”，追求“怪物”

### 1.1 为什么拒绝“回退机制”？
之前的方案提议在“环境流不确定时回退到 Backbone”，这本质上是一种工程上的妥协（Engineering Patch）。
-   **数学上的不洁**：它承认了模型无法在 OOD（Out-of-Distribution）上学到正确的环境规律，所以才需要“逃生通道”。
-   **鲁棒性的伪命题**：如果一个模型需要回退才能保证不掉分，说明它并没有真正理解数据生成的物理机制。
-   **我们的目标**：构建一个在未见细胞系上依然**强力**的模型（Robustness Monster），而不是一个“不比 Baseline 差”的平庸模型。

### 1.2 重拾废案的“巧思”
`解耦对抗算子.md` 中的 [G, F, I] 解耦思想极具价值，之前的失败（AUC 60）并非思路错误，而是**数学约束不足**：
1.  **$I$ (Interaction) 不纯**：$I$ 混入了环境信息，导致过拟合。
2.  **融合方式太软**：FiLM + MLP 的组合能力太强，模型直接“死记硬背”了 Context 和 Label 的关系，而忽略了 $I$。

---

## 2. 核心数学模型：能量耗散系统 (Energy Dissipation System)

我们将 EP 互作建模为一个物理过程：**信号传输与介质阻抗**。

### 2.1 物理直觉
$$ \text{Observed Interaction} = \text{Intrinsic Potential} - \text{Environmental Resistance} $$

-   **内势 (Intrinsic Potential, $U_I$)**：由 DNA 序列的物理化学性质（Motif 匹配、立体结构）决定。它是**宇宙常数**，不随细胞系变化。
-   **环境阻抗 (Environmental Resistance, $R_E$)**：由染色质状态、核小体占据、抑制性蛋白决定。它是**环境特异**的。

**判别准则**：
$$ y = \mathbb{I}(U_I(E, P) > R_E(E, P, \text{Cell})) $$
或者概率形式（Boltzmann 分布）：
$$ P(y=1) = \sigma\left( \frac{U_I - R_E}{T} \right) $$

**为什么这能成为“鲁棒性怪物”？**
-   在未见细胞系上，**$U_I$ 是绝对不变的**（因为它是序列的函数）。
-   我们只需要估计 $R_E$。即使 $R_E$ 估计有偏差，由于 $U_I$ 的排序性质不变，模型的 AUPR (Ranking) 依然由 $U_I$ 主导，**无需任何人工回退逻辑，模型天然具备鲁棒性**。

---

## 3. 架构设计：正交解耦对抗算子 (Orthogonal Decoupled Adversarial Operator)

### 3.1 模块一：绝对不变量生成器 (Invariant Generator) - $U_I$
这是 Backbone 的角色，但我们需要对其进行**对抗清洗**。

-   **输入**：$E, P$ 序列。
-   **输出**：互作势能 $z_I \in \mathbb{R}^d$。
-   **清洗手段（Adversarial Cleaning）**：
    -   引入一个**域判别器 (Domain Discriminator)** $D_{adv}(z_I)$。
    -   使用 **GRL (Gradient Reversal Layer)**。
    -   **目标**：最大化 $D_{adv}$ 的 Loss。
    -   **数学含义**：强迫 $z_I$ **剔除所有与细胞系相关的信息**。$z_I$ 只能包含纯粹的序列互作逻辑。

### 3.2 模块二：环境阻抗场 (Environmental Resistance Field) - $R_E$
这是 Bypass 的角色，基于“废案”中的 FootprintExpert 和 GraphContext。

-   **输入**：$E, P$ 序列 + 细胞系原型 $\mu_{cell}$。
-   **输出**：阻抗特征 $z_F \in \mathbb{R}^d$。
-   **流形约束 (Manifold Constraint)**：
    -   为了防止过拟合，我们对 $z_F$ 进行 **Manifold Mixup**。
    -   训练时，随机插值两个细胞系的上下文：$\tilde{\mu} = \lambda \mu_A + (1-\lambda) \mu_B$。
    -   强迫模型学习连续的阻抗变化，而不是死记硬背离散的细胞 ID。

### 3.3 模块三：傅里叶能量算子 (Fourier Energy Operator)
废案中的 FourierKAN 是个好东西，但用法要改。我们用它来计算“势能差”。

$$ \text{Logit} = \text{FourierKAN}_{inter}(z_I) \ominus \text{FourierKAN}_{env}(z_F) $$

这里 $\ominus$ 不是简单的减法，而是一种**非线性抑制**：
$$ \text{Score} = \text{FourierKAN}_{inter}(z_I) \cdot \sigma(\text{Gate}(z_F)) $$
或者更符合物理的：
$$ \text{Score} = \text{FourierKAN}(z_I) - \text{Softplus}(\text{FourierKAN}(z_F)) $$

**解释**：
-   $z_I$ 提供正向驱动力。
-   $z_F$ 提供非负的阻力（Softplus 保证非负）。
-   如果环境极其抑制（$z_F$ 很大），Score 被压低。
-   如果环境开放（$z_F \approx 0$），Score 完全由 $z_I$ 决定。

---

## 4. 训练策略：高价值的数学约束

为了训练这个“怪物”，我们需要特殊的 Loss 组合：

### 4.1 正交性损失 (Orthogonality Loss)
$$ \mathcal{L}_{orth} = \| z_I^T \cdot z_F \|_F^2 $$
强迫“内势”和“阻抗”在特征空间正交。序列归序列，环境归环境，互不干涉。

### 4.2 因果一致性损失 (Causal Consistency Loss)
利用**反事实推理 (Counterfactual Reasoning)** 构造样本。
-   取一对正样本 $(E, P, C_1, y=1)$。
-   保持 $E, P$ 不变，换成一个抑制性环境 $C_2$（已知该位置关闭）。
-   模型必须输出 $y=0$。
-   由于 $E, P$ 没变，**$z_I$ 必须完全不变**。
-   模型必须完全依靠 $z_F$ 的变化来翻转预测。
-   **这迫使 $z_F$ 承担所有的环境变化责任，保护了 $z_I$ 的纯度。**

### 4.3 熵最小化与原型校准 (Entropy Minimization & Prototype Calibration)
在未见细胞系推理时：
1.  **原型合成**：不直接使用单个样本的 $z_F$，而是计算该细胞系所有样本 $z_F$ 的均值 $\bar{\mu}_{new}$。
2.  **测试时微调 (TTA)**：冻结 $z_I$ 及其 FourierKAN，仅微调 $z_F$ 的生成器，使得预测熵 $H(\hat{y})$ 最小化。
    -   **直觉**：物理世界是确定的（要么结合，要么不结合）。如果模型在未见细胞系上犹豫不决（预测 0.5），说明 $z_F$ 没对齐。微调 $z_F$ 直到预测变得果断（0 或 1）。

---

## 5. 总结：为什么这是“怪物”？

这个架构（**正交解耦对抗算子**）不再依赖“回退”或“平均”。
1.  **它拥有一个纯粹的灵魂 ($z_I$)**：通过对抗训练和正交约束，Backbone 被炼化成了一个**通用的序列互作物理引擎**。在任何细胞系，它都能精准计算出 $U_I$。
2.  **它拥有一件可变的衣服 ($z_F$)**：环境只是外在的阻尼。在未见细胞系上，我们只需要“试穿”这件衣服（通过原型估计或 TTA），一旦衣服合身，模型的性能将直接继承自强大的 $z_I$。
3.  **数学保证**：$y = U_I - R_E$ 的形式保证了，只要 $R_E$ 的估计不是极度离谱的反向，AUPR (Ranking) 就主要由 $U_I$ 决定。这才是真正的、内生的鲁棒性。

**下一步行动**：
无需重写所有代码。
1.  在 `AuxiliaryModel` 中引入 GRL 和正交 Loss。
2.  将融合层改为能量减法形式。
3.  引入反事实数据增强（在 Batch 内构造）。
