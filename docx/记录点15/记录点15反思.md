## 失败结构定理

**变分贝叶斯环境阻抗学习框架未能解决过拟合问题，因为：**
1. **KL散度正则化失效**：先验分布 $p(z_E|c)$ 本身通过超网络从训练细胞系学习，导致先验与后验同时过拟合，KL惩罚项 $\text{KL}(q(z_E|x,c) \parallel p(z_E|c))$ 变得微不足道。
2. **任务形式化错位**：训练时优化 $\mathbb{E}_{q(z_E|x,c)}[\log p(y|x,z_E)]$，但测试时对未知细胞系的少样本更新缺乏标签信息 $y$，导致 $p(y|x,z_E)$ 似然无法计算，贝叶斯更新退化为特征匹配。
3. **内势泄露**：尽管有对抗训练，内势 $U_I$ 仍可能携带细胞系特异性信息，破坏了 $U_I$（序列固有亲和力）与 $z_E$（环境阻抗）的理论解耦。

数学上，训练目标为：
$$
\mathcal{L} = \mathbb{E}_{q(z_E|x,c)}[\log p(y|x,z_E)] - \beta \text{KL}(q \parallel p) + \lambda \|\|z_E\|\|_1
$$
当 $p(z_E|c)$ 过拟合训练集时，$q$ 与 $p$ 的KL散度变小，正则化效果减弱。同时，对抗损失 $\mathcal{L}_{\text{inv}}$ 未能完全消除 $U_I$ 中的细胞系信息，导致模型通过 $U_I$ 捷径记忆训练集。

## 根因分析

### 数学层面

#### 1. 先验-后验共谋 (Prior-Posterior Collusion)
- **现象**：先验分布 $p(z_E|c)$ 由超网络从细胞系ID生成，后验 $q(z_E|x,c)$ 从序列特征生成。当两者都过拟合时，$q$ 可以轻易匹配 $p$，KL散度趋近于0。
- **后果**：变分框架退化为普通条件生成模型，失去正则化能力。
- **数学证据**：训练集AUPR 0.9699接近完美，测试集AUPR 0.6962，泛化gap达0.2737，表明几乎没有正则化约束。

#### 2. 贝叶斯更新无效性 (Ineffective Bayesian Update)
- **理论缺陷**：对未知细胞系 $c_{\text{new}}$，贝叶斯更新公式为：
  $$
  p(z_E | D_{\text{new}}) \propto p(z_E) \prod_{i=1}^M p(x_i | z_E)
  $$
  但 $p(x_i | z_E)$ 无法直接计算，实践中用编码器 $q(z_E|x_i, c_{\text{unknown}})$ 近似。然而，$q$ 的参数 $\phi$ 是在已知细胞系上训练的，对新分布 $c_{\text{new}}$ 存在域偏移。
- **实际表现**：NHEK细胞系阈值仅0.4600（其他~0.9），Recall 0.9873，几乎全预测为阳性，表明阻抗 $z_E$ 估计失败。

#### 3. 信息解耦不彻底 (Incomplete Information Disentanglement)
- **互信息分析**：理想情况下，$I(U_I; C) = 0$（内势与细胞系独立），$I(z_E; C) > 0$（阻抗依赖细胞系）。但对抗训练可能不足，导致 $I(U_I; C) > 0$。
- **后果**：$U_I$ 携带细胞系信息，模型可以通过调整 $U_I$ 而非 $z_E$ 来拟合训练集，破坏理论框架。

### 算法层面

#### 1. 超网络过拟合 (Hypernetwork Overfitting)
- `PriorHyperNet` 将细胞系ID映射为先验参数 $(\mu_c, \sigma_c)$。当训练细胞系数量有限时，网络容易记忆每个ID对应的最优参数，而非学习连续的细胞系流形。

#### 2. 阻抗编码器容量过大 (Encoder Overcapacity)
- `ImpedanceEncoder` 为MLP，输入特征维度 $D=1024$（OUT_CHANNELS），可能具有足够容量将序列特征编码为任意阻抗值，绕过先验约束。

#### 3. 损失权重失衡 (Loss Weight Imbalance)
- $\beta=1.0$, $\lambda_{\text{sparse}}=0.01$, $\lambda_{\text{inv}}=1.0$。KL散度权重相对重构损失可能太小，稀疏正则太弱。
- 训练日志显示Total Loss从正变负（0.88 → -3.47），表明重构损失主导，KL惩罚不足。

#### 4. 未知细胞系处理机制脆弱 (Fragile Unknown-Cell Mechanism)
- 使用固定的 `unknown_cell_embedding` 参数，缺乏对未知细胞系多样性的建模。
- 少样本更新仅基于特征均值，未考虑分布形状。

### 生物学层面

#### 1. 阻抗稀疏性假设过强 (Overstrong Sparsity Assumption)
- L1正则鼓励 $z_E$ 稀疏，假设"多数染色质环境允许互作"。但实际中，细胞系间差异可能是系统性的（全局压缩状态），而非局部稀疏抑制。

#### 2. 内势不变性违反生物学事实 (Violation of Biological Reality)
- 假设序列固有亲和力 $U_I$ 完全与细胞系无关，但实际结合自由能受表观遗传修饰影响，这些修饰具有细胞特异性。

#### 3. 能量耗散模型过度简化 (Overly Simplified Energy Dissipation)
- $P(y=1) = \sigma((U_I - z_E)/T)$ 假设阻抗是加性、标量、独立的。真实染色质环境可能通过更复杂的非线性机制调节互作。

## 关键洞察

### 1. 变分框架的双刃剑
- **优点**：提供原则性的不确定性量化框架，统一已知与未知细胞系处理。
- **陷阱**：当先验也过拟合时，KL正则失效；需要更强的先验约束（如分层先验、经验贝叶斯）。

### 2. 过拟合的本质是模型自由度过剩
- 模型有多个路径记忆训练集：$U_I$、$z_E$、先验超网络。需要更强的归纳偏置限制自由度。

### 3. 测试时适应的信息瓶颈
- 对未知细胞系，仅有序列特征 $x$ 无标签 $y$，无法进行监督式贝叶斯更新。需要半监督或自监督适应机制。

### 4. 细胞系流形的连续性假设
- 当前将细胞系视为离散ID，忽略了它们在高维特征空间的连续关系。应建模细胞系流形，使相似细胞系具有相似先验。

## 对下一步的启示

### 1. 强化先验约束
- 采用**分层先验**：$p(z_E|c) = \int p(z_E|\theta) p(\theta|c) d\theta$，其中 $\theta$ 为超参数，在细胞系间共享统计强度。
- 或使用**经验贝叶斯**：从所有细胞系数据估计全局先验 $p(z_E)$，再对每个细胞系进行经验贝叶斯调整。

### 2. 改进解耦机制
- 采用**信息瓶颈**：最小化 $I(z_I; C)$ 同时最大化 $I(z_I; Y)$，迫使 $z_I$（特征表示）丢弃细胞系信息但保留互作信息。
- **对抗解耦**：对 $U_I$ 和 $z_E$ 分别进行对抗训练，确保 $U_I \perp C$ 而 $z_E \not\perp C$。

### 3. 流形对齐替代离散ID
- 构建**细胞系原型图**：基于基因表达、染色质可及性等先验知识，定义细胞系相似性，作为超网络的辅助输入。
- 使用**对比学习**：拉近相似细胞系的表示，推远不相似细胞系，学习连续细胞系流形。

### 4. 自监督测试时适应
- 对未知细胞系，利用**伪标签**或**一致性正则**进行无监督/自监督适应，避免纯特征匹配的脆弱性。

### 5. 物理引导的归纳偏置
- 引入基于生物物理的约束，如**能量守恒**（$U_I$ 与 $z_E$ 的统计关系）、**阻抗非负性**（已实现）、**温度自适应**等。

### 6. 简化与聚焦
- 减少可学习模块，增加不可学习的归纳偏置。例如，用**高斯过程**先验替代超网络，用**核方法**建模细胞系相似性。

---

**核心教训**：变分贝叶斯不是银弹。当先验本身可学习且数据有限时，需要更强的层次结构或不可学习的先验知识来约束过拟合。下一步应**降低模型自由度，增加先验知识，强化解耦，并设计更稳健的测试时适应机制**。