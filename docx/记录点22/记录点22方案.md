## 核心洞察（一句话）

**通过对比学习强制序列特征与环境特征在表示空间正交，并利用原型网络实现细胞系内聚类与细胞系间分离，从而获得真正解耦的 U_I 与 R_E。**

## 问题的数学形式化

### 输入与输出空间
- 输入样本：\( x = (E, P) \) DNA序列对，来自细胞系环境 \( c \in \mathcal{C} \)。
- 标签：\( y \in \{0,1\} \) 表示互作与否。
- 目标：学习条件概率 \( P(y|x, c) \)。

### 假设空间
模型由以下组件构成：
1. **序列编码器** \( f_\theta: \mathcal{X} \to \mathbb{R}^d \) 提取序列特征 \( z = f_\theta(x) \)。
2. **内势预测器** \( g: \mathbb{R}^d \to \mathbb{R} \) 输出 \( U_I = g(z) \)。
3. **环境编码器** \( h_\phi: \mathcal{C} \to \mathbb{R}^k \) 将细胞系环境映射为环境特征 \( e = h_\phi(c) \)。对于未知细胞系，\( e \) 由其支持集样本的序列特征聚合得到。
4. **阻抗预测器** \( r: \mathbb{R}^k \to \mathbb{R} \) 输出 \( R_E = r(e) \)（非负）。
5. **温度** \( T > 0 \)（固定或可学习带正则）。

预测公式保持能量耗散形式：
\[
P(y=1|x, c) = \sigma\left( \frac{U_I(x) - R_E(c)}{T} \right)
\]

### 关键约束
- **解耦性**：序列特征 \( z \) 应与环境特征 \( e \) 无关，即 \( I(z; e) \to 0 \)。
- **环境一致性**：同一细胞系的样本应有相似的 \( e \)。
- **序列不变性**：同一细胞系内，正负样本的 \( z \) 分布应尽可能分离，而不同细胞系间相同标签的 \( z \) 分布应保持对齐。

## 解决方案

### 数学描述

#### 1. 对比解耦损失（Contrastive Decoupling Loss）
对于批次中的样本对 \( (x_i, c_i) \) 和 \( (x_j, c_j) \)，定义：
- **正对**：\( c_i = c_j \)（同一细胞系）。
- **负对**：\( c_i \neq c_j \)（不同细胞系）。

使用归一化序列特征 \( \tilde{z} = \frac{z}{\|z\|_2} \)，计算 InfoNCE 损失：
\[
\mathcal{L}_{\text{cont}} = -\frac{1}{N} \sum_{i=1}^N \log \frac{\sum_{j \neq i} \mathbb{1}_{c_i = c_j} \exp(\tilde{z}_i^\top \tilde{z}_j / \tau)}{\sum_{j \neq i} \exp(\tilde{z}_i^\top \tilde{z}_j / \tau)}
\]
其中 \( \tau \) 为温度超参数。该损失鼓励同一细胞系的序列特征在单位球面上聚集，不同细胞系的特征分散。

#### 2. 原型网络环境估计（Prototypical Environment Estimation）
为每个细胞系 \( c \) 维护一个原型向量 \( p_c \in \mathbb{R}^k \)，初始化为该细胞系支持集样本的环境特征均值。环境编码器 \( h_\phi \) 将支持集样本的序列特征映射为环境特征：
\[
e_c = h_\phi(\{z^{(c)}_1, \dots, z^{(c)}_m\}) \quad \text{(例如：均值池化)}
\]
然后通过最小化 \( \|e_c - p_c\|^2 \) 更新 \( h_\phi \)，同时以动量方式更新原型：
\[
p_c \gets \lambda p_c + (1-\lambda) e_c
\]
对于未知细胞系，使用其支持集样本计算 \( e_{c'} \)，并以此作为环境特征。

#### 3. 正交损失（Orthogonality Loss）
强制序列特征与环境特征在表示空间正交：
\[
\mathcal{L}_{\text{orth}} = \left\| \frac{z}{\|z\|_2}^\top \frac{e}{\|e\|_2} \right\|^2
\]

#### 4. 能量耗散主任务损失
使用 AdaptiveIMMAXLoss 计算预测概率与真实标签的差异：
\[
\mathcal{L}_{\text{task}} = \text{IMMAX}\left( \sigma\left( \frac{U_I - R_E}{T} \right), y \right)
\]

#### 5. 总损失
\[
\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}} + \alpha \mathcal{L}_{\text{cont}} + \beta \mathcal{L}_{\text{orth}} + \gamma \mathcal{L}_{\text{proto}}
\]
其中 \( \mathcal{L}_{\text{proto}} = \|e_c - p_c\|^2 \)，系数 \( \alpha, \beta, \gamma \) 控制各约束强度。

### 核心机制

#### 为何对比损失能促进解耦？
对比损失直接作用于序列特征 \( z \)，使其对细胞系标签敏感。这似乎与“环境不变性”矛盾，但关键在于：我们强制 **同一细胞系内** 的序列特征相似，不同细胞系间特征分离。这实际上在序列特征空间中建立了一个与细胞系相关的结构，但环境信息被“推入”了环境特征 \( e \)。由于总预测由 \( U_I - R_E \) 决定，模型必须将细胞系特异性信息分配到 \( R_E \) 中，否则无法同时满足对比损失和任务损失。这形成了自然的博弈，促使解耦。

#### 原型网络的作用
原型网络提供了细胞系环境的低维摘要，使得环境编码器可以专注于学习从序列特征到环境特征的映射，而不必记忆每个细胞系。动量更新保证了原型的稳定性，避免振荡。

#### 温度的角色
温度 \( T \) 控制能量差的灵敏度。我们建议将 \( T \) 固定为 1.0（或可学习但施加 L2 正则防止趋近于 0），以避免概率饱和。

### 物理/生物对应

1. **对比学习 → 进化保守性**：同一细胞系内序列特征的聚集对应了该细胞系特异的转录因子组合偏好；不同细胞系间的分离反映了细胞类型间的调控差异。这与进化上保守的序列模块和细胞类型特异性调控模块的划分相符。

2. **原型网络 → 细胞类型身份**：原型向量可视为细胞类型的“身份编码”，类似于染色质状态图谱或组蛋白修饰谱的摘要。环境编码器学习从序列特征推断细胞类型身份，阻抗 \( R_E \) 则反映了该细胞类型对互作的普遍抑制强度。

3. **能量耗散 → 热力学调控**：公式 \( U_I - R_E \) 直接类比于化学反应中的自由能变（ΔG = ΔH - TΔS）。序列亲和力提供焓变（ΔH），环境阻抗提供熵罚（-TΔS）。温度 T 对应系统的热波动水平。

## 实施路线图

### 第一阶段：架构修改
1. 在 `PRISMModel.py` 中增加对比学习模块，计算批次内样本对的相似度。
2. 实现原型网络，为每个细胞系维护原型向量（可在 `forward` 中动态更新）。
3. 添加环境编码器 \( h_\phi \)（轻量 MLP），输入为支持集序列特征的池化向量。
4. 固定温度 \( T = 1.0 \) 或添加正则项。

### 第二阶段：训练流程调整
1. 采用 `CellBatchSampler` 确保每个批次仅包含一个细胞系的样本（支持集与查询集可同批）。
2. 在训练循环中计算对比损失、正交损失、原型损失。
3. 实施课程学习：前 2 个 epoch 只训练序列编码器和内势预测器（冻结环境编码器，设 \( R_E=0 \)），后续 epoch 联合训练。

### 第三阶段：推理适配
1. 预测时，对每个细胞系先抽取支持集（可随机选择该细胞系的一部分样本）计算环境特征 \( e_c \)。
2. 使用 \( e_c \) 得到 \( R_E \)，然后对所有样本应用能量公式。
3. 无需动态切换分支，保持流程统一。

## 预期行为与验证

### 训练指标监控
- 对比损失应稳步下降，表明序列特征在同一细胞系内聚合。
- 正交损失应接近零。
- 训练集 AUPR 应稳步上升，但不超过 0.90（防止过拟合）。
- 验证集（留出部分细胞系）AUPR 应与训练集同步上升。

### 测试期望
- 在 domain-kl/test 上，AUPR 应超过记录点4（0.71–0.72），目标 0.75+。
- 未知细胞系的 Recall 与 Precision 应平衡，避免极端坍塌。

## 失败边界与应对

### 可能失败模式
1. 对比损失与任务损失冲突，导致训练不稳定 → 调整权重 \( \alpha \) 或使用梯度裁剪。
2. 原型网络未能捕捉细胞系多样性 → 增加原型维度或使用多个原型 per cell。
3. 过拟合依然严重 → 增加 Dropout 或权重衰减。

### 退路方案
若对比学习引入过多噪声，可退化为简单的“细胞系内均值归一化”：对每个细胞系的序列特征进行标准化（减去均值，除以标准差），迫使序列特征分布对齐，环境信息由均值承载。

---

**记录点22的核心创新在于将解耦问题从损失设计转向表示几何设计，通过对比学习与原型网络的协同，为能量耗散系统提供一个稳定、可解释的数学基础。**