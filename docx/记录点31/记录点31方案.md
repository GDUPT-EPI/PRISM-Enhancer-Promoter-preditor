## 核心洞察（一句话）

**细胞系特异性不是从序列亲和力中减去一个常数阻抗，而是以乘法方式调制亲和力函数的形状与尺度；真正的解耦需要从可加框架转向条件调制框架，并通过信息瓶颈与交换不变性实现架构级硬约束。**

## 问题的数学形式化

### 输入与输出空间
- 输入样本：$x = (E, P) \in \mathcal{X}$ DNA序列对，来自细胞系环境 $c \in \mathcal{C}$
- 标签：$y \in \{0,1\}$ 表示互作与否
- 目标：学习条件概率 $P(y|x, c)$，使其在训练分布 $P_{\text{train}}(c)$ 和测试分布 $P_{\text{test}}(c)$ 上都能保持良好排序能力

### 历史框架的局限性分析
现有能量耗散框架：
$$
P_{\text{add}}(y=1|x,c) = \sigma\left( \frac{U_I(z_I) - R_E(z_E)}{T} \right)
$$
存在三个根本问题：

1. **平移对称性**：变换 $(U_I, R_E) \to (U_I + \delta, R_E + \delta)$ 不改变概率排序，导致 $(U_I, R_E)$ 不可识别
2. **线性分离假设**：假设 $z_I$ 与 $z_E$ 线性无关，但真实表示可能通过非线性关联
3. **调制形式错误**：生物学中，细胞系特异性常表现为结合亲和力的**形状调制**（如合作性系数变化），而非简单平移

### 条件调制框架
提出新的预测公式：
$$
P_{\text{mod}}(y=1|x,c) = \sigma\left( \frac{M(c) \cdot U_I(z_I) + B(c)}{T(c)} \right)
$$
其中：
- $M(c) \in \mathbb{R}^+$：**调制因子**，缩放亲和力强度
- $B(c) \in \mathbb{R}$：**基线偏移**，反映基础抑制水平
- $T(c) \in \mathbb{R}^+$：**细胞系特异性温度**，控制决策边界锐度
- $U_I(z_I)$：**细胞系不变亲和力**，应满足 $I(U_I; c|y) \to 0$

关键突破：$M(c)$ 以乘法方式作用，打破平移对称性；$T(c)$ 允许不同细胞系有不同的决策锐度。

## 解决方案：条件调制解耦网络 (Conditional Modulation Decoupling Network, CMDN)

### 数学描述

#### 1. 架构概览
CMDN由三个核心组件构成：

1. **细胞系不变编码器** $\phi_I: \mathcal{X} \to \mathcal{Z}_I$
   - 目标：提取与 $c$ 无关的序列特征
   - 硬约束：通过**信息瓶颈层**强制 $I(\phi_I(x); c|y) \leq \epsilon$

2. **细胞系特异性调制器** $\psi: \mathcal{C} \to (M, B, T)$
   - 输入：细胞系标识 $c$（或细胞系特征）
   - 输出：调制三元组 $(M(c), B(c), T(c))$
   - 要求：$M(c) > 0, T(c) > 0$

3. **不变亲和力头** $U_I: \mathcal{Z}_I \to \mathbb{R}$
   - 计算基础亲和力 $U_I = f_I(z_I)$

最终预测：
$$
\hat{y} = \sigma\left( \frac{M(c) \cdot U_I + B(c)}{T(c)} \right)
$$

#### 2. 硬约束机制

**2.1 信息瓶颈层 (Information Bottleneck Layer)**
在 $\phi_I$ 的输出后插入：
$$
z_I = \text{IBLayer}(h_I) = \mu_I + \sigma_I \odot \epsilon, \quad \epsilon \sim \mathcal{N}(0, I)
$$
优化目标：
$$
\mathcal{L}_{\text{IB}} = \beta \cdot \text{KL}(q(z_I|x) \| p(z_I)) - I(z_I; y)
$$
其中 $p(z_I) = \mathcal{N}(0, I)$。$\beta$ 控制解耦强度：$\beta$ 越大，$z_I$ 包含的 $c$ 信息越少。

**2.2 交换不变性损失 (Swap Invariance Loss)**
对于同一序列对 $x$，在不同细胞系 $c, c'$ 下：
$$
\mathcal{L}_{\text{swap}} = \mathbb{E}_{c,c'} \left[ \| \phi_I(x|c) - \phi_I(x|c') \|^2 \right]
$$
强制 $\phi_I$ 的输出不随 $c$ 改变。

**2.3 调制正交性约束**
为防止 $M(c)$ 吸收不变信息，要求：
$$
\mathcal{L}_{\text{orth}} = \left| \frac{\text{Cov}(U_I, M(c))}{\sigma_{U_I} \sigma_M} \right|
$$
强制 $U_I$ 与 $M(c)$ 不相关。

#### 3. 排序一致性优化

**3.1 Pairwise Ranking Loss**
直接优化AUPR的代理损失：
$$
\mathcal{L}_{\text{rank}} = \sum_{i \in \mathcal{P}, j \in \mathcal{N}} \max(0, \gamma - (s_i - s_j))
$$
其中 $\mathcal{P}$ 为正样本集，$\mathcal{N}$ 为负样本集，$s_i = M(c_i)U_I(x_i) + B(c_i)$，$\gamma$ 为边界。

**3.2 温度校准**
$T(c)$ 的学习通过**精度召回平衡损失**：
$$
\mathcal{L}_{\text{temp}} = |\text{Recall}(c) - \text{Precision}(c)|
$$
鼓励各细胞系内Recall与Precision平衡。

#### 4. 课程学习策略

**阶段1：不变特征学习**
- 冻结 $\psi$，设 $M(c)=1, B(c)=0, T(c)=1$
- 只训练 $\phi_I$ 和 $U_I$，优化 $\mathcal{L}_{\text{IB}} + \mathcal{L}_{\text{swap}}$
- 目标：建立稳定的 $z_I$ 表示

**阶段2：调制器学习**
- 解冻 $\psi$，引入 $\mathcal{L}_{\text{orth}}$
- 优化 $\mathcal{L}_{\text{rank}} + \lambda_{\text{orth}}\mathcal{L}_{\text{orth}}$
- 目标：学习细胞系特异性调制

**阶段3：联合微调**
- 所有组件联合训练
- 引入 $\mathcal{L}_{\text{temp}}$ 校准温度
- 目标：达到最佳排序性能

### 核心机制

#### 1. 为什么乘法调制优于减法？
- **打破平移对称性**：$(M, U_I)$ 与 $(M', U_I')$ 在 $MU_I = M'U_I'$ 时才等价，解空间维度降低
- **生物学解释**：$M(c)$ 可解释为细胞系特异性转录因子浓度，直接影响结合概率
- **形状调制**：$M(c)$ 改变亲和力尺度，$T(c)$ 改变决策锐度，更灵活

#### 2. 信息瓶颈的硬约束作用
传统对抗训练是**软约束**，可通过梯度反转绕过。信息瓶颈是**架构硬约束**：
- 随机噪声注入强制 $z_I$ 压缩信息
- KL散度直接控制 $z_I$ 与先验的距离，先验 $p(z_I)$ 不含 $c$ 信息
- 信息论保障：当 $\beta$ 足够大，$I(z_I; c) \leq I(z_I; x) - I(z_I; y)$ 自动满足

#### 3. 交换不变性的几何直观
对于同一 $x$，强制 $\phi_I(x|c)$ 在不同 $c$ 下一致，等价于要求 $\phi_I$ 的等值面与 $c$ 坐标轴正交。这是比线性正交更强的条件。

#### 4. 排序损失的梯度优势
BCE损失对容易样本梯度小，对困难样本梯度大，可能导致模型聚焦于噪声。Pairwise Ranking Loss 对所有违反排序的样本对提供梯度，更直接优化AUPR。

### 物理/生物对应

#### 1. 乘法调制 → 转录因子浓度效应
生物学中，转录因子浓度 $[TF]$ 影响结合概率：
$$
P_{\text{bind}} \propto \frac{[TF]}{K_d + [TF]}
$$
当 $[TF] \ll K_d$ 时，$P_{\text{bind}} \approx [TF]/K_d$，即乘法关系。$M(c)$ 对应细胞系特异性 $[TF]$。

#### 2. 温度参数 → 染色质可及性异质性
不同细胞系的染色质包装程度不同，影响结合反应的"锐度"。开放染色质（高可及性）对应低 $T(c)$，决策边界锐；封闭染色质对应高 $T(c)$，决策边界钝。

#### 3. 信息瓶颈 → 进化保守性
进化保守的调控基序必须在不同细胞系中工作，因此需要**鲁棒编码**——保留核心识别信息，丢弃细胞系特异性细节。信息瓶颈的噪声注入模拟了这种进化压力。

#### 4. 交换不变性 → 顺式调控元件的通用性
真正的增强子-启动子互作机制在细胞系间应基本不变，变化的只是反式作用因子环境。交换不变性强制模型学习这种通用机制。

## 实施路线图

### 阶段0：架构重构
1. 修改 `PRISMModel.py`：
   - 移除 $U_I - R_E$ 框架
   - 实现 `ModulationHead` 输出 $(M, B, T)$
   - 实现 `InformationBottleneckLayer`
2. 新增 `losses.py`：
   - 实现 $\mathcal{L}_{\text{IB}}$, $\mathcal{L}_{\text{swap}}$, $\mathcal{L}_{\text{rank}}$, $\mathcal{L}_{\text{temp}}$

### 阶段1：课程学习实现
1. 修改 `PRISM.py` 训练循环：
   - 实现三阶段调度器
   - 阶段切换基于验证集AUPR
2. 实现早停机制：当验证AUPR连续3轮下降时停止

### 阶段2：监控与验证
1. 实时监控：
   - $I(z_I; c)$ 估计（基于互信息神经网络）
   - $M(c)$, $T(c)$ 的分布与细胞系相关性
   - 各细胞系Recall-Precision平衡
2. 架构验证：
   - 确认信息瓶颈层正确注入噪声
   - 确认交换不变性损失计算正确

### 阶段3：超参数调优
1. 网格搜索：
   - $\beta$ (信息瓶颈强度): [0.1, 0.5, 1.0, 2.0]
   - $\lambda_{\text{orth}}$: [0.01, 0.1, 1.0]
   - $\gamma$ (ranking margin): [0.1, 0.5, 1.0]
2. 基于验证AUPR选择最优组合

## 预期行为与理论保障

### 成功标志
1. **泛化差距缩小**：训练AUPR ≈ 0.90，验证AUPR ≥ 0.75，差距 ≤ 0.15
2. **解耦成功**：$I(z_I; c) < 0.05$（归一化互信息），$M(c)$ 与 $U_I$ 相关系数 $|\rho| < 0.1$
3. **调制可解释**：$M(c)$ 与已知转录因子表达相关，$T(c)$ 与染色质可及性相关
4. **排序质量提升**：各细胞系AUPR均衡，最低细胞系AUPR ≥ 0.70

### 理论优势
1. **识别性**：乘法调制打破平移对称性，$(M, U_I)$ 可识别
2. **硬约束**：信息瓶颈提供信息论保障的细胞系不变性
3. **生物学合理**：调制框架对应真实生物学机制
4. **优化对齐**：排序损失直接优化目标指标

### 创新点总结
1. **范式转换**：从可加能量耗散转向条件调制
2. **架构硬约束**：信息瓶颈层强制解耦，非依赖损失函数
3. **交换不变性**：比正交更强的几何约束
4. **排序一致性**：直接优化AUPR代理损失
5. **可解释调制**：$M(c)$, $B(c)$, $T(c)$ 对应明确生物学意义

## 风险与缓解

### 高风险项
1. **信息瓶颈过压缩**：$\beta$ 过大可能导致 $z_I$ 丢失过多 $y$ 信息
   - 缓解：$\beta$ 课程学习，从0逐渐增加到目标值
2. **调制器过拟合**：$\psi$ 可能记忆训练细胞系，无法泛化
   - 缓解：$\psi$ 参数共享，相邻细胞系权重相似性正则
3. **排序损失计算开销**：$\mathcal{L}_{\text{rank}}$ 复杂度 $O(N^2)$
   - 缓解：批次内采样，每批次随机选100正100负计算

### 验证计划
1. **消融实验**：分别移除信息瓶颈、交换不变性、排序损失
2. **生物学验证**：检查 $M(c)$ 是否与ENCODE转录因子ChIP-seq信号相关
3. **泛化测试**：在完全未见细胞系上测试（如从训练集移除某细胞系）

---

**记录点31的本质创新在于：放弃持续失败的可加框架，拥抱更生物学真实的调制范式；用信息瓶颈和交换不变性提供信息论与几何双重硬约束；并通过排序一致性损失直接优化目标指标。这是从"修补旧框架"到"重建新框架"的范式跃迁。**