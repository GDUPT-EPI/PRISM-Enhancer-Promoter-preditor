# 记录点5修复方案：轻偏置注意力与能量校准

## 目标
- 保留记录点4在排序上的提升，同时修复过度置信、阈值飘高与 Recall/Precision 失衡。

## 关键改动
- 轻偏置注意力：将稀疏列偏置从 `attn_logits += log_w` 改为 `V_bias = α·weights·V` 的值通道引导或小幅加性到输出，设置 `α≤0.2` 并对 `weights` 做裁剪与归一化，避免跨 Query 的强推 Key。
- 输出校准层：在 `U_I` 前后引入温度标度 `τ>0` 与向量标度（可学习 `diag(s)`），并以校准损失（Brier/Entropy penalty）约束过度置信，保证概率不整体上移。
- 稀疏退火与熵约束：对 `sparse_temp` 执行计划退火（如从 2.0→1.0），并将 `sparsemax`替换为 `entmax(α≈1.3–1.5)`，附加显式熵下界，避免单峰化导致 Recall 虚高、Precision受损。
- 监控与早停：在验证集上跟踪 AUPR/AUC 与 Brier/Expected Calibration Error (ECE)，以校准指标联合早停，防止训练末期置信漂移。

## 实施要点
- attn.py：
  - 修改 `RoPE_AdaptAttention` 的偏置施加位置为 Value 侧或输出侧小幅加性，移除对 logits 的直接相加；保留 `Q·K` 的主导作用。
  - 在稀疏权重中加入裁剪 `weights = clamp(weights, w_min, w_max)` 与归一化，`w_min≈0.01`，`w_max≈0.2`。
  - 将 `sparsemax` 切换为 `entmax` 并增加退火计划参数与熵正则项。
- PRISMModel.py：
  - 在 `U_I_generator` 前后加入温度标度与校准损失项；保留GRL清洗但降低门控的放大效应（门控温度提高，残差系数下调）。
  - 训练循环中加入校准监控与早停逻辑（若现有训练脚本支持）。

## 验证计划
- 指标：AUPR/AUC必须≥记录点4；Precision提升、Recall不过度虚高；ECE与Brier显著下降，阈值回到合理区间（0.05–0.25）。
- 消融：分别关闭“轻偏置”“校准层”“退火+熵”，验证三者对排序与校准的贡献。

## 风险与缓解
- 排序回落风险：通过 `α` 和退火曲线逐步调参，保留少量列引导但不压倒匹配。
- 训练不稳定：对熵正则与校准损失设上限权重，避免主任务被盖过。

## 预期结果
- 维持点4的排序优势，同时恢复概率形状与阈值的可解释性；在未见细胞系上 Recall/Precision 平衡，整体指标超过标准 cross attn。
