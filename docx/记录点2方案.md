**诊断**
- CBAT的两阶段结构在固定阈值下系统性推高概率，表现为 Recall显著上升而 AUPR/AUC下降；根因来自强归纳偏置叠加：二维重排+块因果掩码、Top‑k稀疏选择、双门控凸融合，导致“覆盖友好、排序不稳”。
- 现实现仅做 `E←P`，并将 `E→E` 自注意显式屏蔽；模块一的块级因果掩码与跨序掩码叠加后，长程跨序对齐信息可能受限，进而损害全局排名。

**修改结果分析（与修改前/标准cross attn对比）**
- 修改前（CBAT旧版）：AUPR/AUC整体低于cross attn，Recall高、Precision低，典型“概率整体上移、排序受损”。
- 修改后：
  - AUPR/AUC较旧版普遍上升（如 Stomach AUPR 0.6772→0.7050，AUC 0.7076→0.7287），但与标准cross attn相比仍有差距或接近持平（如 Pancreas AUPR 0.7073 vs 0.6922）。
  - Recall从极高（>0.92）降至更合理区间（0.80–0.89），Precision从~0.53 上升到~0.57–0.59；F1基本与cross attn持平。
  - 阈值固定为0.05时，评分分布的“温控+软稀疏”抑制了过度升温，但未彻底扭转跨细胞的排名优势。
- 与标准cross attn对比：
  - cross attn以密集注意力、无结构稀疏和无门控偏置为主，排序最小化扭曲，因而AUPR/AUC更稳；CBAT仍存在结构性选择与门控融合，带来非线性偏置。

**与标准cross attn的结构差异**
- CBAT保留两阶段：局部表示（多尺度卷积金字塔）+注意力（窗口/块可选）+自适应稀疏 + FFN + 双门控；cross attn为单一密集注意力（或轻量FFN）且不做token选择。
- CBAT引入温度软稀疏（列偏置）与门控温控、小残差；cross attn不引入门控温度与稀疏策略。
- CBAT在 `E←P` 方向固定并屏蔽 `E→E`；cross attn通常为对称或标准QKV，不做方向屏蔽。

**为何提升不明显（根因反思）**
- 稀疏仍改变了列权重分布：即使软化为连续权重，学习到的评分函数与生物域偏移相关，在未见细胞系上可能对评分阈值与相对排序施加偏置，导致AUPR/AUC提升受限。
- 门控融合仍是凸组合：即使有温度控制与小系数残差，门控的分布可能在不同细胞域上呈系统性偏移，导致概率形状与排序同步发生变化。
- 仅做单向 `E←P`：当 `P`→`E` 的对齐在某些细胞域较弱时，无对称分支补偿，跨域下限不足。
- 全局锚点仅体现在池化温度：锚点对序列级全局对齐的影响有限，尚未在注意力层内直接参与（作为可访问的“关键列”），对远程对齐与域不变成分提升不足。
- 掩码策略仍“局部优先”：窗口掩码保障数值稳定但对跨远程对齐的直接通道不够强，导致与cross attn相比的全局交互能力仍受限。

**改造建议（鲁棒性上超越cross attn）**
- 双向协同：增加并行 `P←E` 分支，输出端以温控门控融合，并加入方向一致性正则，使两方向在未见细胞域维持最低排序一致性。
- 锚点参与注意力：在 `E←P` 注意力中增加来源于 `P` 的全局锚列（1–4个），作为可访问的特殊key/value，允许跨远程对齐直接通过锚传播；同时在池化端保留温度调制。
- 稀疏进一步软化：将列偏置由 `sigmoid((s-τ)/T)` 换为 `entmax`/`sparsemax` 风格的连续稀疏，并在训练中做温度退火与排名损失（如AUPR surrogate），避免结构地改变排序。
- 门控预归一与谱约束：在门控前后加入LayerNorm与加性偏置，配合轻量谱约束（限制门控参数范数），降低跨域分布偏移导致的概率整体上移。
- 注意力无掩码回退：对长序列小概率启用“全连接回退步”（每N步以小概率移除窗口掩码，仅保留padding掩码），为模型保留学习全局对齐的通道，提高未见域的适应性。
- RoPE尺度一致性：针对不同细胞系的长度分布，核查 RoPE scaling 的线性一致性，并统一多尺度卷积分支的位置信号注入方式，避免位置与结构调制的重复叠加。

**预期效果**
- 双向协同与锚点参与注意力将提供跨域的“下限保障”，在AUPR/AUC上相对cross attn更稳。
- 进一步软化稀疏与门控约束可减少排序扭曲，提升排名类指标并使阈值相关指标可后续通过温度/阈值校准。

**改造目标**
- 在未见细胞系上稳定提升 AUPR/AUC（阈值无关指标），并保持跨域鲁棒性。
- 保留“跨序交互优先”的设计，但削弱导致概率整体上移、排名破坏的结构性偏置。

**结构建议**
- 前端表示（替代2D重排）
  - 使用一维多尺度可分离卷积金字塔（短/中/长核的并行分支）替代 `[B,L,D]→[B,D,H,W]` 二维重排，避免网格化假设对序列语义的扭曲。
  - 在金字塔分支输出后做轻量融合（LayerNorm→线性→GELU），输出仍为 `[B,L,D]`，与后续RoPE/注意力完全兼容。

- 注意力掩码（“局部+全局”混合而非固定块因果）
  - 将固定“块级因果掩码”替换为“因果窗口 + 全局锚点”混合：
    - 窗口注意力：针对 `E` 侧，启用中等宽度的滑动窗口（如 64–128）保障局部依赖与数值稳定；
    - 全局锚点：为 `P` 序列引入1–4个全局锚点（由 `P` 的序列汇聚得到），允许 `E` 全局访问这些锚点，弥补远程对齐与跨域泛化。
  - 保持 `E→E` 屏蔽；允许 `E` 访问 `P` 的锚点和近邻窗口，避免纯块掩码带来的硬边界。

- 双向协同（对称跨序）  
  - 引入对称 `P←E` 分支，与 `E←P` 并行计算，以共享或轻量解耦的参数；在输出端通过温控门控（见下一条）进行凸融合。
  - 这样在未见细胞系上，若某一方向的对齐因分布偏移变弱，另一方向可补偿，提升 AUPR/AUC 的稳健性。

- 稀疏选择软化（替代硬 Top‑k）
  - 将硬 Top‑k 选择改为“温度退火的稀疏激活”（如 soft‑topk/entmax 类行为）：训练早期用更平滑的分布，逐步提高稀疏度，但不将未选token输出完全置零。
  - 目的：保持排序信息的连续性，避免 Scatter 零填导致非选token的贡献全失，从而改善 AUPR/AUC。

- 门控与残差（抑制饱和上移）
  - 在 `gate_1/gate_2` 前后加入预归一化与温度控制（LayerNorm→线性→Sigmoid，低温区间），限制门控输出靠近 0/1 的饱和，避免整体概率上移。
  - 引入 ReZero/LayerScale 风格的小系数残差，确保融合后的分布不会在训练后期系统性升温。

- 输出与池化（排序敏感）
  - 在 `SequencePooling` 后新增“锚点引导池化”：用全局锚点对 `E` 的权重做二次校正，减少单纯 softmax 池化带来的峰值放大。
  - 分类头前加入温度标度（可学习标度），专门针对排序一致性优化；在训练中以排名损失或 AUPR surrogate 做辅优化（不依赖固定阈值）。

- RoPE与尺度稳定性
  - 检查 RoPE 的 scaling 与训练长度配置，保持在未见长序列上频率线性缩放；对多尺度卷积分支的输出做统一位置调制，避免位置/结构双重调制叠加放大。

**鲁棒性建议（跨细胞）**
- 方向性一致性约束：在双向协同的输出上加轻量的一致性正则，使 `E←P` 与 `P←E` 在未见细胞上仍保持排序一致的“下限”。
- 域不变锚点：锚点的构造不依赖细胞系标签，仅来自 `P` 的序列统计，利用RoPE后池化的稳健成分，降低细胞域特异噪声进入跨序通道。
- 归一化与谱约束：在注意力权重与门控前后使用 LayerNorm/加性偏置方式，配合轻量谱约束，稳定跨域的数值范围，提升 AUPR/AUC 的可迁移性。

**预期效果**
- 取消2D重排与固定块掩码的硬边界后，跨序信号以“局部窗口+全局锚点”传播，增强长程对齐与未见域的泛化，AUPR/AUC上升。
- 软稀疏与温控门控保留排序信息、抑制概率整体上移；双向协同提供稳定的下限性能，在不熟悉的细胞系上更稳。
- 阈值相关指标（Precision/Recall/F1）可事后校准；但即使不调阈值，上述结构也会天然改善排名类指标，兑现“鲁棒性超越标准 cross attn”的目标。

如需，我可以按上述方向逐步做消融与可视化验证，确保每一条改造对 AUPR/AUC 的贡献明确，再决定上线顺序与参数范围。
