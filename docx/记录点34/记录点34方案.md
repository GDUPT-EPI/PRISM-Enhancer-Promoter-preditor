# 记录点34方案：Meta-BAM (Meta-learning based Basis Adaptation Modulation)

## 1. 核心哲学：从“样本平均”转向“机制重构”

### 1.1 问题的本质
在 5 个细胞系上训练，意味着模型能看到的“环境全貌”极其有限。
*   **线性坍塌**：传统的调制（如 FiLM 或简单的点积）在极小样本下会退化为 ID 记忆，因为模型只需要通过“平移”就能在 5 个点上达到最优，这种平移在 OOD 时会由于坐标系失效而彻底崩盘。
*   **平均数陷阱**：16 个样本的均值不仅包含巨大的噪声，更抹杀了调控的“极性”。生物调控不是背景噪音的叠加，而是特定机制的激活。

### 1.2 方案愿景：Meta-BAM
Meta-BAM 的核心思想是：**“全局原子机制 + 局部动态重构”**。模型不学习细胞系本身，而是学习一套通用的“生物逻辑原子”，并根据当前环境的观测证据（支持集/全量分布），动态地重新编排这些原子的组合方式。

---

## 2. 数学形式与架构设计

### 2.1 机制基空间 (Mechanism Basis Space: The "Logic Dictionary")
模型维护一组全局可学习的 **逻辑原子 $\mathbf{V} = \{v_1, v_2, ..., v_K\} \in \mathbb{R}^{K \times D}$**。它们不随细胞系改变，是生物界的“通用调控词典”。

*   **实现原理：潜变量模板 (Latent Templates)**
    每个 $v_k$ 在高维空间中定义了一个“调控原点”。当序列特征 $z_q$ 靠近 $v_k$ 时，意味着该序列在几何上匹配了某种 **生物物理构象** 或 **模体簇 (Motif Cluster)**。
*   **投影机制：从序列到潜质 (Sequence-to-Potential)**
    通过计算 $z_q$ 在各个基向量方向上的投影强度 $p_k = \text{Sim}(\hat{z}_q, \hat{v}_k)$，序列被编码为一个 **“机制潜力向量” $\mathbf{P} \in \mathbb{R}^K$**。
    - $p_k \gg 0$：序列具备响应机制 $k$ 的硬件基础（如有位点）。
    - $p_k \approx 0$：序列对机制 $k$ 免疫。
*   **学习动力学**：
    在训练时，模型被迫通过 5 个环境的差异来“挤压” $\mathbf{V}$。如果某个序列在 A 环境活跃但在 B 环境沉默，模型必须将这种差异归因于环境权重 $\alpha(c)$ 的改变，而将共同的序列特征沉淀到 $\mathbf{V}$ 中。

### 2.2 变分神经上下文 (Variational Neural Context, VNC)
彻底放弃 EMA 和统计平均。利用 **变分神经过程 (Variational Neural Process)** 的思想，将环境建模为从稀疏证据中推断出的 **潜变量动力学分布**：

1.  **环境潜流形 (Latent Environment Manifold)**：
    - **原理**：环境被表征为一个高维流形上的点 $z_c$。这个流形在训练时由 5 个细胞系的“全量证据”塑造，捕捉了生物调控状态的合法转移规律。
    - **2048 点流式全量观测**：面对 OOD 细胞系的观测，不再局限于 16 个样本。引入流式累积架构，在 1024 显存限制下观测 2048 个（或更多）分布点。模型通过这些点在已知的“生物逻辑流形”中找到最符合当前观测的逻辑坐标点 $z_c$。
    - **逻辑残差累积 (Logic Residual Accumulation)**：
      $$\mathbf{H}_t = \text{Norm}(\mathbf{H}_{t-1} + \psi(z_t, \mathbf{V}))$$
      其中 $z_t$ 为全量分布中的稀疏采样，$\psi$ 提取其对机制空间的逻辑扰动。最终 $z_c = \text{MLP}(\mathbf{H}_T)$。

2.  **变分推理目标 (ELBO for Context)**：
    通过最大化证据下界 (ELBO) 来推断 $z_c$：
    $$\mathcal{L}_{VNC} = \mathbb{E}_{q(z_c|S)} [ \log P(S | z_c) ] - \beta \cdot \text{KL}(q(z_c | S) \| p(z_c))$$
    - **$q(z_c | S)$**：上下文编码器，将支持集样本 $\{ (z_{s,i}, y_{s,i}) \}$ 映射为分布参数 $(\mu_c, \sigma_c)$。
    - **$P(S | z_c)$**：生成一致性。要求推断出的 $z_c$ 能够以高概率“解释”全量支持集内的互作观测。

### 2.3 递归机制展开 (Recursive Mechanism Unfolding, RMU)
为了封杀线性简化的作弊路径，将预测过程从“一步点积”升级为 **“多步逻辑展开”**。这模拟了信号通路中多级级联的非线性动力学：

1.  **时变调制算子 $\mathcal{M}(z_c)$ 的双线性实现**：
    环境特征 $z_c$ 通过超网络生成实时算子 $\Theta_{env} = \{ \mathbf{G}_{env}, \mathbf{W}_{env} \}$。
    - **$\mathbf{G}_{env} = \text{MLP}_g(z_c)$**：机制门控向量，决定各机制的表观活性。
    - **$\mathbf{W}_{env} = \text{Reshape}(\text{MLP}_w(z_c))$**：双线性交互矩阵，定义机制间的二阶交互逻辑。
2.  **递归推理步 (Reasoning Steps)**：
    序列 $z_q$ 的亲和力状态 $h^{(0)} = (z_q \cdot \mathbf{V}^\top) \odot \mathbf{G}_{env}$ 遵循如下非线性映射演化：
    $$h^{(t+1)} = \text{LayerNorm}( h^{(t)} + \sigma( \mathbf{W}_{env} h^{(t)} + b ) )$$
    - **逻辑反转 (Function Reversal)**：由于 $\mathbf{W}_{env}$ 是由 $z_c$ 动态生成的，模型可以理解在环境 A 中 $v_i$ 增强 $v_j$，而在环境 B 中由于 $\mathbf{W}_{env}$ 的改变导致 $v_i$ 抑制 $v_j$。
3.  **最终推演**：$P(y=1) = \sigma( \text{Pool}(h^{(T)}) )$。

#### **变量明确定义：**
| 符号 | 定义 | 物理/数学含义 |
| :--- | :--- | :--- |
| $P(y=1)$ | **预测概率** | E-P 对在特定环境下的互作概率。 |
| $\sigma$ | **Sigmoid 函数** | 将能量分数映射至 $[0, 1]$ 区间。 |
| $z_q$ | **Query 特征向量** | 由 CBAT Backbone 提取的序列内蕴特征 ($\in \mathbb{R}^D$)。 |
| $v_k$ | **机制基向量** | 全局共享的逻辑原子 ($\in \mathbb{R}^D$)。 |
| $z_c$ | **环境上下文潜变量** | 从全量观测中推断出的环境状态指纹。 |
| $\mathbf{W}_{env}$ | **双线性交互矩阵** | 环境调制的机制间协同/拮抗逻辑。 |
| $K$ | **机制总数** | 预定义的基向量数量。 |

### 2.4 架构选型讨论：为何选择双线性而非 Attention/Mamba？
针对机制调制层，不同架构的效果对比：

| 架构 | 好处 | 坏处 |
| :--- | :--- | :--- |
| **双线性 (Bilinear)** | **极强的逻辑可解释性**。显式建模 $v_i$ 与 $v_j$ 的二阶交互，符合生物调控的逻辑门特性。环境可重写逻辑算子。 | 机制数 $K$ 较大时，参数量随 $K^2$ 增长。 |
| **Attention** | **全局建模能力强**。适合长序列依赖。 | 容易陷入“平均数陷阱”。在高稀疏环境下容易让极性模糊。 |
| **Mamba / RWKV** | **线性推理效率极高**。 | **不适合机制集建模**。依赖序列顺序，而机制基空间是无序集合。 |

**最终决策**：采用 **超网络生成的双线性算子**。因为我们的核心需求是“在极少环境下进行逻辑推演”，双线性提供的二阶交互是实现“功能反转”理解的关键数学基础。

### 2.5 多尺度逻辑对齐 (Multi-Resolution Logic Alignment: Wavelet & Fourier)
单纯的 Transformer/CNN 提取的是固定感受野的特征。为了捕捉复杂的调控“波形”，引入多尺度分析：

*   **傅里叶能谱匹配 (Fourier Potential)**：
    序列特征 $z_q$ 与机制 $v_k$ 的匹配不应只在点积空间，还应在 **频域** 检查其周期性模式。
    $$\phi_{fourier} = \text{Sim}( \text{FFT}(z_q), \text{FFT}(v_k) )$$
*   **小波时频分解 (Wavelet Decomposition)**：
    借鉴小波变换，将序列信号分解为不同频率的局部特征。
    - **高频原子**：捕捉瞬时的 Motif 结合。
    - **低频原子**：捕捉长程的结构势能。

### 3.1 跨序列逻辑推理 (In-Context Reasoning)
模型在 5 个训练集上学到的不是“特征 A 对应标签 1”，而是：
**“如果在当前支持集中，展现了机制 $v_k$ 的富集，那么具有特征 $z_q$ 的序列应当被增强/抑制。”**
面对数千个 OOD 细胞系，模型通过观察其支持集（2048 点），识别出其独特的 $\alpha(c)$，从而实现逻辑层面的外推。

### 3.2 机制压缩与解耦约束 (Non-Linear Decoupling & Total Loss Formulation)
单纯的 GRL 容易导致特征坍塌。为了实现真正的环境-序列解耦，引入博弈论中的对抗平衡机制：

1.  **流形相位旋转 (Manifold Phase Rotation)**：
    调制建模为复数域的相位旋转：$z_q^{env} = z_q \odot \exp(i \cdot \text{MLP}_{rot}(z_c))$。
2.  **总损失函数公式组 (Total Training Objective)**：
    $$\mathcal{L}_{total} = \mathcal{L}_{task} + \lambda_1 \mathcal{L}_{VNC} + \lambda_2 \mathcal{L}_{adv} + \lambda_3 \mathcal{L}_{consistency}$$
    - **$\mathcal{L}_{consistency}$ (Support Set Reconstruction)**：
      $$\mathcal{L}_{consistency} = \| f_{dec}(z_c, z_{s,i}) - y_{s,i} \|^2$$
      这是 **“正向存在性约束”**。确保 $z_c$ 虽然丢弃了 ID 信息，但必须保留足够的物理信息来重构全量观测结果。

3.  **扩散细化 (Diffusion-based Inference Refinement)**：
    在 OOD 推理时，利用 Langevin 动力学精炼 $z_c$：$z_c^{(k+1)} = z_c^{(k)} + \eta \nabla_{z_c} [ \log P(S | z_c^{(k)}) + \log p(z_c^{(k)}) ]$。

## 4. 算法流程与 OOD 动态演化

### 4.1 证据驱动的贝叶斯推理流 (Bayesian Evidence Reasoning Flow)
1.  **流形定位 (Manifold Positioning)**：输入 2048 个观测点 $S$。变分编码器将其投影到环境潜流形。
2.  **不确定性坍塌 (Uncertainty Collapse)**：利用全量证据的联合似然，使 $q(z_c | S)$ 从全球先验坍塌为精确的局部指纹。
3.  **递归逻辑展开 (RMU Unfolding)**：Query 序列 $z_q$ 进入由 $z_c$ 实时生成的双线性算子网进行博弈。
4.  **非线性博弈结果**：输出在当前物理场下的最终响应。

### 4.2 训练与推理的 OOD 行为分析 (OOD Training-Inference Dynamics)
| 阶段 | 输入规模 | 核心目标 | OOD 鲁棒性来源 |
| :--- | :--- | :--- | :--- |
| **训练 (Training)** | **全支持集 (Full Support)** | 建立机制字典 $\mathbf{V}$ 和环境流形 $P(\alpha)$。 | **分布覆盖**：通过 5 个细胞系的全量分布，确保见过逻辑原子的各种形态。 |
| **推理 (Inference)** | **2048 点 (Dense Support)** | 在流形上寻找最能解释证据的 $\alpha^*$。 | **先验约束**：VIB 约束迫使模型回归到稳健的生物先验，防止预测溢出。 |

## 5. 验证与质检 (Verification & QA)
1.  **机制消融 (Mechanism Ablation)**：人为置零某个 $\alpha_k(c)$，观察预测结果的变化。
2.  **指纹漂移测试 (Fingerprint Drift)**：将 A 细胞系的指纹作用于 B 细胞系的序列。
3.  **正交性监控**：监控 $\mathbf{V}$ 的奇异值分布。
4.  **OOD 稳定性**：在 OOD 细胞系上观察 $\alpha(c)$ 的收敛速度。

## 6. 结论
Meta-BAM 方案通过 **2048 点流式全量观测** 解决了信息稀疏问题，通过 **双线性递归算子** 实现了环境对逻辑的实时重写。这不再是一个拟合模型，而是一个能根据全量观测证据，实时重组调控逻辑的 **生物物理推演引擎**。
