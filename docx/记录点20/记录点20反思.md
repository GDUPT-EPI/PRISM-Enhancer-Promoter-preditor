# 记录点20 反思：对比不变性能量网络 (CIEN)

## 失败结构定理

**条件互信息最小化的非凸博弈导致模型收敛到退化的鞍点**，其中表示$\Phi(x)$通过将$U_I$收缩到高值区域并让$R_E$吸收所有细胞系变异，来*形式上*满足$I(\Phi(x); c \mid y) \approx 0$，但代价是破坏了排序能力。数学上：

$$
\min_{\Phi, U_I, R_E} I(\Phi(x); c \mid y) \quad \text{s.t.} \quad P(y=1 \mid x, c) = \sigma\left(\frac{U_I(\Phi(x)) - R_E(c)}{T}\right)
$$

的解空间包含一个**退化解子流形**：
- $U_I(\Phi(x)) \approx M$（大常数，接近Sigmoid饱和区）
- $R_E(c) \approx M - \delta(c)$，其中$\delta(c)$编码细胞系差异
- 此时$P(y=1 \mid x, c) \approx \sigma(\delta(c)/T)$，与$x$几乎无关，但$I(\Phi(x); c \mid y) \approx 0$（因为$\Phi(x)$与$c$的关联被$R_E$吸收）

模型收敛到了这个退化解，导致**表征坍缩**与**决策边界消失**。

## 根因分析

### 数学层面

#### 1. 优化景观的对称性破缺失败
能量耗散框架具有**平移对称性**：$(U_I, R_E) \to (U_I + a, R_E + a)$不改变预测。对比损失试图约束$U_I$在同类样本间相似，但：
- 对称性导致$U_I$可以整体平移而不影响对比损失
- $R_E$可以吸收任意偏移，使对比损失无法唯一确定分解

#### 2. 条件互信息最小化的博弈失衡
目标$\min_{\Phi} I(\Phi(x); c \mid y)$通过对抗训练实现：
- 判别器$D(z, y)$试图从$(z, y)$预测$c$
- 生成器（编码器）试图使$D(z, y)$输出均匀分布

但**梯度冲突**发生：
- 对抗损失与分类损失梯度方向相反
- 判别器过早收敛到最优（准确率25%，随机水平）
- 编码器学到平凡策略：使$z$坍缩到小区域，$D$无法区分细胞系

#### 3. 泛化差距的信息论解释
训练AUPR 0.9863 → 测试AUPR 0.6896，差距0.297。
- **经验Rademacher复杂度过高**：模型容量过大，在训练集上实现了几乎完美拟合
- **不变性约束不足**：$I(\Phi(x); c \mid y)$在训练集上被最小化，但在测试分布上条件互信息仍高
- **分布偏移**：训练时批次混合所有细胞系，测试时按细胞系分组，导致条件分布$p(c \mid y)$变化

#### 4. Recall-Precision失衡的几何根源
Recall 0.8639, Precision 0.5439。
- **决策边界整体偏移**：Sigmoid激活的logits$(U_I - R_E)/T$偏向正半轴
- **高Recall低Precision**暗示：多数样本的logits > 0，但真阳性与假阳性分离度低
- **从流形视角**：正负类流形在表示空间重叠严重，仅通过整体平移分离

### 算法层面

#### 1. 对比损失实现缺陷
```python
contrastive_loss = self.supcon_loss(z_norm, labels)
```
- $z_{\text{norm}} = \Phi(x)/\|\Phi(x)\|_2$使用归一化表示
- 但归一化**丢弃了模长信息**，而模长可能编码重要信号
- 同类样本聚集可能迫使表示坍缩到球面小区域

#### 2. 条件对抗的梯度反转问题
```python
z_I_reversed = grad_reverse(z_I, alpha=1.0)
domain_logits = self.domain_discriminator(z_I_reversed)
```
- **无条件对抗**（最小化$I(\Phi(x); c)$）与**条件对抗**（最小化$I(\Phi(x); c \mid y)$）共存
- 梯度反转系数$\alpha=1.0$固定，未适应训练阶段
- 判别器同时接收$z_I$和$y$，但$y$可能提供足够信息预测$c$，使对抗失效

#### 3. 能量分解的监督缺失
$U_I$和$R_E$缺乏**独立监督信号**：
- 无物理/生物学约束强制$U_I$反映序列亲和力
- $R_E$仅通过稀疏损失（L1正则）约束，强度不足
- 分解的任意性未被打破

#### 4. 训练-推理不一致
- 训练：对比损失、对抗损失激活
- 推理：仅$U_I$和$R_E$使用，对比/对抗模块关闭
- 但训练目标影响表示$\Phi(x)$，间接影响推理

### 生物学层面

#### 1. 违背顺式调控逻辑
EP互作由**序列特异的转录因子结合**驱动，具有：
- **结合亲和力梯度**：不同序列亲和力连续变化
- **细胞系特异性调制**：染色质可及性、共因子表达等调节互作概率

当前模型：
- $U_I$坍缩到常数，丢失亲和力梯度
- $R_E$吸收所有细胞系变异，但实际中细胞系特异性**调制**而非**决定**互作

#### 2. 忽视保守性与特异性的平衡
进化上：
- **保守元件**：在多数细胞系中活跃
- **细胞类型特异元件**：仅在特定环境活跃

模型应分离：
- **保守亲和力**（$U_I$）：跨细胞系稳定的序列特征
- **特异性调制**（$R_E$）：细胞系特异的放大/抑制

当前两者混淆。

## 关键洞察

### 1. 对称性破缺是核心
能量框架的平移对称性必须被打破，方法：
- 锚定$U_I$的绝对值尺度（如约束正类样本$U_I > \theta_+$，负类$U_I < \theta_-$）
- 引入**参照细胞系**，设其$R_E=0$

### 2. 条件对抗需要更强的因果约束
单纯最小化$I(\Phi(x); c \mid y)$不足，因为：
- $y$与$c$相关（某些细胞系互作更多）
- 模型可让$\Phi(x)$编码$y$，$R_E$编码$c$，满足条件独立

需引入**反事实约束**：干预$c$而保持$x$不变，观察$y$变化。

### 3. 排序能力需要显式优化
当前优化分类准确率（通过IMMAX损失），但最终评估的是**排序**（AUPR）。
- 分类损失关注**符号**(logits正负)
- 排序损失关注**相对顺序**(logits大小关系)

应直接优化排序敏感损失（如pairwise ranking loss）。

### 4. 过拟合的根源是假设空间过大
13M参数在145k样本上训练，极易过拟合。
- **减少容量**？可能损害表达能力
- **增加不变性约束**：更严格的结构性先验（如拓扑图）
- **早停**？但训练AUPR持续上升，无验证集指导

## 对下一步的启示

### 必须解决的问题
1. **打破平移对称性**：锚定$U_I$或$R_E$的绝对尺度
2. **强化因果不变性**：引入反事实推理或干预约束
3. **直接优化排序**：使用pairwise或listwise ranking损失
4. **降低有效容量**：通过不变性约束而非减少参数

### 避免重蹈覆辙
- ❌ 单纯增加正则化强度（如增大$\lambda_{\text{cont}}$）
- ❌ 无条件对抗与条件对抗堆叠
- ❌ 仅优化条件互信息而不约束分解唯一性
- ✅ 设计**自洽的物理模型**，明确$U_I$和$R_E$的生物学对应
- ✅ 引入**外部锚点**（如保守互作、已知结合位点）提供绝对尺度
- ✅ **分层优化**：先学不变表示，再学能量分解

### 新方案方向
从**条件互信息最小化**转向**因果干预模型**：
- 将细胞系$c$视为**干预变量**
- 学习$P(y \mid do(x), c)$而非$P(y \mid x, c)$
- 使用**不变风险最小化**(IRM)或**因果推断**框架

或回归**基于拓扑的物理模型**（记录点19的TIED-Net），但解决其数据依赖问题。