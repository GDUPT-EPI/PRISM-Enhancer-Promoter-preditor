记录点13方案：工程上彻底解耦 U_I 与 R_E 的训练职责

一、总目标：回到“序列学共性，环境做纠偏”的原点

- 面对复杂的生物学情况，一个**未见过的细胞系**如果模型依然能保持良好的预测效果，这才是 CBAT 的意义。
- 基于记录点4、7、8、9、10、11、12 的经验，我们确定：
  - 思想是对的：能量耗散系统 + 学生竞争机制 + 解耦对抗算子；
  - 真正的问题在**工程落地**：把过多复杂目标叠加在同一条数据流上，让 U_I 和 R_E 同时被蒸馏、对抗、竞争拉扯，从而滑向平凡解。
- 记录点13 的核心任务：用最小但关键的工程重构，恢复“U_I 只做序列共性排序，R_E 只做环境纠偏”，并保证训练与推理使用**完全一致**的能量公式。

二、结构原则：两条通路、三种角色、一个能量公式

1. 两条通路（严格物理解耦）
- 序列通路（U_I 通路）：
  - 输入：EP 序列经过 CBAT 主干得到的 z_I。
  - 目标：学习跨细胞系共享的“物理势能”排序，只负责区分“互作总体上可能/不可能”，不参与任何环境博弈。
  - 约束：仅接受任务损失（基于 (U_I−R_E)/T）和必要的轻量正交约束，不再直接接受 CED‑Net 蒸馏与 Push/Pull 的梯度。
- 环境通路（R_E 通路）：
  - 输入：z_F（环境特征）以及基于 CellBatch/Support Set 的上下文统计。
  - 目标：学习每个细胞系/环境的阻抗分布，负责在推理时根据观测到的特性做“方向性纠偏”。
  - 约束：Teacher/Student/Opportunist 的蒸馏、Push/Pull、Manifold Alignment 全部限制在环境通路的表示 M/R_E 上，不直接修改 z_I。

2. 三种角色（CED‑Net 在环境通路内部完成）
- Teacher：
  - 使用细胞 ID 与全局原型图，给出环境先验阻抗 R_T 与原型 M_T。
  - 仅在训练时使用，推理时不依赖 ID。
- Student：
  - 仅使用 CellBatch 中的上下文（z_F + 统计特征），学习从数据分布中恢复 R_E。
  - 推理时成为唯一的环境推断器，用 Support Set 构造上下文。
- Opportunist：
  - 使用简单统计或局部捷径特征，提供“坏但有用”的机会主义参考。
  - 通过 Push‑away 约束迫使 Backbone 放弃捷径，将信息推向正确的 U_I / R_E 分解。

3. 一个能量公式（训练 = 推理）
- 统一采用：
  - P(y=1|x, env) = σ((U_I(x) − R_E(x, env)) / T)
- 要求：
  - 训练时所有任务损失都基于这个 P(y=1) 计算；
  - 推理时不再出现“另一套 E_total 计算方式”，确保训练与推理能量一致。

三、训练阶段的具体调整方案

1. U_I 通路的简化与“去蒸馏化”
- 保留：
  - 记录点4 中的 CBAT 主干与 Anchor 池化，得到 z_I；
  - FourierEnergyKAN 作为 U_I 生成器。
- 移除/削弱：
  - 不再在 z_I 上附加与 CED‑Net 相关的蒸馏、Push/Pull、KL 等损失；
  - 若需要 domain 对抗（GRL），限定为“小权重 + 只作用于 z_F 或环境相关支路”，避免直接破坏 U_I 的排序。
- 新的梯度路径：
  - U_I 只通过主任务损失 dL/d(U_I) 回传，L=CE(y, σ((U_I−R_E)/T))。

2. R_E 通路的 CED‑Net 重构
- 表示设计：
  - 用 z_F 经过独立的环境编码器得到 M_env（可以沿用现有 BypassDecoupler 的一部分结构，但从 z_F 而不是 z_I 出发）。
  - Teacher: M_T = f_T(cell_id)，R_T = g_T(M_T)。
  - Student: M_S = f_S(M_env, CellBatch 上下文)，R_S = g_S(M_S)。
  - Opportunist: M_O = f_O(简单统计)，R_O = g_O(M_O)。
- 损失设计：
  - 蒸馏：KL(P_T || P_S) 或 L2(R_T, R_S)，只作用在 R_E 侧；
  - Push/Pull：
    - Pull：当 Student 在某些样本上明显比 Opportunist 差时（以任务 Loss 或 AUPR surrogate 为标准），鼓励 R_S 向 R_O 靠近；
    - Push：在样本上 Student 比 Opportunist 强时，鼓励 R_O 远离 R_S，拆解机会主义捷径。
  - Manifold Alignment：对齐 M_T 与 M_S 的流形结构，但不将其梯度施加到 z_I。
- 任务信号传递：
  - 所有环境通路的损失最终通过 R_E 影响 (U_I−R_E)/T 的任务损失，而不直接回流到 U_I 或 z_I。

3. CellBatch 与 Support Set 的一体化设计
- 训练时：
  - 保持记录点12 的 CellBatch，同一 Batch 内只包含一个细胞系；
  - 在 Batch 内构造 Support Set 与 Query Set：
    - Support 用于估计环境统计（用于 Student 输入）；
    - Query 用于计算任务损失与蒸馏/竞争损失。
- 推理时：
  - 复用相同的 Support/Query 划分逻辑：
    - 先在该细胞系上构建 Support Set，估计 M_env 分布并计算 R_S；
    - 然后在 Query 上用统一公式 P(y=1)=σ((U_I−R_S)/T) 进行预测。
- 这样可以避免记录点8–10 中“训练是 Meta‑Batch，推理是 per‑cell”的任务错位。

四、推理阶段的统一流程（取代当前 predict.py 的分支选择）

1. 对每个细胞系 c：
- 构建 Support Set S_c：
  - 从该细胞系的数据中抽取一部分样本（可以是全部训练集或固定比例），通过环境编码器得到 M_env 分布。
  - Student 使用 S_c 作为上下文推断 R_E,c（可以是标量或分布参数）。
- 对每个待预测样本 (E,P) 属于细胞系 c：
  - 通过主干得到 z_I，并用 FourierEnergyKAN 得到 U_I；
  - 使用预先估计好的 R_E,c 计算 logits=(U_I−R_E,c)/T；
  - 经 Sigmoid 得到概率并评估 AUPR/AUC。

2. 不再做“基线 vs 学生分支”的事后选择
- 当前 predict.py 中“基线分支 vs 学生分支取 AUPR 更高者”本质上是一种后验救火机制：
  - 掩盖了训练阶段目标错位的问题；
  - 让评估结果难以反映真实模型能力。
- 记录点13 中：
  - 只保留一条逻辑清晰的路径：所有样本均通过 U_I 与 Student 推断的 R_E,c 进行预测；
  - 如需对比基线，仅作为独立实验，而不参与推理决策。

五、与“学生竞争机制 / 解耦对抗算子”的对齐

1. 学生竞争机制的落实
- Teacher：提供细胞系级别的阻抗先验 R_T 与原型 M_T；
- Student：在 CellBatch/S_c 上学习恢复 R_T，并在 OOD 细胞系上从观测分布推断新的 R_E；
- Opportunist：通过 Push‑away 拆解基于局部统计的捷径，将它们推离 U_I 与 R_E 的主流形，从而保证模型在看不到细胞 ID 时也能维持稳定预测。

2. 解耦对抗算子的落实
- 对抗约束不再作用于 z_I 本身，而是在环境通路与域判别器之间施加：
  - 目标是让 R_E 对未知细胞系保持可解释的偏移结构，而不是在 z_I 上粗暴抹平所有环境差异。
- 对 U_I 的唯一“对抗”只是通过任务损失驱动它在所有细胞系上维持统一的排序标准，实现真正意义上的“序列共性 + 环境特性”分工。

六、预期行为与验证策略

1. 预期现象
- 在训练日志上：
  - 训练 AUPR/AUC 不再出现记录点11 那种极端暴涨，而是在 0.7–0.9 区间平滑上升；
  - Pull 不再长期为 0，而是在训练中期保持适度非零，反映 Student 与 Opportunist 的真实竞争；
  - U_I 的方差在各细胞系之间保持稳定，不再收缩为近似常数。
- 在测试结果上：
  - domain‑kl/test 的 AUPR 逐步超过记录点4（0.71–0.72），目标区间 0.78–0.82；
  - 对未见细胞系，AUPR 较记录点12 有稳定提升，说明环境通路的 Student 确实学会了基于 Support Set 做纠偏。

2. 验证策略
- 指标：
  - 按细胞系记录 U_I 分布的均值/方差，验证其是否稳定且不被环境通路扰动；
  - 分别记录基于 R_T、R_S 的性能，验证 Student 是否真正学会从数据分布中恢复环境阻抗；
  - 监控 Pull/Push 的数值，不再接受“长期为 0”的假竞争状态。
- 消融实验：
  - 去掉 Opportunist，仅保留 Teacher‑Student 蒸馏，观察模式坍缩是否明显加重；
  - 去掉 Teacher，仅用 Student + CellBatch，看 OOD 性能是否显著下降，验证原型先验的贡献。

七、工程落地的优先级顺序

1. 第一阶段（最小可行修复）
- 在不大改接口的前提下：
  - 停止从 z_I 出发构建 R_E，改为从 z_F / 环境统计构建；
  - 关闭所有直接作用于 z_I 的蒸馏与 Push/Pull，只保留任务损失与轻量正交约束；
  - 在训练和推理中统一通过 Student 推断 R_E，并使用相同的能量公式。

2. 第二阶段（结构清理与重构）
- 梳理 PRISMBackbone 中所有与环境相关的分支，将其集中为独立的“环境模块”；
- 将 Teacher/Student/Opportunist 的实现迁移到该模块内，确保接口清晰（输入：CellBatch/Support Set；输出：R_E 或其参数）。

3. 第三阶段（细节调优）
- 基于第一、二阶段的结果：
  - 调整温度 T 与正则系数；
  - 迭代 Pull/Push 触发门限与 APL 策略；
  - 逐步恢复必要的对抗与流形对齐约束，但始终限制在环境通路内部。

最终目标：在记录点13 中，让 PRISM 真正回到一开始的物理直觉——**序列决定可能性，环境做细致纠偏**——并在未见细胞系上实现稳定、可解释且高于记录点4/12 的 AUPR/AUC，而不再依赖任何形式的后验“分支选择”或指标投机。

