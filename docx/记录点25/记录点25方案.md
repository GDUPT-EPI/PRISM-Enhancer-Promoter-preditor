# 记录点25 方案：结构化门控能量网络（Structured Gated Energy Network, SGEN）

## 核心洞察（一句话）

**EP互作的环境调节本质上是门控机制而非线性交互——染色质状态对转录因子结合的作用具有阈值饱和特性；通过结构化门控函数、互信息解耦、特征化环境表示与排序损失直接优化，可实现对生物学机制的更忠实建模与泛化提升。**

## 问题的数学形式化

### 输入与输出空间
- 输入对：$x = (E, P) \in \mathcal{X}$ DNA序列，来自细胞系 $c \in \mathcal{C}$。
- 细胞系特征：假设存在（或可学习）特征向量 $v_c \in \mathbb{R}^m$，表征染色质可及性、转录因子表达等表观特征。
- 标签：$y \in \{0,1\}$ 表示EP互作。
- 观测分布：$(x,c,y) \sim P_{\text{data}}$。
- 目标：学习 $P_\theta(y|x,c)$，在未知细胞系 $c' \notin \mathcal{C}_{\text{train}}$ 上最大化AUPR，即优化排序泛化性能。

### 生物学机制假设
1. **序列内在倾向**：DNA序列蕴含转录因子结合位点组合，决定**潜在互作倾向** $U_I(x)$。
2. **环境门控调节**：细胞系环境 $c$ 通过染色质状态等表观特征**允许或阻断**序列倾向的实现，调节强度 $R_E(c)$。
3. **阈值饱和效应**：当环境抑制足够强时，互作被完全阻断（饱和抑制）；当环境允许时，序列倾向完全表达（饱和允许）。线性乘积模型不符合此生物学现实。
4. **特征连续性**：细胞系间差异可表征为连续特征 $v_c$ 的差异，支持未见细胞系的插值外推。

### 当前框架的数学缺陷（继承自记录点24）
1. **交互无约束**：$\lambda U_I R_E$ 允许任意线性交互，模型可滥用该自由度记忆噪声。
2. **解耦不彻底**：Pearson相关系数只约束线性相关，非线性依赖未被惩罚。
3. **环境表示离散**：$z_E$ 为细胞系ID的查表式嵌入，无法外推。
4. **损失任务错配**：分类损失不直接优化AUPR（排序指标）。

## 解决方案

### 数学描述

#### 1. 结构化门控能量公式
定义**序列内在倾向** $U_I(x) = g_I(z_I) \in \mathbb{R}$ 与**环境调节强度** $R_E(c) = g_E(z_E) \in \mathbb{R}$。引入门控函数 $G: \mathbb{R}^2 \to [0,1]$ 表示环境对序列倾向的调节：

$$
P_\theta(y=1|x,c) = \sigma\left( \frac{U_I(x) \cdot G(U_I(x), R_E(c))}{T} \right)
$$

其中 $T > 0$ 为温度。关键创新在于门控函数 $G$ 的结构化设计：

**方案A（乘法门控）**：
$$
G(U_I, R_E) = \frac{1}{1 + \exp(-w \cdot R_E)}
$$
此为sigmoid门控，$w > 0$ 为可学习斜率。生物学解释：环境调节强度 $R_E$ 决定序列倾向被放大的比例。当 $R_E \to \infty$，$G \to 1$（完全允许）；$R_E \to -\infty$，$G \to 0$（完全阻断）。sigmoid的平滑性支持梯度传播。

**方案B（条件增强门控）**：
$$
G(U_I, R_E) = 1 + \alpha \cdot \tanh(U_I) \cdot \sigma(R_E)
$$
其中 $\alpha \in [0,1]$ 为可学习耦合强度。生物学解释：环境对**高倾向序列**（$\tanh(U_I) > 0$）有增强作用，对**低倾向序列**（$\tanh(U_I) < 0$）有抑制作用。$\sigma(R_E)$ 控制调节强度。

**方案C（阈值门控）**：
$$
G(U_I, R_E) = \mathbb{1}_{R_E > \tau} + \beta \cdot \mathbb{1}_{R_E \leq \tau}
$$
其中 $\tau$ 为阈值，$\beta \ll 1$。此为非连续门控，需使用直通估计器（Straight-Through Estimator）传播梯度。

**推荐方案A**：sigmoid门控具有连续梯度、明确生物学解释（环境作为序列倾向的放大器），且参数少（仅 $w$）。后续分析基于方案A。

#### 2. 特征化环境表示
抛弃细胞系ID嵌入，改为基于细胞系特征 $v_c$ 的表示：

- 若有显式特征 $v_c$（如染色质可及性谱）：$z_E = f_E(v_c)$，其中 $f_E$ 为MLP。
- 若无显式特征：从支持集学习原型表示。对于细胞系 $c$，随机采样 $k$ 个样本 $S_c = \{x_1, \dots, x_k\}$，计算：
  $$
  z_E = \text{AttnPool}(f_E'(f_I^{\text{mid}}(x_i)) \mid x_i \in S_c)
  $$
  其中 $f_I^{\text{mid}}$ 为 $f_I$ 的中间层特征，$f_E'$ 为轻量投影，$\text{AttnPool}$ 为注意力池化。

此设计确保 $z_E$ 可泛化到未见细胞系：通过其特征 $v_c$ 或支持集样本 $S_{c'}$ 计算。

#### 3. 互信息解耦约束
使用对比学习估计并最小化 $z_I$ 与 $z_E$ 的互信息 $I(z_I; z_E)$。对于批次 $\{(x_i, c_i)\}_{i=1}^B$：

1. 正对：$(z_I^{(i)}, z_E^{(i)})$ 来自同一样本。
2. 负对：$(z_I^{(i)}, z_E^{(j)})$ 来自不同样本（$i \neq j$）。

InfoNCE下界：
$$
\hat{I}(z_I; z_E) = \mathbb{E}\left[ \log \frac{\exp(s(z_I^{(i)}, z_E^{(i)})/\tau)}{\sum_{j=1}^B \exp(s(z_I^{(i)}, z_E^{(j)})/\tau)} \right]
$$
其中 $s(u,v) = u^\top v / \|u\|\|v\|$ 为余弦相似度，$\tau$ 为温度。

**解耦损失**：
$$
\mathcal{L}_{\text{MI}} = \hat{I}(z_I; z_E)
$$
最小化该损失使 $z_I$ 与 $z_E$ 统计独立（不仅仅是线性无关）。

#### 4. 排序感知损失集成
主任务损失采用 **IMMAX + Pairwise Ranking Loss** 组合：

$$
\mathcal{L}_{\text{task}} = \mathcal{L}_{\text{IMMAX}} + \gamma \mathcal{L}_{\text{rank}}
$$

其中 $\mathcal{L}_{\text{IMMAX}}$ 为AdaptiveIMMAXLoss，$\mathcal{L}_{\text{rank}}$ 为 pairwise logistic loss：

$$
\mathcal{L}_{\text{rank}} = \frac{1}{N_{\text{pairs}}} \sum_{i: y_i=1} \sum_{j: y_j=0} \log\left(1 + \exp(-(s_i - s_j))\right)
$$
其中 $s_i = \log P_\theta(y_i=1|x_i,c_i)$ 为 logit。此损失直接优化AUPR，鼓励正样本得分高于负样本。

#### 5. 不变性损失与特征重构
- **不变性损失** $\mathcal{L}_{\text{inv}}$：通过GRL与细胞系分类器 $D(z_I)$，最小化 $I(z_I; c)$（域对抗）。
- **特征重构损失**（若有 $v_c$）：$\mathcal{L}_{\text{recon}} = \| \text{Decoder}(z_E) - v_c \|^2$，确保 $z_E$ 保留细胞系特征信息。

#### 6. 总损失函数
$$
\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}} + \alpha \mathcal{L}_{\text{MI}} + \beta \mathcal{L}_{\text{inv}} + \delta \mathcal{L}_{\text{recon}}
$$
初始权重：$\alpha=0.1, \beta=0.1, \gamma=0.05, \delta=0.05$（若有重构）。

### 核心机制

#### 1. 为什么门控结构优于线性交互？
线性交互 $U_I + \lambda U_I R_E$ 允许环境对序列倾向的调节比例**随 $U_I$ 线性增长**。生物学上，环境更可能表现为**阈值调节**：当染色质开放时，序列倾向完全表达；封闭时完全阻断。Sigmoid门控 $1/(1+e^{-wR_E})$ 模拟此阈值行为：$R_E$ 超过某阈值后，$G \approx 1$（完全允许）；低于阈值，$G \approx 0$（完全阻断）。这种饱和特性防止模型滥用交互项拟合噪声。

数学上，门控结构将假设空间从二次函数 $a U_I + b R_E + c U_I R_E$ 限制到 $U_I \cdot \sigma(w R_E)$，减少了自由度，降低了过拟合风险。

#### 2. 互信息解耦为何更强？
Pearson相关系数 $\rho(z_I, z_E)$ 只度量线性依赖。$z_I$ 与 $z_E$ 可满足 $\rho=0$ 但仍有高阶依赖（如 $z_E = z_I^2$）。互信息 $I(z_I; z_E)$ 捕获所有阶统计依赖，包括非线性。最小化 $I(z_I; z_E)$ 确保 $z_I \perp\!\!\!\perp z_E$（统计独立），这是解耦的充分条件。

实践上，InfoNCE提供 $I(z_I; z_E)$ 的可微下界估计，可直接优化。

#### 3. 特征化环境表示如何支持泛化？
ID嵌入 $z_E = \text{Embedding}(c)$ 本质上是查表，无法泛化到未见 $c'$。特征化表示 $z_E = f_E(v_c)$ 或 $z_E = \text{Aggregate}(\{x \in S_c\})$ 建立了从**可观测特征**到表示的连续映射。对于未见细胞系 $c'$，可通过其特征 $v_{c'}$ 或支持集样本 $S_{c'}$ 计算 $z_E$，实现外推。

这对应生物学事实：细胞系间差异由表观特征（染色质可及性、TF表达）的连续变化导致，而非离散标签。

#### 4. 排序损失如何提升AUPR？
AUPR是排序指标，衡量正样本得分高于负样本的概率。分类损失（如交叉熵、IMMAX）优化**校准概率**，但不直接优化**得分排序**。Pairwise logistic loss 直接惩罚错误排序（正样本得分低于负样本），与AUPR目标一致。

理论上，优化 $\mathcal{L}_{\text{rank}}$ 相当于最大化AUC（ROC曲线下面积）的替代，而AUPR与AUC强相关。实验表明，加入排序损失可显著提升AUPR。

### 物理/生物对应

#### 1. 门控函数 → 染色质状态阈值调节
Sigmoid门控 $1/(1+e^{-wR_E})$ 对应染色质可及性的**阈值效应**：当可及性超过临界值（$R_E > 0$），区域开放，转录因子可结合；低于临界值（$R_E < 0$），区域封闭，结合被阻断。斜率 $w$ 控制过渡锐度，反映细胞系间可及性变化的陡度。

#### 2. 互信息解耦 → 进化保守性与发育可塑性分离
$z_I$ 编码进化保守的序列模块（如转录因子结合位点），$z_E$ 编码发育可塑的染色质状态。统计独立性 $I(z_I; z_E)=0$ 对应生物学事实：序列模块在进化中保守，而染色质状态在发育中动态变化，两者受不同机制调控。

#### 3. 特征化环境表示 → 表观特征连续谱
细胞系间差异源于表观特征（如DNA甲基化、组蛋白修饰）的定量差异，而非定性区别。特征向量 $v_c$ 编码此连续谱，$f_E$ 学习其到调节强度的映射，符合细胞类型连续过渡的现代观点。

#### 4. 排序损失 → 增强子-启动子配对特异性
生物学中，增强子-启动子互作具有高度特异性：正确配对得分应显著高于错误配对。Pairwise loss 强制模型学习此特异性，将真正互作对与随机对分开，对应实验验证中常采用的"增强子劫持"测试。

## 实施路线图

### 第一阶段：架构修改（`models/PRISMModel.py`）
1. **门控模块实现**：
   - 添加 `GatedEnergyHead`：输入 $U_I$, $R_E$，输出 $U_I \cdot \sigma(w R_E)$。
   - $w$ 初始化为1.0，可学习。
   - 保留温度参数 $T$（可学习，初始1.0）。

2. **环境编码器改造**：
   - 若提供细胞系特征矩阵 $V \in \mathbb{R}^{|\mathcal{C}| \times m}$，实现 `FeatureBasedEnvEncoder`。
   - 否则实现 `SupportSetEnvEncoder`：从支持集样本通过注意力池化计算 $z_E$。

3. **互信息估计模块**：
   - 实现 `MIEstimator`：使用InfoNCE估计 $I(z_I; z_E)$。
   - 批次内自动构建正负对。

4. **排序损失集成**：
   - 在损失计算中增加 `PairwiseRankingLoss`。
   - 注意大规模负样本对的采样策略（随机子采样）。

### 第二阶段：训练策略
1. **课程学习**：
   - Phase 1（2 epoch）：冻结环境部分，$w=0$（无门控），训练序列部分。
   - Phase 2（剩余）：解冻所有，逐步增加 $\alpha, \beta, \gamma$。

2. **采样策略**：
   - 使用 `CellBatchSampler` 保持批次内细胞系纯度。
   - 对于支持集编码器，每细胞系采样 $k=32$ 个样本作为支持集。

3. **监控指标**：
   - 训练/验证 AUPR、AUC。
   - 互信息估计值 $\hat{I}(z_I; z_E)$（应下降）。
   - 门控斜率 $w$ 与温度 $T$。
   - 排序损失值 $\mathcal{L}_{\text{rank}}$。

### 第三阶段：推理适配
1. **未知细胞系处理**：
   - 若有 $v_{c'}$：直接计算 $z_E = f_E(v_{c'})$。
   - 若无：从测试细胞系随机抽取 $k$ 个样本作为支持集。
2. **阈值校准**：在验证集上优化决策阈值，最大化F1。

### 第四阶段：失败应对预案
1. **门控饱和**：若 $w \to \infty$（过度锐利），添加L2正则 $\|w\|^2$。
2. **互信息不降**：增加 $\alpha$，或改用HSIC估计。
3. **排序损失数值不稳定**：使用log-sum-exp技巧，或子采样负对。
4. **特征缺失**：若无法获得 $v_c$，完全依赖支持集编码器。

## 预期行为与理论保障

### 成功标志
1. **泛化差距缩小**：训练AUPR ≈ 0.85-0.90，测试AUPR ≥ 0.75，差距 ≤ 0.15。
2. **解耦有效**：$\hat{I}(z_I; z_E) < 0.1$ nats，域对抗准确率 ≈ 随机猜测。
3. **门控学习合理**：$w$ 收敛到正值（放大效应）或负值（抑制效应），符合生物学预期。
4. **排序改善**：Pairwise loss 稳定下降，正负样本得分分离明显。

### 理论优势
1. **假设空间缩减**：门控结构将交互从二次降到 $U_I \cdot \sigma(w R_E)$，降低VC维。
2. **解耦充分性**：$I(z_I; z_E)=0$ 是统计独立的充要条件，强于线性无关。
3. **外推能力**：特征化 $z_E$ 支持连续外推，打破ID嵌入的离散性限制。
4. **任务对齐**：Ranking loss 直接优化AUPR目标，减少代理损失偏差。

### 生物学可解释性
1. $U_I(x)$：序列内在互作倾向，可溯源到转录因子结合位点。
2. $w R_E(c)$：环境调节强度，正值为促进，负值为抑制。
3. $\sigma(w R_E)$：环境允许概率，对应染色质开放概率。
4. $U_I \cdot \sigma(w R_E)$：实际互作强度，序列倾向与环境允许的乘积。

---

**记录点25的本质创新在于将能量耗散从自由交互转向结构化门控，将解耦从线性相关提升到统计独立，将环境表示从离散ID转向连续特征，并将损失从纯分类扩展到排序优化——这是首次系统地将生物学机制假设转化为数学结构约束的尝试。**

