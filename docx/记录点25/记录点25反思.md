# 记录点25 反思文档

## 失败结构定理

**当前方案失败的根本原因是：结构化门控能量网络（SGEN）的数学创新在实现中被稀释，退化为传统的线性能量分解系统；同时，模型容量与正则化强度的不匹配导致了训练细胞系特有模式的记忆，而非学习跨细胞系不变性。**

形式化表述：设 $\mathcal{H}$ 为假设空间，$\mathcal{R}$ 为正则化函数，$L_{\text{task}}$ 为任务损失，$L_{\text{reg}}$ 为正则化损失。实际优化的目标为：

\[
\min_{h \in \mathcal{H}} L_{\text{task}}(h) + \lambda_{\text{reg}} L_{\text{reg}}(h)
\]

其中 $\lambda_{\text{reg}}$ 过小（$\approx 0.1$），而 $\mathcal{H}$ 的 VC 维过高（1300万参数）。这导致解 $h^*$ 过度拟合训练分布 $P_{\text{train}}$，而在测试分布 $P_{\text{test}}$ 上泛化 gap 达到 $\Delta_{\text{gen}} = 0.2954$。

更具体地，方案承诺的四个创新维度在实施中均未充分实现：

1. **门控结构**：承诺 $P(y=1) = \sigma(U_I \cdot \sigma(w R_E) / T)$，实现为 $P(y=1) = \sigma((U_I - R_E)/T)$
2. **互信息解耦**：承诺 $I(z_I; z_E) \rightarrow 0$，实现为 Pearson 相关系数约束（甚至未实现）
3. **特征化环境表示**：承诺 $z_E = f_E(v_c)$ 或支持集聚合，实现为细胞系 ID 嵌入查表
4. **排序损失集成**：承诺 $\mathcal{L}_{\text{rank}}$ 直接优化 AUPR，实现中缺失

## 根因分析

### 数学层面

#### 优化景观的过度平坦性
训练损失从 -0.0939 单调下降至 -1.2517（负损失表明 IMMAX 损失的特性），而 AUPR 从 0.6676 上升至 0.9789。这种极度平滑的下降表明损失景观缺乏鞍点或尖锐极小值，模型可以轻松找到完美拟合训练数据的解。这暗示：

- **数据分离性过强**：训练样本可能被线性可分（在特征空间中），导致模型可以轻易达到接近 1.0 的 AUPR。
- **正则化景观不匹配**：正交损失 ($\lambda=0.1$) 和域对抗损失 ($\lambda=0.1$) 的强度不足以对抗主任务损失 ($\lambda=1.0$) 的驱动。

#### 表征几何的坍缩
设 $z_I \in \mathbb{R}^d$ 为内势特征，$z_E \in \mathbb{R}^d$ 为环境特征。理想情况下应有 $z_I \perp z_E$（正交）且 $I(z_I; z_E)=0$（独立）。实际中：

- **正交性弱约束**：$\mathcal{L}_{\text{orth}} = \|z_I^\top z_E\|_F^2$ 仅约束批次内成对正交，而非全局统计独立。
- **环境特征退化**：$z_E$ 退化为细胞系 ID 的查表函数，缺乏对未知细胞系的泛化能力。

#### 泛化理论的失效
设 $\mathcal{F}$ 为函数类，$\hat{R}_n(\mathcal{F})$ 为经验 Rademacher 复杂度。对于 1300 万参数的深度网络，$\hat{R}_n(\mathcal{F})$ 极高。PAC-Bayes 边界：

\[
L_{\text{test}}(h) \leq L_{\text{train}}(h) + O\left(\sqrt{\frac{\text{VC}(\mathcal{H}) + \ln(1/\delta)}{n}}\right)
\]

其中 VC 维 $\text{VC}(\mathcal{H})$ 过大，样本数 $n=145534$ 不足以控制泛化 gap。

### 算法层面

#### 架构与实现的断层
方案设计的四个核心模块均未充分实现：

1. **门控模块缺失**：代码中仍是线性减法 $U_I - R_E$，而非门控乘法 $U_I \cdot \sigma(w R_E)$。
2. **互信息估计缺失**：未实现 InfoNCE 估计器，解耦仅靠弱正交损失。
3. **环境编码器未更新**：仍使用 `nn.Embedding(num_cell_lines, dim)`，无法外推。
4. **排序损失未集成**：损失函数中未见 pairwise ranking loss。

#### 损失函数的支配关系
总损失 $\mathcal{L} = \mathcal{L}_{\text{task}} + 0.1\mathcal{L}_{\text{orth}} + 0.1\mathcal{L}_{\text{domain}} + 0.01\mathcal{L}_{\text{sparse}}$：
- $\mathcal{L}_{\text{task}}$ 占主导地位（权重 1.0）
- 正则化项权重过低，无法有效约束假设空间
- $\mathcal{L}_{\text{sparse}}$ 鼓励 $R_E \approx 0$，但这与环境阻抗应有的生物学功能矛盾

#### 阈值校准的数学根源
输出概率 $p = \sigma((U_I - R_E)/T)$ 整体偏高，阈值仅需 0.01-0.04 即可达到最佳 F1。这表明：
- $U_I - R_E$ 分布右偏，大多数样本的 logit > 0
- 温度 $T$ 可能过大，未起到校准作用
- 本质上，模型学到了**细胞系不变的正向偏置**，而非特异性互作信号

### 生物学层面

#### 违背染色质状态的门控原理
生物学上，染色质状态对转录因子结合是**阈值门控**：开放则允许，关闭则阻断。线性减法模型 $U_I - R_E$ 隐含假设环境阻抗 $R_E$ 总是**减弱**互作倾向，而生物学中环境可以是**促进**（正 $R_E$）或**抑制**（负 $R_E$）。更严重的是，线性模型允许部分抑制（$0 < R_E < U_I$），而生物学更接近全或无。

#### 忽视细胞系特征的连续性
细胞系间差异源于表观特征的连续变化（DNA甲基化、组蛋白修饰梯度）。ID 嵌入将连续空间离散化，破坏了外推能力。这相当于假设细胞系间是**类别差异**而非**定量差异**。

#### 误用能量耗散类比
物理上，能量耗散 $U_I - R_E$ 描述的是**克服阻力做功**，适用于机械过程。基因调控更接近**化学平衡**：$P_{\text{bind}} \propto [\text{TF}] \times \exp(-\Delta G / kT)$，其中 $\Delta G$ 是结合自由能。当前模型缺乏明确的自由能分解。

## 关键洞察

### 从失败中提取的信息论价值

1. **正则化权重的敏感区间**：当前权重（0.1, 0.1, 0.01）处于**无效区间**。需要探索 $\lambda \in [0.5, 2.0]$ 的量级才能有效约束。
2. **架构创新的实施纪律**：数学创新必须转化为**代码中的强制约束**，而非可选的、弱权重的损失项。
3. **复杂度与数据的匹配原则**：1300万参数 vs 14.5万样本，参数样本比 $\approx 90$，远高于深度学习经验阈值（通常 $< 10$）。必须引入**结构性稀疏**或**参数共享**。

### 失败模式的可检测特征

未来方案应监控以下早期预警信号：
- **训练 AUPR > 0.95**（可能表明过拟合）
- **阈值 < 0.05**（表明概率校准失败）
- **Recall > 0.8 且 Precision < 0.6**（表明分类边界过于宽松）
- **泛化 gap > 0.2**（表明正则化不足）

### 数学结构的可证伪性

好的方案应包含**可证伪的预测**：
- 如果门控结构正确，$w$ 应收敛到正值（促进）或负值（抑制），且分布双峰
- 如果互信息解耦有效，$\hat{I}(z_I; z_E)$ 应降至接近 0
- 如果特征化表示有效，未知细胞系的 $z_E$ 应落在训练细胞系 $z_E$ 的凸包内

## 对下一步的启示

### 必须解决的核心矛盾

1. **创新稀释问题**：确保数学创新转化为架构硬约束，而非软损失。
2. **容量控制问题**：大幅降低模型复杂度，或大幅增强正则化。
3. **外推机制问题**：建立从细胞系特征到 $z_E$ 的连续映射。
4. **排序对齐问题**：直接优化 AUPR 的代理损失。

### 建议的数学方向

1. **流形学习视角**：将细胞系视为连续流形上的点，学习映射 $f: \mathcal{M}_{\text{cell}} \rightarrow \mathbb{R}^d$。
2. **不变风险最小化 (IRM)**：优化 $L_{\text{train}} + \lambda \|\nabla_{w} L_{\text{env}}(w)\|^2$，强制跨环境不变性。
3. **信息瓶颈重构**：最大化 $I(z_I; y)$ 同时最小化 $I(z_I; c)$ 和 $I(z_I; z_E)$。
4. **贝叶斯非参先验**：为细胞系相似性引入高斯过程先验，实现平滑外推。

### 架构设计原则

1. **硬约束优于软约束**：用网络架构强制解耦（如双流正交初始化），而非靠损失函数学习。
2. **连续性优于离散性**：用特征向量替代 ID 嵌入。
3. **乘法交互优于加减法**：门控结构更符合生物学机制。
4. **排序感知优于分类感知**：直接优化 AUPR 的替代损失。

### 失败的价值

本次失败的最大价值在于**证伪了一个重要假设**：在现有正则化强度下，单纯增加数学复杂性（门控、互信息、特征化表示）而不改变架构硬约束，无法突破泛化瓶颈。下一步必须进行**结构性变革**，而非增量改进。