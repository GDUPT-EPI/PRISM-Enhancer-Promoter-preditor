# CBAT 记录点11方案：预测端重构与显式上下文适应 (Explicit Context Adaptation)

## 1. 核心理念：从“盲猜”到“观察-行动”

之前的失败教训表明，OOD (Out-of-Distribution) 泛化不能仅靠训练时的约束，更需要**推理时的显式适应 (Explicit Adaptation at Inference Time)**。

我们的模型（CED-Net）已经具备了从 Batch 上下文中提取环境特征的能力（Student 模块），但在预测时却被“禁言”了。本次方案的核心任务就是**解开 Student 的封印，让其在预测阶段接管环境阻抗 $R_E$ 的生成**。

## 2. 预测流程重构 (The New Inference Pipeline)

我们将彻底摒弃 `predict.py` 中朴素的 `model(x)` 调用方式，改为 **Context-Aware Inference** 流程。

### 2.1 数据流重组：同质化 Batch (Homogeneous Batching)
- **旧逻辑**：`DataLoader` 随机打乱或按顺序读取，Batch 内可能混合了不同细胞系（虽然测试集通常按细胞系分文件，但 sampler 逻辑需保证）。
- **新逻辑**：
  - **强制分组**：在预测前，必须将数据按 `Cell Line` 分组。
  - **大 Batch 采样**：对于每个细胞系，构建足够大的 Batch (N >= 64)，作为 Student 的 Support Set。
  - **全量上下文 (Full Context)**：如果显存允许，甚至可以将该细胞系的所有样本（或随机采样的子集）作为 Context 输入给 Student，以获得最稳定的环境估计。

### 2.2 推理逻辑升级：Student 接管
在 `predict.py` 中实现以下逻辑：

1.  **Step 1: 提取内势 (Intrinsic Potential Extraction)**
    - 输入：Batch 样本 $(E, P)$。
    - 经过 Backbone 得到 $z_I$ 和 $U_I$。
    - 注意：此时 $U_I$ 仅代表序列亲和力，不包含环境信息。

2.  **Step 2: 构建环境上下文 (Context Aggregation)**
    - 将当前 Batch 的 $z_I$ 集合作为 Context。
    - 调用 `model.bypass_generator(z_I)` 得到 $z_F$ (Batch-level features)。
    - **关键**：这里不再是单样本的 $z_F$，而是通过 Student 的机制（如 ISAB 或简单的 Mean Pooling + MLP）聚合得到的 **Batch-level Environment Representation**。

3.  **Step 3: Student 预测阻抗 (Student Resistance Prediction)**
    - 调用 `model.student1(z_I, z_F)`。
    - Student 根据观察到的 Context ($z_F$) 和当前的 Input ($z_I$)，预测出环境阻抗 $R_S$。
    - $R_S$ 应该反映出该细胞系的特异性抑制模式。

4.  **Step 4: 最终决策 (Final Decision)**
    - $P(y=1) = \sigma((U_I - R_S) / T)$。
    - 这样，预测结果就同时包含了序列信息 ($U_I$) 和环境信息 ($R_S$)。

## 3. 代码修改计划

### 3.1 `predict.py` 重写
- **Sampler**：实现 `HomogeneousBatchSampler`，确保每个 Batch 只包含一个细胞系的数据。
- **Inference Loop**：
  - 在 Loop 中显式调用 Student 模块。
  - 增加 `use_student=True` 的开关。
  - 如果是 OOD 细胞系（无 Label），必须使用 Student。
  - 如果是已知细胞系（有 Label），可以对比 Teacher ($R_T$) 和 Student ($R_S$) 的效果，验证 Student 的模仿能力。

### 3.2 `models/PRISMModel.py` 接口微调
- 确保 `forward` 函数在 `cell_labels=None` 时，提供一个参数（如 `inference_mode='student'`）来显式激活 Student 路径，而不是默认回退到 0。
- 或者，提供一个独立的 `predict_step` 方法，专门处理这种复杂的推理逻辑。

## 4. 预期效果

- **打破 0.58 瓶颈**：通过引入 $R_S$，模型不再是“盲猜”，而是根据环境调整阈值。对于抑制性环境，Recall 会下降，Precision 会上升，F1 和 AUPR 将显著改善。
- **验证泛化**：如果 Student 真的学到了“如何从分布中推断环境”，那么在未见细胞系上的表现应接近已知细胞系。

## 5. Todo List
1.  **[High]** 修改 `predict.py`，实现按细胞系分组的 Batch 推理逻辑。
2.  **[High]** 在 `predict.py` 中显式调用 `student1` 获取 $R_S$，并替换默认的 $R_E$。
3.  **[Medium]** 在 `models/PRISMModel.py` 中增加 `predict_with_student` 辅助方法（可选，为了代码整洁）。
4.  **[High]** 运行评估，对比启用 Student 前后的 AUPR 变化。
