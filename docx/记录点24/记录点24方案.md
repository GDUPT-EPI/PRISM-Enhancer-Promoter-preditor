## 核心洞察（一句话）

**当前能量耗散框架的线性可加性假设 $U_I - R_E$ 过于简化，忽略了细胞系环境对序列效应的非线性调节作用；通过引入交互项 $λ U_I R_E$、将正交约束松弛为相关性最小化、并加入稀疏性与分层对比学习，可实现更生物学可信的解耦与泛化。**

## 问题的数学形式化

### 输入与输出空间
- 输入对：$x = (E, P)$ DNA 序列，来自细胞系环境 $c \in \mathcal{C}$。
- 标签：$y \in \{0,1\}$ 表示增强子‑启动子互作。
- 观测分布：$(x,c,y) \sim P_{\text{data}}$。
- 目标：学习条件概率 $\hat{P}(y|x,c)$，使其在未知细胞系 $c' \notin \mathcal{C}_{\text{train}}$ 上泛化，即最小化泛化风险 $\mathbb{E}_{c'\sim Q}[ \mathcal{L}(\hat{P}, P_{\text{true}}) ]$。

### 当前框架的局限性
现有能量耗散模型假设：
\[
P(y=1|x,c) = \sigma\!\left( \frac{U_I(x) - R_E(c)}{T} \right)
\]
其中 $U_I$ 为内势（序列驱动），$R_E$ 为环境阻抗（细胞系抑制），$T$ 为温度。

**数学缺陷**：
1. **可加性假设**：真实生物学中，细胞系环境可能*调节*序列效应，而非简单减法。例如，染色质开放区域可能*放大*特定转录因子结合的作用。这要求建模交互项 $U_I \cdot R_E$。
2. **正交约束过强**：严格正交 $\langle z_I, z_E \rangle = 0$ 可能导致信息丢失或优化困难。更自然的约束是**相关性最小化** $\text{Corr}(z_I, z_E) \to 0$，允许表示在各自子空间内自由旋转。
3. **温度固定**：固定 $T=1.0$ 忽略能量尺度的细胞系间差异。可学习温度 $T(c)$ 可自适应调节灵敏度。
4. **缺乏稀疏性**：高维表示易过拟合。生物学中，仅有少数序列模块与少数细胞系特征决定互作。L1 稀疏可诱导解释性并降低 Rademacher 复杂度。

### 因果图与解耦目标
数据生成遵循因果图：
\[
c \rightarrow x \rightarrow y \quad \text{与} \quad c \rightarrow y
\]
其中 $c$ 影响 $x$（序列变异），也直接影响 $y$（细胞环境）。目标为估计 $x$ 对 $y$ 的**直接因果效应**，控制 $c$ 的后门路径。

定义解耦表示：
- $z_I = f_I(x)$：细胞系不变特征，满足 $p(z_I|c) = p(z_I)$（分布不变）。
- $z_E = f_E(c)$：细胞系特定特征，满足 $I(z_E; c)$ 大而 $I(z_E; y|c)$ 小。

理想解耦应使干预 $c$ 仅改变 $z_E$ 而不影响 $z_I$，干预 $x$ 仅改变 $z_I$ 而不影响 $z_E$。

## 解决方案

### 数学描述

#### 1. 扩展能量公式（非线性交互）
\[
P(y=1|x,c) = \sigma\!\left( \frac{U_I(x) - R_E(c) + \lambda \, U_I(x) \cdot R_E(c)}{T} \right)
\]
其中：
- $U_I = g_I(z_I) \in \mathbb{R}$，内势。
- $R_E = g_E(z_E) \in \mathbb{R}_+$（非负阻抗）。
- $\lambda \in \mathbb{R}$ 为交互系数（可学习，初始值小如 0.1）。
- $T = \text{softplus}(t) > 0$ 为可学习温度。

**生物学解释**：
- $\lambda > 0$：环境阻抗 $R_E$ 放大内势 $U_I$（协同调节）。
- $\lambda < 0$：环境阻抗抑制内势（拮抗调节）。
- $\lambda = 0$：退化为线性可加模型。

#### 2. 表示学习与约束

**双流编码器**：
- $f_I: \mathcal{X} \to \mathbb{R}^{d_I}$（基于 PRISMBackbone），输出 $z_I$。
- $f_E': \mathcal{X} \to \mathbb{R}^{d_E}$（轻量 MLP），输入 Backbone 中间特征，输出环境特征 $e$；对于细胞系 $c$，$z_E = \mathbb{E}_{x \in S_c}[e]$（支持集平均）。

**损失函数体系**：

**主任务损失**（AdaptiveIMMAXLoss）：
\[
\mathcal{L}_{\text{task}} = \text{IMMAX}\!\left( \sigma\!\left( \frac{U_I - R_E + \lambda U_I R_E}{T} \right), y \right)
\]

**相关性解耦损失**（替代正交损失）：
\[
\mathcal{L}_{\text{corr}} = \left( \frac{\mathbb{E}[(z_I - \bar{z}_I)(z_E - \bar{z}_E)]}{\sqrt{\mathbb{E}[(z_I - \bar{z}_I)^2] \mathbb{E}[(z_E - \bar{z}_E)^2] + \epsilon}} \right)^2
\]
其中 $\epsilon=10^{-8}$。最小化 Pearson 相关系数，允许向量方向自由。

**不变性损失**（域对抗）：
通过 GRL 与细胞系分类器 $D: \mathbb{R}^{d_I} \to \Delta^{|\mathcal{C}|}$：
\[
\mathcal{L}_{\text{inv}} = \mathbb{E}_{(x,c)}[ \text{CrossEntropy}(D(\text{GRL}(z_I)), c) ]
\]
目标为最大化分类误差（趋近随机猜测 $1/|\mathcal{C}|$）。

**分层对比学习损失**（替代普通对比）：
对于批次内样本 $(x_i, x_j)$：
- 正对：$c_i = c_j$（同一细胞系）。
- 负对：$c_i \neq c_j$（不同细胞系）。
使用 InfoNCE：
\[
\mathcal{L}_{\text{hcont}} = -\frac{1}{N} \sum_{i=1}^N \log \frac{\sum_{j \neq i} \mathbb{1}_{c_i = c_j} \exp(e_i^\top e_j / \tau)}{\sum_{j \neq i} \exp(e_i^\top e_j / \tau)}
\]
其中 $\tau=0.1$ 为温度超参数。

**稀疏性损失**（L1 正则）：
\[
\mathcal{L}_{\text{sparse}} = \|z_I\|_1 + \|z_E\|_1
\]
鼓励特征稀疏，降低模型复杂度。

**原型一致性损失**（可选）：
\[
\mathcal{L}_{\text{proto}} = \|e - p_c\|^2, \quad p_c \leftarrow \mu p_c + (1-\mu) \mathbb{E}_{x \in S_c}[e]
\]
动量更新原型 $p_c$（$\mu=0.9$）。

**总损失**：
\[
\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}} + \alpha \mathcal{L}_{\text{corr}} + \beta \mathcal{L}_{\text{inv}} + \gamma \mathcal{L}_{\text{hcont}} + \delta \mathcal{L}_{\text{sparse}} + \eta \mathcal{L}_{\text{proto}}
\]
初始权重：$\alpha=0.1, \beta=0.1, \gamma=0.05, \delta=0.01, \eta=0.05$。

#### 3. 优化策略
- **课程学习**：
  1. 前 2 epoch：冻结 $f_E', g_E$，设 $R_E=0, \lambda=0$，只训练 $f_I, g_I$，学习基础序列‑互作关联。
  2. 后续 epoch：解冻所有参数，逐步增加 $\alpha,\beta,\gamma,\delta,\eta$（每 epoch 增加 0.01 至上限 $\alpha=0.2, \beta=0.2, \gamma=0.1, \delta=0.02, \eta=0.1$）。
- **温度学习**：$t$ 初始化为 0，使 $T \approx 1.0$。
- **交互系数**：$\lambda$ 初始化为 0.1，允许正负调节。

#### 4. 采样与推理
- **采样**：使用 `CellBatchSampler` 确保批次内仅含单细胞系样本（纯度保证 $z_E$ 估计稳定）。
- **推理**：对于未知细胞系 $c'$，随机抽取 $m$ 个样本作为支持集计算 $z_E$，然后预测查询集。

### 核心机制

#### 为何交互项能提高泛化？
线性可加模型 $U_I - R_E$ 隐含假设细胞系环境*均匀抑制*所有序列效应。生物学中，环境可能对某些序列模块抑制、对另一些增强。交互项 $λ U_I R_E$ 允许环境对序列效应进行**条件调节**。例如，当 $U_I$ 高（强结合位点）且 $λ>0$ 时，高 $R_E$（抑制性环境）反而*放大*互作概率——这对应“增强子仅在特定细胞系激活”的现象。

数学上，交互项引入**二阶交互**，使模型能表达更复杂的条件依赖，从而减少为拟合训练数据而被迫记住细胞系特异性捷径的需要。

#### 相关性 vs 正交约束
严格正交要求 $z_I \perp z_E$，这可能导致：
1. 优化困难（梯度冲突）。
2. 信息丢失（为满足正交而丢弃有用维度）。

相关性最小化只要求 $\text{Corr}(z_I, z_E)=0$，即线性无关。这允许 $z_I$ 与 $z_E$ 在各自子空间内任意方向，只要它们不存在线性相关。这更易优化且保留更多信息。

#### 稀疏性的泛化益处
L1 正则诱导特征稀疏，等效于降低假设空间的 VC 维。生物学上，仅少数转录因子组合决定互作，稀疏性与之吻合。理论上有：
\[
\mathcal{R}_n(\mathcal{H}) \leq \sqrt{\frac{2 \log(2d) \sum_{i=1}^n \|z^{(i)}\|_1^2}{n}}
\]
其中 $\mathcal{R}_n$ 为 Rademacher 复杂度，$d$ 为特征维数。稀疏特征降低复杂度，从而缩小泛化差距。

#### 分层对比的稳定性
普通对比学习在批次内随机构造正负对，可能因细胞系混合而噪声大。分层对比强制正对来自同一细胞系，负对来自不同细胞系，使学习目标更明确、梯度更稳定。

### 物理/生物对应

1. **交互项 → 染色质环境调制**：DNA 结合蛋白（转录因子）与染色质修饰协同作用。例如，H3K27ac 修饰（环境特征）可增强转录因子（序列特征）的招募效率。交互项 $λ U_I R_E$ 直接模拟这种协同/拮抗。

2. **相关性解耦 → 进化与发育分离**：进化保守的序列模块（$z_I$）与发育调节的染色质状态（$z_E$）在功能上独立但统计相关。相关性最小化允许它们独立变化，符合进化‑发育演化理论。

3. **稀疏性 → 转录因子组合代码**：基因调控由少数关键转录因子组合决定（组合代码）。稀疏 $z_I$ 对应关键序列模体，稀疏 $z_E$ 对应关键染色质标记。

4. **可学习温度 → 细胞系特异性灵敏度**：不同细胞系对能量差的响应灵敏度不同（如染色质压实度差异）。可学习 $T(c)$ 自适应调节 Sigmoid 斜率。

5. **分层对比 → 细胞类型身份**：同一细胞系内样本共享染色质景观，不同细胞系间景观迥异。分层对比强制模型捕获这种宏观差异。

## 实施路线图

### 第一阶段：架构修改
1. **修改 `PRISMModel.py`**：
   - 增加交互项参数 $\lambda$（`nn.Parameter(torch.tensor(0.1))`）。
   - 将正交损失替换为相关性损失。
   - 增加 L1 稀疏损失项。
   - 实现分层对比损失（需访问细胞系标签）。
   - 将固定温度改为可学习参数 $t$（`nn.Parameter(torch.tensor(0.0))`）。
2. **调整采样器**：确保 `CellBatchSampler` 生效，批次大小 64，支持集大小 32。
3. **损失调度器**：实现课程学习与损失权重渐进增加。

### 第二阶段：训练与监控
1. **课程学习**：前 2 epoch 冻结环境部分，仅训练序列部分。
2. **监控指标**：
   - 训练/验证 AUPR、AUC、F1。
   - 相关性损失值（应趋近 0）。
   - 域对抗分类准确率（应趋近随机猜测，约 16.7%）。
   - 稀疏度（$|z_I|_0/d_I$ 与 $|z_E|_0/d_E$）。
   - 温度 $T$ 与交互系数 $\lambda$ 的值。
3. **早停策略**：若验证 AUPR 连续 3 epoch 不升，则停止。

### 第三阶段：推理适配
1. **支持集构建**：对于测试细胞系，随机抽取 $m=32$ 个样本计算 $z_E$。
2. **阈值校准**：在验证集上优化决策阈值，平衡 Recall‑Precision。

## 预期行为与失败应对

### 成功标志
- 训练 AUPR 稳定上升至 0.85‑0.90（避免 >0.95 的过拟合）。
- 验证 AUPR 与训练 AUPR 差距 ≤ 0.15。
- 相关性损失快速下降至 $<10^{-3}$。
- 域对抗准确率低于 30%。
- 测试 AUPR ≥ 0.75，Recall 与 Precision 平衡（0.6‑0.8）。

### 失败边界与应对
1. **交互项导致训练发散**：减小 $\lambda$ 初始化值（如 0.01），或添加权重衰减。
2. **相关性损失不降**：增加 $\alpha$ 权重，或改用互信息估计。
3. **稀疏性损害性能**：降低 $\delta$ 或改用 L2 正则。
4. **温度坍缩**（$T \to 0$ 或 $T \to \infty$）：对 $t$ 加 L2 惩罚，或约束 $T \in [0.5, 2.0]$。
5. **过拟合依然严重**：增加 Dropout（0.3）、权重衰减（1e-3），或提前停止。

### 退路方案
若扩展能量公式优化困难，可退化为**线性交互**：
\[
P(y=1|x,c) = \sigma\!\left( \frac{U_I + \lambda_U U_I \cdot z_E + \lambda_R z_E}{T} \right)
\]
其中 $z_E$ 直接作为调节向量。这保持交互思想但简化优化。

---
**记录点24的本质创新在于将能量耗散从线性可加推广到条件调节，并用相关性最小化、稀疏性、分层对比等几何与信息论约束，实现更稳健、更生物学可信的解耦泛化。**