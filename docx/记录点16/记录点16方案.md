# CBAT 记录点16方案：图约束分层变分推断与信息瓶颈解耦

## 核心洞察（一句话）
**细胞系在高维生物学空间中形成连续流形，而非离散孤立点；通过图卷积网络编码细胞系相似性作为分层先验，结合信息瓶颈强制特征解耦，可同时解决过拟合与泛化问题。**

## 问题的数学形式化

### 符号定义
- 输入序列对：$x = (E, P) \in \mathcal{X}$
- 细胞系标签：$c \in \mathcal{C}_{\text{known}}$（已知集合）或 $c \in \mathcal{C}_{\text{unknown}}$（未知）
- 细胞系图：$\mathcal{G} = (\mathcal{V}, \mathcal{E})$，节点 $v_i \in \mathcal{V}$ 对应细胞系，边权重 $w_{ij} \in \mathbb{R}^+$ 表示相似性
- 内势潜变量：$z_I \in \mathbb{R}^d$（特征表示）
- 环境阻抗潜变量：$z_E \in \mathbb{R}^+$（非负标量）
- 图网络参数：$\theta_G$

### 生成模型（分层贝叶斯）

$$
\begin{aligned}
\text{超先验} & : p(\theta_G) = \mathcal{N}(0, I) \\
\text{细胞系参数} & : \phi_c = f_{\theta_G}(c, \mathcal{G}) \quad \text{(图卷积输出)} \\
\text{先验} & : p(z_E | c, \theta_G) = \mathcal{N}(\mu_{\phi_c}, \sigma_{\phi_c}^2) \\
\text{特征生成} & : p(z_I | x) = \mathcal{N}(\mu_{\psi}(x), \sigma_{\psi}^2(x)) \\
\text{内势} & : U_I = g(z_I) \quad (g: \mathbb{R}^d \to \mathbb{R}) \\
\text{标签生成} & : p(y | z_I, z_E) = \text{Bernoulli}\left(\sigma\left(\frac{U_I - z_E}{T}\right)\right) \\
\text{联合分布} & : p(x, y, z_I, z_E, c, \theta_G) = p(\theta_G) p(c) p(z_E | c, \theta_G) p(x) p(z_I | x) p(y | z_I, z_E)
\end{aligned}
$$

### 推断模型
- 特征后验：$q(z_I | x) = \mathcal{N}(\mu_{\psi}(x), \sigma_{\psi}^2(x))$（编码器）
- 阻抗后验：$q(z_E | x, c, \theta_G) = \mathcal{N}(\mu_{\phi}(x, c), \sigma_{\phi}^2(x, c))$（依赖细胞系先验）
- 图参数后验：$q(\theta_G | \mathcal{D}_{\text{train}}) \approx \delta(\hat{\theta}_G)$（点估计）

### 信息瓶颈约束
1. **细胞系无关性**：最小化 $I(z_I; C)$，迫使 $z_I$ 丢弃细胞系信息
2. **标签相关性**：最大化 $I(z_I; Y)$，保留互作预测信息
3. **阻抗特异性**：最大化 $I(z_E; C)$，确保 $z_E$ 编码细胞系特异性

形式化：
$$
\min_{\psi} \left[ I(z_I; C) - \beta I(z_I; Y) \right], \quad \max_{\phi} I(z_E; C)
$$

### 训练目标（已知细胞系）
分层证据下界（H-ELBO）：
$$
\begin{aligned}
\mathcal{L}_{\text{H-ELBO}} = & \mathbb{E}_{q(z_I|x)q(z_E|x,c)}[\log p(y | z_I, z_E)] \\
& - \beta_1 \text{KL}(q(z_I|x) \parallel p(z_I|x)) \\
& - \beta_2 \text{KL}(q(z_E|x,c) \parallel p(z_E|c, \theta_G)) \\
& - \beta_3 \text{KL}(q(\theta_G) \parallel p(\theta_G))
\end{aligned}
$$

加上信息瓶颈正则：
$$
\mathcal{L}_{\text{IB}} = \lambda_1 \widehat{I}(z_I; C) - \lambda_2 \widehat{I}(z_I; Y) - \lambda_3 \widehat{I}(z_E; C)
$$
其中 $\widehat{I}$ 为互信息估计器（基于神经估计器如InfoNCE）。

总损失：
$$
\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{H-ELBO}} + \mathcal{L}_{\text{IB}} + \lambda_{\text{sparse}} \|z_E\|_1
$$

### 未知细胞系推断
给定新细胞系 $c_{\text{new}}$，无先验 $p(z_E | c_{\text{new}}, \theta_G)$。但可通过图插值获得：
$$
\phi_{\text{new}} = f_{\theta_G}(c_{\text{new}}, \mathcal{G}_{\text{ext}})
$$
其中 $\mathcal{G}_{\text{ext}}$ 为扩展图（将 $c_{\text{new}}$ 作为新节点连接到K近邻已知细胞系）。

再通过少样本自监督适应：
$$
\min_{z_E^{(i)}} \sum_{i=1}^M \mathcal{L}_{\text{consistency}}(x_i, z_E^{(i)})
$$
一致性损失鼓励同一细胞系内样本的阻抗分布相似。

## 解决方案

### 数学描述

#### 1. 细胞系图构建
- **节点特征**：每个细胞系 $c_i$ 对应特征向量 $h_i \in \mathbb{R}^m$，可来自：
  - 先验知识：基因表达谱、染色质可及性
  - 数据驱动：从训练集样本特征均值提取
- **边权重**：余弦相似性 $w_{ij} = \frac{h_i \cdot h_j}{\|h_i\|\|h_j\|}$，阈值化保留 top-K 邻居
- **图卷积网络（GCN）**：$H^{(l+1)} = \sigma(\tilde{D}^{-1/2}\tilde{A}\tilde{D}^{-1/2} H^{(l)} W^{(l)})$，输出 $\phi_c \in \mathbb{R}^2$（先验参数）

#### 2. 分层变分推断
- **超网络**：$f_{\theta_G}: \mathcal{V} \to \mathbb{R}^2$，输入细胞系节点特征，输出 $(\mu_c, \log\sigma_c)$
- **阻抗编码器**：$q(z_E|x,c)$ 接受 $[z_I, \phi_c]$ 拼接，输出后验参数 $(\mu_x, \sigma_x)$
- **后验融合**：乘积专家（PoE）结合先验 $\mathcal{N}(\mu_c, \sigma_c^2)$ 与似然 $\mathcal{N}(\mu_x, \sigma_x^2)$

#### 3. 信息瓶颈实现
- **互信息估计**：使用 InfoNCE 对比估计器
  - $I(z_I; C) \approx \mathbb{E}[\log \frac{\exp(s(z_I, c))}{\sum_{c'}\exp(s(z_I, c'))}]$，其中 $s$ 为评分函数
  - $I(z_I; Y)$ 类似，但 $Y$ 为二元标签
- **对抗训练**：对于 $z_I \perp C$，使用梯度反转层（GRL）+ 细胞系判别器
- **最大化 $I(z_E; C)$**：鼓励 $z_E$ 可预测细胞系（使用辅助分类器）

#### 4. 自监督适应
对未知细胞系 $c_{\text{new}}$ 的 $M$ 个无标签样本 $\{x_i\}$：
- **原型计算**：$\bar{z}_I = \frac{1}{M}\sum_i \mu_{\psi}(x_i)$
- **图插值**：$\phi_{\text{new}} = \text{GCN-Interpolate}(c_{\text{new}}, \mathcal{G})$
- **一致性损失**：$\mathcal{L}_{\text{consistency}} = \sum_i \|\mu_{\phi}(x_i, \phi_{\text{new}}) - \bar{z}_E\|^2$，其中 $\bar{z}_E$ 为样本阻抗均值

### 核心机制

#### 1. 图先验的归纳偏置
- **平滑性假设**：相似细胞系具有相似环境阻抗分布
- **数据效率**：即使某个细胞系样本少，也可借助相似细胞系的信息
- **泛化能力**：对新细胞系，通过图插值获得合理先验，而非随机初始化

#### 2. 分层结构的正则化效果
- **超参数共享**：$\theta_G$ 在所有细胞系间共享，防止过拟合单个细胞系
- **贝叶斯收缩**：细胞系特定参数 $\phi_c$ 向图结构定义的均值收缩
- **不确定性传播**：图参数的不确定性传播到先验，增加鲁棒性

#### 3. 信息瓶颈的解耦保证
- **最小充分统计量**：$z_I$ 仅保留预测 $Y$ 所需信息，丢弃细胞系信息
- **角色分离**：$z_I$ 负责序列固有亲和力，$z_E$ 负责环境特异性
- **理论保证**：在理想情况下，$z_I \perp C$，$z_E \not\perp C$，实现完美解耦

#### 4. 自监督适应的可行性
- **聚类假设**：同一细胞系的样本在特征空间聚集
- **分布匹配**：通过一致性损失对齐样本阻抗与细胞系原型
- **无需标签**：仅需未标记样本即可适应，符合真实场景

### 物理/生物对应

#### 1. 细胞系图 → 进化与发育关系
- **边权重**：对应细胞系间的发育距离或转录组相似性
- **图卷积**：模拟细胞类型间信号传递（旁分泌、发育路径）
- **生物学意义**：发育上相近的细胞类型共享染色质组织模式

#### 2. 分层先验 → 群体遗传学结构
- **超先验 $\theta_G$**：对应物种水平的染色质组织保守性
- **细胞系参数 $\phi_c$**：对应群体中个体的表观遗传变异
- **类比**：如同群体遗传学中的 $F_{\text{ST}}$ 统计量，衡量群体间分化程度

#### 3. 信息瓶颈 → 转录因子结合特异性
- **$z_I$（细胞系无关）**：对应转录因子固有的DNA结合亲和力（由结合位点序列决定）
- **$z_E$（细胞系相关）**：对应染色质环境、共因子可用性、表观遗传修饰
- **生物学现实**：同一转录因子在不同细胞类型中结合不同位点，既受序列影响也受环境影响

#### 4. 自监督适应 → 细胞可塑性
- **少样本适应**：模拟细胞在微环境变化下的表观遗传重编程
- **一致性损失**：对应细胞身份维持机制（维持稳定的基因表达模式）
- **现实意义**：细胞移植、重编程实验中观察到的快速适应现象

## 架构设计

### 模块清单

#### 1. 细胞系图编码器 (CellLineGraphEncoder)
```python
class CellLineGraphEncoder(nn.Module):
    def __init__(self, num_cell_lines, feature_dim=128, hidden_dim=256):
        # 节点特征初始化（可学习或预计算）
        self.node_emb = nn.Embedding(num_cell_lines, feature_dim)
        # GCN层
        self.gcn1 = GCNConv(feature_dim, hidden_dim)
        self.gcn2 = GCNConv(hidden_dim, hidden_dim)
        # 输出投影
        self.mu_proj = nn.Linear(hidden_dim, 1)
        self.logsigma_proj = nn.Linear(hidden_dim, 1)

    def forward(self, cell_ids, adj_matrix):
        # adj_matrix: [N, N] 邻接矩阵
        h = self.node_emb(cell_ids)  # [B, feature_dim]
        h = F.relu(self.gcn1(h, adj_matrix))
        h = self.gcn2(h, adj_matrix)
        mu = self.mu_proj(h)  # [B, 1]
        log_sigma = self.logsigma_proj(h)  # [B, 1]
        sigma = F.softplus(log_sigma) + 1e-6
        return mu, sigma
```

#### 2. 信息瓶颈模块 (InformationBottleneck)
```python
class InformationBottleneck(nn.Module):
    def __init__(self, z_dim, c_dim, y_dim=2):
        # 互信息估计器
        self.info_estimator_zc = InfoNCE(z_dim, c_dim)  # I(z; C)
        self.info_estimator_zy = InfoNCE(z_dim, y_dim)  # I(z; Y)
        # 对抗判别器
        self.cell_discriminator = nn.Linear(z_dim, c_dim)

    def compute_mi_loss(self, z, c, y):
        mi_zc = self.info_estimator_zc(z, c)  # 需要最小化
        mi_zy = self.info_estimator_zy(z, y)  # 需要最大化
        return mi_zc - mi_zy
```

#### 3. 分层阻抗编码器 (HierarchicalImpedanceEncoder)
```python
class HierarchicalImpedanceEncoder(nn.Module):
    def __init__(self, zI_dim, prior_dim=2, hidden_dim=128):
        # 输入: z_I + 先验参数(μ_c, σ_c)
        self.encoder = nn.Sequential(
            nn.Linear(zI_dim + prior_dim, hidden_dim),
            nn.ReLU(),
            nn.Linear(hidden_dim, hidden_dim),
            nn.ReLU(),
            nn.Linear(hidden_dim, 2)  # 输出 (μ_x, logσ_x)
        )

    def forward(self, z_I, mu_prior, sigma_prior):
        # 拼接特征
        x = torch.cat([z_I, mu_prior, sigma_prior], dim=-1)
        mu_logsigma = self.encoder(x)
        mu_x, log_sigma_x = mu_logsigma.chunk(2, dim=-1)
        sigma_x = F.softplus(log_sigma_x) + 1e-6
        return mu_x, sigma_x
```

### 训练流程

#### 阶段1：图预训练（可选）
- 使用先验生物学数据或训练集特征均值构建细胞系图
- 预训练GCN，使得相似细胞系节点接近

#### 阶段2：联合训练
1. **采样**：同质化批次（同一细胞系）
2. **特征提取**：$z_I \sim q(z_I|x)$
3. **图先验**：$(\mu_c, \sigma_c) = \text{GCN}(c, \mathcal{G})$
4. **阻抗推断**：$(\mu_x, \sigma_x) = \text{Encoder}(z_I, \mu_c, \sigma_c)$
5. **后验融合**：PoE得到 $(\mu_{\text{fused}}, \sigma_{\text{fused}})$
6. **采样预测**：$z_E \sim \mathcal{N}(\mu_{\text{fused}}, \sigma_{\text{fused}}^2)$，计算概率
7. **损失计算**：$\mathcal{L}_{\text{H-ELBO}} + \mathcal{L}_{\text{IB}} + \mathcal{L}_{\text{sparse}}$

#### 阶段3：未知细胞系模拟训练
- 每epoch随机屏蔽部分细胞系作为"未知"
- 使用图插值获得先验，自监督适应

### 推理流程

#### 已知细胞系
- 直接使用GCN生成的先验，正常推断

#### 未知细胞系
1. **图扩展**：将新细胞系作为节点连接到K近邻已知细胞系
2. **先验插值**：$\phi_{\text{new}} = \text{GCN}(c_{\text{new}}, \mathcal{G}_{\text{ext}})$
3. **少样本适应**：用该细胞系的样本计算一致性损失，更新阻抗后验（仅推理时微调编码器）
4. **预测**：使用适应后的模型预测

## 预期优势

### 1. 理论优势
- **分层贝叶斯**：更强的正则化，防止先验过拟合
- **图归纳偏置**：利用细胞系间相似性，提升数据效率
- **信息理论解耦**：保证 $z_I$ 与 $z_E$ 的角色分离

### 2. 实用优势
- **可解释性**：细胞系图可视，阻抗与先验参数可解释
- **灵活性**：支持不同程度的细胞系相似性先验
- **鲁棒性**：对少量样本细胞系更稳定

### 3. 泛化优势
- **图插值**：对新细胞系提供合理初始先验
- **自监督适应**：无需标签即可适应未知分布
- **连续流形**：避免离散ID的局限性

## 风险与缓解

### 风险1：图构建不准确
- **缓解**：多源数据融合（表达、可及性、训练特征）；可学习边权重；鲁棒GCN架构

### 风险2：互信息估计方差大
- **缓解**：使用更稳定的估计器（如MINE）；梯度裁剪；多批次平均

### 风险3：计算复杂度增加
- **缓解**：小图（仅细胞系节点）；稀疏邻接矩阵；GCN层数≤2

### 风险4：自监督适应不稳定
- **缓解**：原型动量更新；温度退火；早停策略

## 与历史方案的区别

### vs 记录点14-15（变分贝叶斯）
- **先验**：离散ID → 图结构连续流形
- **正则化**：单层KL → 分层KL + 信息瓶颈
- **解耦**：对抗训练 → 信息理论保证
- **适应**：贝叶斯更新 → 图插值 + 自监督

### vs 记录点7-13（元学习/竞争）
- **框架**：竞争博弈 → 合作图学习
- **目标**：任务泛化 → 结构泛化
- **先验**：无显式先验 → 图先验
- **一致性**：训练/推理任务对齐

### 核心创新点
1. **细胞系图先验**：首次引入图结构编码细胞系关系
2. **分层变分推断**：解决先验过拟合问题
3. **信息瓶颈解耦**：理论保证的特征解耦
4. **图插值适应**：对新细胞系的平滑泛化

## 实现步骤概要

1. **数据准备**：收集/计算细胞系特征，构建邻接矩阵
2. **模块实现**：`CellLineGraphEncoder`, `InformationBottleneck`, `HierarchicalImpedanceEncoder`
3. **模型集成**：在`PRISMModel.py`中集成新模块，修改`forward`与损失计算
4. **训练脚本**：修改`PRISM.py`支持分层训练、信息瓶颈损失
5. **推理扩展**：修改`predict.py`支持图插值与自监督适应
6. **超参数调优**：$\beta_1,\beta_2,\beta_3,\lambda_1,\lambda_2,\lambda_3$等

## 数学验证点

### 需要验证的定理/不等式
1. **解耦充分条件**：当 $\lambda_1 \to \infty$，$\lambda_3 \to \infty$ 时，$z_I \perp C$，$z_E \not\perp C$
2. **泛化界**：基于图拉普拉斯正则化的Rademacher复杂度界
3. **信息瓶颈最优性**：在率失真意义下的最优表示

### 实验验证指标
1. **解耦度**：$I(z_I; C)$（应小），$I(z_E; C)$（应大）
2. **图平滑性**：相邻细胞系阻抗分布KL散度（应小）
3. **泛化gap**：训练集vs测试集AUPR差（目标<0.1）

---

**哲学思考**：生物学中的相似性不是离散分类，而是连续流形。我们的模型应该反映这一本质——通过图结构捕捉细胞系间的连续关系，通过信息瓶颈分离通用机制与特异适应。这不仅是算法改进，更是对生物学现实的更忠实建模。