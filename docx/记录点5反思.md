# 记录点5反思：极端鲁棒性的代价与物理建模的缺失

## 1. 现象回顾

在记录点4和5的尝试中，我们观察到了一个极端的现象：

*   **AUPR 和 AUC 显著提升**：在大多数细胞系上，AUPR 和 AUC 均有明显提升，甚至在 Stomach 细胞系上 AUPR 达到了 0.71+。
*   **置信度严重漂移**：模型的输出概率分布发生了剧烈变化，绝大多数预测值都非常接近 0 或 1。这导致在固定阈值（如 0.5）下的 Recall 和 Precision 极度失衡（例如 Recall ≈ 1.0, Precision ≈ 0.5）。
*   **回退方案无效**：方案5试图通过简单的逻辑回退来修复这个问题，但并未触及根本原因，因此未产生实质性改进。

## 2. 深度归因：为什么会出现这种情况？

### 2.1 能量算子 ($U_I$) 的无界性与非概率性

我们在方案4中引入了 `FourierEnergyKAN` 来计算“内势” $U_I$，并直接将其作为 Logits 输出：

```python
# models/PRISMModel.py
U_I = self.U_I_generator(z_I)
logits = U_I
prob = torch.sigmoid(logits)
```

**问题在于**：$U_I$ 被设计为一个物理势能，其取值范围在理论上是无界的 $(-\infty, +\infty)$。而传统的 Logits 经过 Sigmoid 后代表概率。
当我们将无界的物理势能直接通过 Sigmoid 映射为概率时，稍微偏离 0 的势能值就会导致 Sigmoid 饱和（输出接近 0 或 1）。
这解释了为什么模型置信度极高：**物理势能的标度与概率空间的 Logits 标度不匹配**。

### 2.2 域对抗训练的副作用：过度解耦

我们使用了 GRL（Gradient Reversal Layer）和域判别器来强迫 $z_I$ 剔除细胞系信息：

```python
# models/PRISMModel.py
z_I_reversed = grad_reverse(z_I, alpha=1.0)
domain_logits = self.domain_discriminator(z_I_reversed)
```

**后果**：虽然 $z_I$ 确实变得更加“纯粹”且与环境无关，但这导致模型丧失了利用微弱的环境线索来调整预测的能力。
在生物学上，Enhancer-Promoter 互作确实受到环境（如转录因子浓度、染色质开放性）的强烈影响。
**强制剔除环境信息，实际上是在强迫模型只看 DNA 序列本身。**
既然 DNA 序列在所有细胞系中都是一样的，模型自然倾向于给出一个“普适”的预测，这在统计上表现为 Ranking 能力（AUPR/AUC）的提升（因为序列本身的物理亲和力是真实存在的且鲁棒的），但却牺牲了特异性（Specificty）。

### 2.3 与标准 Cross Attention 的本质区别

*   **标准 Cross Attention**：
    *   机制：$Attention(Q, K, V)$。
    *   逻辑：Query（Enhancer）去“寻找”匹配的 Key（Promoter）。这是一个**模式匹配**过程。
    *   特点：依赖于特征的相似度。如果特征中包含了环境噪音，匹配就会不准。但它保留了所有的信息。

*   **CBAT (方案4/5)**：
    *   机制：$U_I - R_E$ （虽然方案4代码中并未完全实现 $R_E$ 的减法，但核心思想是势能驱动）。
    *   逻辑：计算序列的“内势”。这是一个**物理属性预测**过程。
    *   特点：通过对抗训练清洗了环境信息。
    *   **区别**：标准 Cross Attention 是在**比较**两个序列，而 CBAT 是在**测量**两个序列的物理属性。

**为什么 AUPR 提升？** 因为“物理属性”比“模式匹配”更稳定。即使在未见细胞系，物理属性（序列亲和力）是不变的。
**为什么 Precision 下降？** 因为模型过于自信地认为“只要物理上能结合，就一定会结合”，而忽略了环境中可能存在的抑制因子（$R_E$ 缺失或未生效）。

## 3. 方案5为何无效？

方案5仅仅是在方案4的基础上试图做一些修补，但没有解决核心矛盾：
1.  **$U_I$ 的标度问题**：依然直接用势能当 Logits。
2.  **$R_E$ 的缺失**：虽然理论上提出了 $U_I - R_E$，但在代码实现中，重点放在了 $U_I$ 的纯化上，而忽略了 $R_E$（环境阻抗）的有效建模。没有 $R_E$ 来“抑制” $U_I$，预测结果自然会有极高的假阳性（High Recall, Low Precision）。

## 4. 启示：通往鲁棒性的正确道路

方案4/5 的极端实验告诉我们：
1.  **序列物理属性（内势）是鲁棒性的基石**。这一点必须保留。
2.  **环境信息不能丢，只能分离**。我们不能只通过对抗训练把环境信息扔掉，而是应该把它分离出来，建模为“阻抗”。
3.  **物理模型需要校准**。不能直接把势能塞进 Sigmoid，需要一个可学习的温度系数或缩放因子来对齐概率空间。

## 5. 结论

**CBAT 的未来在于实现完整的“能量耗散系统”：**
$$ P(y=1) = \sigma\left( \frac{U_I(Seq) - R_E(Env)}{Temperature} \right) $$

我们需要：
1.  保留 $U_I$ 的对抗训练，确保它只关注序列。
2.  **必须引入 $R_E$ 模块**，专门读取细胞系特定的环境上下文（如果有的话，或者通过 Manifold Mixup 模拟）。
3.  **引入温度系数**，解决置信度过高的问题。

这将是记录点6的核心方向。
