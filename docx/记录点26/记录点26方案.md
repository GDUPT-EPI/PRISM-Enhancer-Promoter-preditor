# 记录点26 方案：稀疏特征调制网络 (Sparse Feature Modulation Network, SFMN)

## 核心洞察（一句话）

**细胞系环境对EP互作的调节本质上是稀疏特征选择——染色质状态通过门控向量 $g_c \in [0,1]^d$ 选择性地暴露或掩蔽序列特征中的基序；通过细胞系连续编码、稀疏门控生成与交换对齐损失，可实现可解释、可外推的细胞系不变性学习。**

## 问题的数学形式化

### 输入与输出空间
- 输入序列对：$x = (E, P) \in \mathcal{X}$，DNA序列。
- 细胞系标签：$c \in \mathcal{C}$，但假设存在（或可学习）连续特征 $v_c \in \mathbb{R}^m$。
- 标签：$y \in \{0,1\}$ 表示EP互作。
- 观测分布：$(x,c,y) \sim P_{\text{data}}$。
- 测试细胞系：$\mathcal{C}_{\text{test}} \cap \mathcal{C}_{\text{train}} = \emptyset$。

### 生物学机制假设
1. **序列特征基序库**：DNA序列蕴含一组潜在的转录因子结合基序，编码为特征向量 $z = \phi(x) \in \mathbb{R}^d$。
2. **细胞系特异性特征可及性**：细胞系 $c$ 的染色质状态决定哪些基序在物理上可及。这对应一个**稀疏门控向量** $g_c \in [0,1]^d$，其中 $g_{c,i}$ 表示基序 $i$ 在细胞系 $c$ 中的可及性。
3. **调制后特征**：实际起作用的特征为 $z \odot g_c$（逐元素乘法）。不可及基序 ($g_{c,i} \approx 0$) 被掩蔽。
4. **细胞系连续性**：细胞系间差异是表观特征的连续变化，因此 $v_c$ 连续且 $g_c = f(v_c)$ 平滑。
5. **稀疏性**：每个细胞系只调节少数基序的可及性 ($\|g_c\|_0 \ll d$)。

### 当前框架的数学缺陷（继承自记录点25及历史）
1. **解耦的任意性**：$U_I$ 与 $R_E$ 的分解缺乏生物学基础，解耦不唯一。
2. **交互的过度参数化**：线性加减或乘法门控引入自由参数，易被滥用拟合噪声。
3. **环境表示的离散性**：ID 嵌入破坏连续性，无法外推。
4. **不变性学习的间接性**：通过损失函数（正交、对抗）间接鼓励不变性，而非架构强制。

## 解决方案

### 数学描述

#### 1. 稀疏特征调制架构
定义三个核心模块：

**序列编码器**：$\phi: \mathcal{X} \rightarrow \mathbb{R}^d$，映射序列对到 $d$ 维特征。
\[
z = \phi(x) \in \mathbb{R}^d
\]

**细胞系编码器**：$\psi: \mathcal{C} \rightarrow \mathbb{R}^m$，映射细胞系到连续特征。
- 若有显式表观特征 $v_c$：$\psi(c) = \text{MLP}(v_c)$
- 若无：$\psi(c) = \text{AttnPool}(\{\phi(x_i) \mid x_i \in S_c\})$，$S_c$ 为 $c$ 的支持集样本

**稀疏门控生成器**：$f: \mathbb{R}^m \rightarrow [0,1]^d$，生成稀疏门控向量。
\[
g_c = \sigma(\text{MLP}(\psi(c))) \quad \text{（基础）}
\]
为鼓励稀疏性，实际使用：
\[
g_c = \text{Sparsemax}(\text{MLP}(\psi(c)))
\]
其中 Sparsemax 是稀疏 softmax 变体，输出稀疏概率向量。

**调制与预测**：
\[
z_{\text{mod}} = z \odot g_c \quad \text{（逐元素乘法）}
\]
\[
P_\theta(y=1|x,c) = \sigma(\text{MLP}_{\text{class}}(z_{\text{mod}}))
\]

#### 2. 交换对齐损失（Swap Alignment Loss）
强制**细胞系不变性**：对于相同互作状态 $y$，不同细胞系下的调制特征应对齐。

设批次中包含样本 $(x_i, c_i, y_i)$ 和 $(x_j, c_j, y_j)$，$y_i = y_j$。定义对齐损失：
\[
\mathcal{L}_{\text{align}} = \mathbb{E}_{(i,j): y_i=y_j} \left[ \| z_i \odot g_{c_i} - z_j \odot g_{c_j} \|^2 \right]
\]
直觉：如果两个样本都是互作 ($y=1$)，尽管细胞系不同，它们的调制特征应相似（都富含"活跃基序"）。

为计算效率，在批次内实现：对于每个 anchor 样本 $i$，采样正对 $j$（同 $y$）和负对 $k$（不同 $y$），使用对比形式：
\[
\mathcal{L}_{\text{align-contrast}} = -\log \frac{\exp(-d(z_i \odot g_{c_i}, z_j \odot g_{c_j})/\tau)}{\sum_{k \neq i} \exp(-d(z_i \odot g_{c_i}, z_k \odot g_{c_k})/\tau)}
\]
其中 $d(u,v) = \|u-v\|^2$。

#### 3. 稀疏性正则化
鼓励门控向量稀疏，符合生物学（少数基序被调节）：
\[
\mathcal{L}_{\text{sparse}} = \frac{1}{|\mathcal{C}_{\text{batch}}|} \sum_{c \in \mathcal{C}_{\text{batch}}} \|g_c\|_1
\]

同时，为避免过度稀疏导致特征完全掩蔽，加入熵正则：
\[
\mathcal{L}_{\text{entropy}} = - \frac{1}{|\mathcal{C}_{\text{batch}}|} \sum_{c \in \mathcal{C}_{\text{batch}}} \sum_{i=1}^d g_{c,i} \log(g_{c,i} + \epsilon)
\]

#### 4. 平滑性约束（细胞系流形平滑）
对于相似细胞系 $c, c'$（基于 $v_c, v_{c'}$ 距离），门控向量应相似：
\[
\mathcal{L}_{\text{smooth}} = \mathbb{E}_{c,c'} \left[ \exp(-\|v_c - v_{c'}\|^2/\sigma^2) \cdot \|g_c - g_{c'}\|^2 \right]
\]

#### 5. 主任务损失
使用 AdaptiveIMMAXLoss（继承现有）：
\[
\mathcal{L}_{\text{task}} = \mathcal{L}_{\text{IMMAX}}
\]

#### 6. 总损失函数
\[
\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}} + \alpha \mathcal{L}_{\text{align}} + \beta \mathcal{L}_{\text{sparse}} + \gamma \mathcal{L}_{\text{entropy}} + \delta \mathcal{L}_{\text{smooth}}
\]
初始权重：$\alpha=0.5, \beta=0.1, \gamma=0.05, \delta=0.1$。

### 核心机制

#### 1. 为什么特征调制优于能量分解？
能量分解 $U_I - R_E$ 隐含假设环境效应是**全局标量偏置**，作用于所有序列特征同等。生物学上，环境调节是**特征选择**：某些基序被掩蔽，其他保持活跃。逐元素门控 $z \odot g_c$ 实现此选择，更精细且可解释。

数学上，调制将假设空间从 $\{U_I(x) - R_E(c)\}$ 限制到 $\{\langle w, \phi(x) \odot f(\psi(c)) \rangle\}$，其中 $f$ 是稀疏映射。这减少了自由度，同时保留了必要的灵活性。

#### 2. 交换对齐如何强制不变性？
传统域对抗尝试去除 $z$ 中 $c$ 的信息，但可能去除过多（包括与 $y$ 相关的）。交换对齐强制**给定 $y$ 时 $z \odot g_c$ 的分布不变**。即，不同细胞系中，正样本的调制特征应相似，负样本的调制特征也应相似。这保留了细胞系信息在 $g_c$ 中，但强制 $z \odot g_c$ 与 $c$ 条件独立于 $y$。

形式上，目标是最小化条件互信息 $I(z \odot g_c; c \mid y)$。

#### 3. 稀疏性的双重好处
- **可解释性**：每个门控维度对应一个基序，稀疏性表明该基序只在部分细胞系中重要。
- **泛化提升**：稀疏门控降低了模型容量，防止过拟合。
- **特征选择**：自动识别细胞系特异性重要基序。

#### 4. 连续编码支持外推
$\psi(c)$ 建立细胞系到连续特征的映射。对于新细胞系 $c'$：
- 若有 $v_{c'}$：直接计算 $g_{c'} = f(\psi(v_{c'}))$
- 若无：使用支持集样本 $S_{c'}$ 计算 $\psi(c') = \text{AttnPool}(\{\phi(x_i)\})$

由于 $f$ 是连续函数，相似细胞系产生相似 $g_c$，支持平滑外推。

### 物理/生物对应

#### 1. 特征调制 → 染色质可及性基序选择
$z_i$ 对应特定转录因子结合基序（如 CTCF、Pol II）。$g_{c,i}$ 对应该基序在细胞系 $c$ 染色质中的可及性（由 ATAC-seq/DNase-seq 测量）。$z_i \cdot g_{c,i}$ 表示**有效基序强度**。

#### 2. 交换对齐 → 进化保守的调控逻辑
尽管染色质状态随细胞系变化，核心调控逻辑（哪些基序组合指示互作）应保守。对齐损失强制此保守性。

#### 3. 稀疏性 → 细胞类型特异性的调控元件
每个细胞类型只调节少数特异的增强子-启动子互作通路，对应稀疏 $g_c$。

#### 4. 连续编码 → 细胞分化连续谱
细胞系间差异对应分化轨迹上的连续点，$v_c$ 编码此轨迹上的位置。

## 实施路线图

### 第一阶段：架构修改（`models/PRISMModel.py`）

#### 1. 细胞系编码器
```python
class CellLineEncoder(nn.Module):
    def __init__(self, feature_dim=64, hidden_dim=128, output_dim=256):
        # 若提供显式特征矩阵 V ∈ ℝ^{|C|×m}
        self.feature_proj = nn.Linear(feature_dim, hidden_dim) if feature_dim > 0 else None
        # 否则使用支持集注意力池化
        self.support_encoder = SupportSetEncoder(input_dim=768, hidden_dim=hidden_dim)

    def forward(self, cell_ids, cell_features=None, support_samples=None):
        # cell_features: [B, m] 或 None
        # support_samples: [B, k, d] 或 None
        if cell_features is not None:
            v = self.feature_proj(cell_features)
        else:
            v = self.support_encoder(support_samples)  # [B, hidden_dim]
        return v
```

#### 2. 稀疏门控生成器
```python
class SparseGatingGenerator(nn.Module):
    def __init__(self, input_dim=256, feature_dim=768, sparsity_lambda=0.1):
        self.mlp = nn.Sequential(
            nn.Linear(input_dim, 512),
            nn.ReLU(),
            nn.Linear(512, feature_dim)  # 输出 d 维 logits
        )
        self.sparsemax = Sparsemax(dim=-1)  # 需实现或使用现有

    def forward(self, v_c):
        logits = self.mlp(v_c)  # [B, d]
        g = self.sparsemax(logits)  # [B, d]，稀疏，∑_i g_i = 1
        return g
```

#### 3. 调制特征分类器
修改现有 `PRISMBackbone`：
- 保留现有序列编码器，获取 $z$（保持为 $d$ 维）
- 添加细胞系编码器和门控生成器
- 调制：$z_{\text{mod}} = z \odot g_c$
- 分类头：$y = \text{MLP}(z_{\text{mod}})$

#### 4. 损失模块集成
实现 `SwapAlignmentLoss`、`SparsityLoss`、`SmoothnessLoss`。

### 第二阶段：训练策略

#### 1. 课程学习
- Phase 1（1 epoch）：冻结门控生成器，$g_c = \mathbf{1}$（全通），训练序列编码器和分类器。
- Phase 2（2-4 epochs）：解冻门控，训练全部，逐步增加 $\alpha, \beta, \gamma, \delta$。
- Phase 3（剩余）：全量训练。

#### 2. 采样策略
- 使用 `CellBatchSampler` 保持批次内细胞系纯度。
- 为支持集编码器，每细胞系缓存 $k=32$ 个样本特征。

#### 3. 监控指标
- 训练/测试 AUPR、AUC
- 门控稀疏度：$\frac{1}{B}\sum_c \|g_c\|_0/d$
- 对齐损失值
- 平滑度：$\mathbb{E}_{c,c'}\|g_c - g_{c'}\|^2$

### 第三阶段：推理适配

#### 1. 未知细胞系处理
- 若有特征 $v_{c'}$：直接计算 $g_{c'}$。
- 若无：从测试细胞系随机采样 $k$ 个样本，提取特征，注意力池化得 $v_{c'}$，再计算 $g_{c'}$。

#### 2. 阈值校准
在验证集上优化阈值，最大化 F1。

### 第四阶段：失败应对预案

#### 1. 门控坍缩
若 $g_c$ 退化为全 0 或全 1，增加熵正则 $\gamma$。

#### 2. 对齐失败
若 $\mathcal{L}_{\text{align}}$ 不降，增加 $\alpha$ 或使用更紧的对比形式。

#### 3. 过拟合持续
增加稀疏性权重 $\beta$，或降低模型容量。

#### 4. 外推失败
检查 $v_c$ 的连续性，增加平滑性权重 $\delta$。

## 预期行为与理论保障

### 成功标志
1. **泛化差距缩小**：训练 AUPR ≈ 0.85-0.90，测试 AUPR ≥ 0.75，差距 ≤ 0.15。
2. **稀疏性合理**：门控稀疏度 10-30%（即 70-90% 基序被掩蔽）。
3. **对齐有效**：$\mathcal{L}_{\text{align}}$ 稳定下降，正样本调制特征跨细胞系相似。
4. **外推平滑**：相似细胞系门控向量相似（可可视化）。

### 理论优势
1. **归纳偏置贴合生物学**：特征选择机制直接对应染色质可及性。
2. **容量控制**：稀疏门控实质是特征选择，降低有效维度。
3. **不变性硬约束**：交换对齐直接优化 $I(z \odot g_c; c \mid y)$。
4. **连续性保障**：细胞系连续编码支持外推。

### 生物学可解释性
1. $z_i$：第 $i$ 个序列基序的强度。
2. $g_{c,i}$：细胞系 $c$ 中该基序的可及性。
3. $z_i \cdot g_{c,i}$：有效基序强度。
4. 可可视化：哪些基序在哪些细胞系中被门控（热图）。

---

**记录点26的本质创新在于放弃解耦范式，转向特征调制范式；将不变性学习从损失软约束转为架构硬约束（交换对齐）；并通过稀疏性、平滑性、连续性三重保障实现可解释的泛化。这是首次将细胞系环境建模为特征选择器而非全局偏置的尝试。**