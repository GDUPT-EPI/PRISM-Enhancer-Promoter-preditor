# 记录点9方案：流形对齐与同质化采样 (Manifold Alignment & Homogeneous Sampling)

## 1. 核心理念
从“竞争机制”转向**“流形对齐 (Manifold Alignment)”**。
核心目标是让 Student 在没有显式细胞 ID 的情况下，通过观察当前的 Support Set，推断出其在全局细胞系流形中的位置，从而生成正确的环境阻力 $R_E$。

## 2. 架构设计

### 2.1 全局细胞系原型图 (Graph Teacher)
Teacher 不再是一个简单的查表 Embedding，而是一个基于图神经网络 (GCN) 的全局流形构建者。
- **节点**：每个细胞系作为一个节点。
- **边**：基于细胞系的生物学相似性（如 TF 表达谱相似度、Hi-C 关联度等）构建边。如果缺乏先验，可基于 Embedding 的相似度动态构图。
- **功能**：Teacher 聚合邻居信息，生成具有全局上下文感知的细胞系表征 $M_T$。

### 2.2 上下文感知的 Student (Context-Aware Student)
Student 必须具备从 Support Set 中提取流形坐标的能力。
- **输入**：当前 Batch 的 Support Set $S = \{(x_i, y_i)\}_{i=1}^N$。
- **编码器**：使用 **DeepSet** 或 **ISAB (Induced Set Attention Block)** 对 $S$ 进行置换不变 (Permutation Invariant) 编码，得到 Batch 的环境表征 $M_S$。
- **对齐目标**：$M_S$ 必须尽可能接近 Teacher 生成的 $M_T$。

### 2.3 能量耗散系统的正交解耦 (Orthogonal Decoupling)
保持记录点4的核心优势，但修复其实现。
- **固有电势 $U_I(x)$**：仅由序列特征决定，代表结合的“倾向性”。使用正交约束，确保 $U_I$ 不包含环境信息。
- **环境阻力 $R_E(M)$**：由环境表征 $M$（来自 Teacher 或 Student）决定，代表当前细胞系的“非特异性阻碍”。
- **最终预测**：$P(y=1|x, M) = \sigma(\frac{U_I(x) - R_E(M)}{T})$

## 3. 关键实现细节

### 3.1 同质化采样与元批次训练 (Homogeneous Sampling & Meta-Batch Training)
**这是本方案成功的前提。**

1.  **同质化采样 (Homogeneous Sampling)**：
    *   废弃 `RandomBatchSampler`。
    *   将 **一个细胞系的采样集合** 视为 **一张“图片”**。
    *   每个“图片”包含该细胞系的 $N$ 个样本（例如 $N=256$）。Student 在这个范围内计算统计量（均值、方差），提取该细胞系的特异性纹理。

2.  **元批次训练 (Meta-Batch Training)**：
    *   **类比 CV 任务**：在 CV 中，我们不会一次只训练一张图片，而是训练一个 Batch 的图片。
    *   **CBAT 策略**：
        *   将训练集划分为无数个“图片” (Blocks)，每个 Block 包含来自同一细胞系的 $N$ 个样本。
        *   **随机选取图片**：将所有 Block 放入池中打乱，每次随机抽取 $K$ 个 Block 组成一个 Batch。
        *   **避免投机**：并不强制要求这 $K$ 个 Block 来自不同细胞系。这防止了模型利用“Batch内必然互斥”的规则进行投机（Shortcut Learning）。
    *   **实现方式**：
        *   **物理 Batch**：维度为 $[K \times N, \dots]$。
        *   **逻辑处理**：在模型内部，先将输入 Reshape 为 $[K, N, \dots]$。
        *   **Teacher/Student 运作**：对这 $K$ 个“图片”并行独立处理，分别生成 $K$ 个 $R_E$。
        *   **优势**：通过同时观察多个细胞系，模型能学习到细胞系之间的**差异性 (Contrast)**，避免 Student 坍缩到所有细胞系的均值，并稳定梯度的方向。

### 3.2 损失函数重构
$$L_{total} = L_{pred} + \lambda_{align} L_{align} + \lambda_{orth} L_{orth}$$

1.  **预测损失 $L_{pred}$**：标准的 BCE Loss。
2.  **流形对齐损失 $L_{align}$**：使 Student 的环境表征 $M_S$ 逼近 Teacher 的 $M_T$。
    $$L_{align} = ||M_S - \text{stop\_gradient}(M_T)||^2$$
3.  **正交解耦损失 $L_{orth}$**：确保 $U_I$ 和 $R_E$ 不相关。
    $$L_{orth} = \frac{|Cov(U_I, R_E)|}{\sigma(U_I)\sigma(R_E)}$$

## 4. 预期效果
- **解决模式坍缩**：同质化采样消除了输入的噪声，Student 不再“习得性无助”。
- **提升泛化性**：Student 学习的是“如何从样本中推断环境”，这种能力可以迁移到未见细胞系（只要给出一小批 Support Set）。
- **AUPR 突破**：通过正确的 $R_E$ 调节，去除假阳性，提升 Precision。
