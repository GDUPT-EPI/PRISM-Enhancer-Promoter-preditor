# CBAT 记录点9反思：元批次采样的陷阱与模式坍缩的延续

## 1. 现象分析

### 1.1 结果概览
在 `历史结果.log` 中，记录点9 的表现与记录点8 几乎完全一致，呈现出典型的**模式坍缩 (Mode Collapse)** 特征：
- **AUPR 停滞**：GM12878 AUPR 停留在 0.5346，远低于 Baseline 的 0.6663。
- **极端 Recall/Precision**：Recall 全线为 1.0000，Precision 全线约为 0.5000。
- **阈值失效**：Threshold 收敛到 0.0100，意味着模型输出了极低的置信度，或者判别边界完全模糊。

### 1.2 预期 vs 实际
- **预期**：引入 `MetaBatchSampler`（元批次采样）和“图片池”机制，将同质化样本打包成 Block，理论上 Student 应该能从 Block 中提取出稳定的环境特征 $M_S$，从而进行有效的推断。
- **实际**：模型表现与随机采样（记录点8）无异，说明 Student 依然未能利用 Context 信息，或者 Context 信息本身被某种机制“清洗”掉了。

## 2. 核心问题反思

### 2.1 随机 Block 采样的“噪声陷阱”
我们虽然实施了同质化 Block 采样（即一个 Block 内的样本来自同一细胞系），但在 Batch 组装层面，采用了**随机抽取 Block** 的策略。
- **问题**：一个 Batch 可能包含来自不同细胞系的 Block（例如：Batch = [GM12878_Block, NHEK_Block, ...]）。
- **后果**：
  - Student 在处理 Batch 时，如果其 Attention 机制（如 ISAB）没有被显式地限制在 Block 内部，而是跨 Block 交互，那么它看到的依然是**混合分布**。
  - 这种混合分布导致 Context 均值趋向于全局平均，Student 无法区分特定细胞系的环境阻抗 $R_E$。
  - 最终，$R_E$ 退化为常数，模型回退到仅依赖 $U_I$（序列特征）进行预测，而 $U_I$ 本身无法区分细胞特异性，导致模型选择“全选”策略以最大化 Recall。

### 2.2 Teacher 的“摆烂”
在当前的架构中，Teacher 依赖于 Cell ID 查表（Embedding）。
- **问题**：当 Batch 内混合了多个 Cell ID 时，Teacher 能够轻松地通过 ID 获取完美的 $R_E$。
- **后果**：
  - Teacher 变得“太强”且“懒惰”，它不需要理解流形结构，只需查表。
  - Student 试图模仿 Teacher，但 Student 无法看到 Cell ID，只能看序列。
  - 由于 Batch 内分布的混杂性，Student 发现无法通过序列统计特征拟合 Teacher 的查表结果，最终导致 Student 的梯度方向迷失，无法收敛。

### 2.3 竞争机制的失效 (Competition Failure)
我们设计的 Student-Teacher 竞争机制（KL 散度约束）在模式坍缩下完全失效。
- **现象**：Loss 不降反升，或者迅速收敛到一个平凡解。
- **原因**：当 Teacher 和 Student 的输入信息量不对等（Teacher 有 ID，Student 只有噪声 Context）时，竞争不再公平。Student 无法从 Teacher 那里学到有意义的流形结构，只能学到 Teacher 的“输出值”，而忽略了“生成逻辑”。

## 3. 根本症结：缺乏全局流形视角

我们一直试图通过 Local Context（Batch/Block）来推断 Global Context（Cell Line Distribution），这在数学上是一个**病态问题 (Ill-posed Problem)**，除非我们引入强先验。

- **缺失的一环**：**全局细胞系原型图 (Cell Prototype Graph)**。
- **逻辑**：单个 Batch 的信息量是不足以描述整个细胞系的。我们需要一个显式的图结构，将所有已知的细胞系及其关系（如组织来源、生物学相似度）编码进去。
- **修正方向**：
  - Teacher 不应只查 ID，而应在图上进行**随机游走或 GCN 聚合**，生成具有拓扑意义的 $M_T$。
  - Student 应该尝试将当前的 Support Set **映射 (Map)** 到这个全局图上的某个节点或区域，从而获得 $M_S$。

## 4. 结论与下一步

记录点9 的失败证明了：**仅靠采样策略的调整（物理隔离）不足以解决信息流的混乱。必须在模型结构层面（逻辑隔离与对齐）进行重构。**

我们需要从 **"Competition" (竞争)** 转向 **"Manifold Alignment" (流形对齐)**。

### 关键行动
1.  **废弃随机 Block 混拼**：确保训练阶段，Student 的输入在逻辑上是纯净的，或者在 Attention 层面实施严格的 Block Mask。
2.  **构建 Graph Context**：实现 `CellPrototypeGraph`，为 Teacher 提供结构化先验。
3.  **正交解耦**：强制 $U_I$（序列特征）与 $R_E$（环境特征）正交，防止特征泄露。
