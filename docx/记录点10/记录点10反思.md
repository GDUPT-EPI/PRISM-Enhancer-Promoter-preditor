# 记录点10反思：CED-Net 实现的逻辑断裂与预测端的适应性缺失

## 1. 核心问题诊断：预测端与训练端的“精神分裂”

在记录点10的实验结果中，我们观察到所有细胞系的 AUPR 都停滞在 0.55-0.58 的区间，且 F1 分数极低（~0.3），这表明模型发生了严重的模式坍缩（Mode Collapse）。

经过仔细审查 `PRISMModel.py` 和 `predict.py` 的代码，我们发现了导致这一现象的根本原因：**训练时的复杂设计在预测时被完全旁路，导致模型在推理阶段退化为最原始的无环境感知状态。**

### 1.1 预测时的“环境失明”
- **现象**：在 `predict.py` 中，调用 `backbone(..., cell_labels=None)` 进行推理。
- **后果**：
  - 在 `PRISMModel.forward` 中，当 `cell_labels` 为 None 时，`R_E`（环境阻抗）被强制设为 0（`R_E = torch.zeros_like(U_I)`）。
  - **这意味着**：模型辛辛苦苦训练的 CED-Net（Teacher-Student-Opportunist）架构，在预测时根本没有被激活！模型仅仅依赖 $U_I$（内势）进行预测。
  - 由于 $U_I$ 被设计为“剔除环境信息的绝对不变量”，它本身就不包含细胞特异性。
  - **结果**：所有细胞系的预测结果都只反映了 DNA 序列的基础亲和力，完全丢失了细胞特异性的染色质环境信息，导致 AUPR 无法突破基线。

### 1.2 CED-Net 逻辑在代码中的断裂
尽管我们在 `PRISMModel.py` 中定义了 Student 和 Teacher，但在 `forward` 函数的推理路径（`else` 分支）中：
```python
else:
    # 推理模式 (无标签)
    z_G, z_F = self.bypass_generator(z_I)
    R_E = self.resistance_generator(z_F) # 仅仅简单地通过 z_F 生成 R_E
    aux_outputs['R_E'] = R_E
```
这里的 `R_E` 生成逻辑非常脆弱。在没有 Teacher 引导（因为没有 Label）且没有 Student 主动校准（代码中未调用 Student 模块进行推理）的情况下，`bypass_generator` 生成的 `z_F` 极有可能是一个平均化的噪声，导致 `R_E` 也是无效的。

**关键缺失**：我们设计 Student 的初衷就是为了在 OOD（未见细胞系）情况下，通过观察 Batch 上下文来推断 $R_E$。但在推理代码中，我们**既没有构建 Batch 上下文（预测时是一个个 Batch 过的，且未保证同质性），也没有调用 Student 模块来生成 $R_E$**。

## 2. 训练与预测的割裂

### 2.1 训练时的“假象”
- 训练时 `DISTILL_ENABLED` 开启，Teacher 利用 `cell_labels` 提供了完美的 $R_T$ 指导，Student 也在努力拟合。
- Loss 下降给了我们“模型在学习”的错觉。
- 但由于预测时 `cell_labels` 缺失，Teacher 离场，Student 又没被正确召唤，模型瞬间“失智”。

### 2.2 预测脚本的滞后
`predict.py` 依然沿用着旧时代的逻辑（简单的 `model(x)`），完全没有适配 CED-Net 的新特性：
- **缺失 Context 构建**：没有按细胞系组织 Batch，导致无法利用 Batch 内的统计信息。
- **缺失 Student 调用**：没有显式调用 `student1` 来获取鲁棒的 $R_S$。

## 3. 深度反思：为什么总是重蹈覆辙？

我们多次陷入“训练很美好，预测一团糟”的循环，根本原因在于**对 OOD (Out-of-Distribution) 泛化的实现路径存在认知偏差**。

- **误区**：认为只要训练时加入了对抗/蒸馏，模型就会“自动”具备泛化能力。
- **真相**：OOD 泛化需要**推理时的显式适应（Explicit Adaptation at Inference Time）**。
  - 就像人类到了新环境需要先观察（Gather Context）再行动（Predict）一样。
  - 我们的模型在推理时，却被剥夺了“观察环境”的机会（没有 Context），被迫“盲猜”。

## 4. 结论

**不是模型能力不行，而是模型没被用对。**

我们拥有一辆法拉利（CED-Net），但在比赛时（预测阶段），我们却把它当成三轮车（仅用 $U_I$）在开。

**下一步的核心任务不是修改模型架构，而是彻底重构预测流程**，使其与 CED-Net 的设计初衷（Context-Aware Inference）相匹配。
