## 失败结构定理

**记录点22（对比解耦网络）的失败本质是：解耦目标与实现架构之间存在“几何断层”——对比学习与原型网络作为表示几何的硬约束，在实施中被简化为传统能量耗散系统的软正则，导致约束失效、表示坍缩、过拟合加剧。**

形式化地，设解耦目标为最小化互信息 $I(z_I; z_E)$，同时保持 $I(z_I; y)$ 大而 $I(z_I; c)$ 小。实现方案使用对比损失 $\mathcal{L}_{\text{cont}}$ 与原型损失 $\mathcal{L}_{\text{proto}}$ 作为几何约束。然而，在梯度更新中，这些约束的梯度范数 $|\nabla \mathcal{L}_{\text{cont}}|$ 和 $|\nabla \mathcal{L}_{\text{proto}}|$ 远小于主任务损失梯度 $|\nabla \mathcal{L}_{\text{task}}|$，导致几何约束被淹没，优化轨迹收敛到满足 $\mathcal{L}_{\text{task}} \approx 0$ 但 $\mathcal{L}_{\text{cont}}, \mathcal{L}_{\text{proto}}$ 任意大的点——即过拟合解。

## 根因分析

### 数学层面

#### 1. 梯度竞争与淹没效应
多目标优化问题：
\[
\min_{\theta} \mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}} + \alpha \mathcal{L}_{\text{cont}} + \beta \mathcal{L}_{\text{proto}} + \dots
\]
当 $\alpha, \beta$ 较小时（通常设为 0.05–0.1），对比损失与原型损失的梯度贡献被主任务损失的梯度主导。生物学上，$\mathcal{L}_{\text{task}}$ 对应拟合观测数据，而 $\mathcal{L}_{\text{cont}}, \mathcal{L}_{\text{proto}}$ 对应结构先验。若先验权重不足，模型优先满足数据拟合，忽略结构约束。

#### 2. 对比损失的信息论瓶颈
InfoNCE 损失 $\mathcal{L}_{\text{cont}} = -\mathbb{E}[\log \frac{\exp(z_i^\top z_j/\tau)}{\sum_k \exp(z_i^\top z_k/\tau)}]$ 的有效性依赖于负样本数量与批次多样性。在 `CellBatchSampler` 下，批次内仅含单细胞系样本，负样本来自同一细胞系的不同实例，其语义差异小，导致对比损失信号弱，难以驱动跨细胞系分离。

#### 3. 原型网络的动量平均陷阱
原型更新 $p_c \leftarrow \mu p_c + (1-\mu) \mathbb{E}[e]$ 采用动量平均，这使原型 $p_c$ 收敛到细胞系特征分布的均值。然而，均值可能掩盖细胞系内异质性，且对离群样本不鲁棒。更重要的是，原型损失 $\mathcal{L}_{\text{proto}} = \|e - p_c\|^2$ 强制所有样本的环境特征 $e$ 向原型收缩，这可能导致信息丢失与表示坍缩。

#### 4. 正交约束的优化不稳定性
严格正交损失 $\mathcal{L}_{\text{orth}} = \|z_I^\top z_E\|^2$ 在 $z_I$ 或 $z_E$ 范数接近零时梯度消失，且可能与其它损失（如域对抗）梯度冲突，导致训练震荡或停滞。

### 算法层面

#### 1. 实施偏差
方案设计中的核心组件（双流编码器、对比损失模块、原型网络）在代码实现中未被正确集成。具体地：
- 对比损失可能仅在部分层应用，而非贯穿整个表示学习。
- 原型更新可能未与训练循环同步，导致原型过时。
- 正交损失可能被错误计算（如未归一化）。

#### 2. 损失权重调度缺失
课程学习策略未实施：环境编码器 $f_E'$ 未被冻结初期训练，导致 $z_E$ 早期噪声大，干扰 $z_I$ 学习。损失权重 $\alpha, \beta, \gamma, \delta$ 固定不变，未能适应训练阶段。

#### 3. 评估断层
训练时使用混合细胞系批次（尽管有 `CellBatchSampler`，但可能未生效），而推理时要求按细胞系组织支持集。这种不一致使模型在训练时未学习真正的环境推断能力。

#### 4. 温度参数未校准
固定 $T=1.0$ 忽略能量尺度变化。当 $U_I$ 与 $R_E$ 量级不匹配时，$U_I - R_E$ 可能极大或极小，导致 Sigmoid 饱和，梯度消失。

### 生物学层面

#### 1. 过度简化的解耦假设
生物学中，序列特征与细胞环境并非完全正交。例如，细胞系特异性染色质状态可能影响哪些序列模体被暴露。强制正交可能破坏这种自然共适应。

#### 2. 忽略层次结构
细胞系间存在进化与发育关系（如上皮细胞 vs 成纤维细胞）。对比学习将不同细胞系视为类别独立，未利用其层次相似性，导致表示空间不连续，泛化困难。

#### 3. 能量公式的线性局限
真实生物学中，环境对序列效应的调节常为非线性（如协同激活、竞争抑制）。线性可加模型 $U_I - R_E$ 无法捕获此类交互，迫使模型用细胞系特异性偏置补偿，从而过拟合。

## 关键洞察

1. **解耦需要梯度平衡**：几何约束损失必须与主任务损失具有可比梯度范数，否则被淹没。这意味着需要自适应损失权重或梯度裁剪。

2. **对比学习需要跨细胞系负样本**：同一细胞系内的负样本对比信号弱，应确保批次包含多细胞系样本（如通过跨批次存储库）。

3. **原型网络需防坍缩**：原型损失应允许适度发散，例如使用对比原型损失或阈值截断。

4. **正交约束可松弛**：相关性最小化 $\text{Corr}(z_I, z_E) \to 0$ 比严格正交更稳定且生物学合理。

5. **能量公式需交互项**：引入 $U_I$ 与 $R_E$ 的非线性交互（如乘积项）能更好地模拟生物学调节。

6. **温度必须可学习**：固定温度导致概率尺度僵化，可学习温度使模型自适应能量尺度。

7. **课程学习关键**：先训练序列‑互作基础，再引入环境解耦，避免早期噪声干扰。

## 对下一步的启示

1. **损失权重自适应**：根据梯度范数动态调整 $\alpha, \beta, \gamma, \delta$，确保几何约束有效。

2. **跨批次对比**：使用内存库存储历史样本特征，提供跨细胞系负样本。

3. **相关性解耦**：用 Pearson 相关系数平方替代正交损失，避免梯度消失。

4. **交互能量公式**：扩展为 $U_I - R_E + \lambda U_I R_E$，捕获非线性调节。

5. **可学习温度**：参数化 $T = \text{softplus}(t)$。

6. **稀疏正则**：添加 L1 损失 $|z_I|_1 + |z_E|_1$，降低复杂度，诱导生物学稀疏性。

7. **分层对比**：利用细胞系层次信息构造语义负样本。

8. **严格实施纪律**：确保设计方案中的每个组件都在代码中正确实现，并进行消融验证。

**记录点23反思的核心价值在于揭示了“几何约束的梯度淹没”是解耦失败的根本机制，并为记录点24的方案提供了具体的数学与算法改进方向。**