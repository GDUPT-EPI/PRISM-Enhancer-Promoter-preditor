## 核心洞察（一句话）

**通过双流正交表示分解，将细胞系不变信息压缩到内势流 $z_I$，细胞系特定信息聚类到环境流 $z_E$，并施加几何硬约束（正交损失、对比损失、域对抗）实现严格解耦，从而获得可泛化的能量耗散系统。**

## 问题的数学形式化

### 输入与输出空间
- 输入样本：$x = (E, P)$ DNA序列对，来自细胞系环境 $c \in \mathcal{C}$。
- 标签：$y \in \{0,1\}$ 表示互作与否。
- 目标：学习条件概率 $P(y|x, c)$，使其在未知细胞系 $c' \notin \mathcal{C}_{\text{train}}$ 上泛化。

### 假设空间
我们假设数据生成过程遵循**因果图** $c \rightarrow x \rightarrow y$，其中 $c$ 影响 $x$（序列可能含有细胞系特异性变异），同时 $c$ 也直接影响 $y$（细胞环境调控互作）。目标是估计 $x$ 对 $y$ 的**直接因果效应**，控制 $c$ 的后门路径。

### 能量耗散框架的数学重构
传统能量耗散公式 $P(y=1|x,c) = \sigma((U_I(x) - R_E(c))/T)$ 隐式假设了可加性分解。我们将其推广为双流交互形式：

\[
P(y=1|x,c) = \sigma\left( \frac{U_I(z_I) - R_E(z_E)}{T} \right)
\]

其中：
- $z_I = f_I(x)$ 是**细胞系不变特征**，满足 $p(z_I|c) = p(z_I)$（分布不变）。
- $z_E = f_E(c)$ 是**细胞系特定特征**，对于未知细胞系 $c'$，通过支持集 $S_{c'} = \{x^{(c')}_1,\dots,x^{(c')}_m\}$ 估计为 $z_E = \mathbb{E}_{x \sim S_{c'}}[f_E'(x)]$，其中 $f_E'$ 是环境特征提取器。

关键约束：
1. **正交性**：$\langle z_I, z_E \rangle = 0$（表示空间正交）。
2. **不变性**：$I(z_I; c) \to 0$（互信息最小化）。
3. **可辨识性**：$I(z_E; c) \to \max$（细胞系可从 $z_E$ 区分）。
4. **预测一致性**：$P(y|x,c)$ 应与数据匹配。

## 解决方案

### 数学描述

#### 1. 双流编码器架构
- **不变编码器** $f_I: \mathcal{X} \to \mathbb{R}^{d_I}$：基于 PRISMBackbone，输出 $z_I$。
- **环境编码器** $f_E': \mathcal{X} \to \mathbb{R}^{d_E}$：轻量 MLP，输入为序列特征（来自 Backbone 的中间层），输出环境特征 $e$。对于已知细胞系 $c$，$z_E = \mathbb{E}_{x \in S_c}[e]$（支持集均值）；对于未知细胞系，使用其支持集计算。
- **内势预测器** $g_I: \mathbb{R}^{d_I} \to \mathbb{R}$：单层线性，输出 $U_I = g_I(z_I)$。
- **阻抗预测器** $g_E: \mathbb{R}^{d_E} \to \mathbb{R}_+$：单层线性加 ReLU，输出 $R_E = g_E(z_E)$（非负）。
- **温度** $T$：固定为 1.0（避免饱和）。

#### 2. 损失函数体系

**主任务损失**（AdaptiveIMMAXLoss）：
\[
\mathcal{L}_{\text{task}} = \text{IMMAX}\left( \sigma\left( \frac{U_I - R_E}{T} \right), y \right)
\]

**正交损失**（硬约束）：
\[
\mathcal{L}_{\text{orth}} = \left\| \frac{z_I}{\|z_I\|_2}^\top \frac{z_E}{\|z_E\|_2} \right\|^2
\]

**不变性损失**（域对抗）：
通过梯度反转层（GRL）和细胞系分类器 $D: \mathbb{R}^{d_I} \to \Delta^{|\mathcal{C}|}$ 实现：
\[
\mathcal{L}_{\text{inv}} = \mathbb{E}_{(x,c)}[ \text{CrossEntropy}(D(\text{GRL}(z_I)), c) ]
\]
目标是最小化分类器准确率，即最大化分类误差。

**可辨识性损失**（对比学习）：
对于批次中来自同一细胞系的样本对 $(x_i, x_j)$，计算环境特征 $e_i = f_E'(x_i)$, $e_j = f_E'(x_j)$，使用 InfoNCE 损失：
\[
\mathcal{L}_{\text{cont}} = -\frac{1}{N} \sum_{i=1}^N \log \frac{\sum_{j \neq i} \mathbb{1}_{c_i = c_j} \exp(e_i^\top e_j / \tau)}{\sum_{j \neq i} \exp(e_i^\top e_j / \tau)}
\]
其中 $\tau$ 为温度超参数。

**原型一致性损失**：
对于每个细胞系 $c$，维护其原型 $p_c = \mathbb{E}_{x \in S_c}[e]$（动量更新）。最小化：
\[
\mathcal{L}_{\text{proto}} = \|e - p_c\|^2
\]

**总损失**：
\[
\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}} + \alpha \mathcal{L}_{\text{orth}} + \beta \mathcal{L}_{\text{inv}} + \gamma \mathcal{L}_{\text{cont}} + \delta \mathcal{L}_{\text{proto}}
\]
系数 $\alpha, \beta, \gamma, \delta$ 控制各约束强度。

#### 3. 采样策略（硬约束）
使用 **CellBatchSampler** 确保每个训练批次仅包含**单个细胞系**的样本。这是环境特征纯净估计的必要条件。批次内样本随机划分为支持集（用于计算 $z_E$）和查询集（用于计算损失）。支持集大小 $m$ 可设为批次大小的一半。

#### 4. 课程学习策略
- **阶段1（前2个epoch）**：冻结 $f_E'$ 和 $g_E$，设 $R_E=0$，只训练 $f_I$ 和 $g_I$，使模型初步学习序列-互作关联。
- **阶段2（后续epoch）**：解冻所有参数，联合训练，逐步增加 $\beta, \gamma, \delta$ 的权重。

### 核心机制

#### 为何双流正交能实现解耦？
正交损失强制 $z_I$ 和 $z_E$ 位于表示空间的正交子空间，阻止信息共享。域对抗损失进一步推动 $z_I$ 与细胞系无关，而对比损失和原型损失推动 $z_E$ 与细胞系强相关。这两股力量在正交约束下不会冲突，而是协同将细胞系信息“挤压”到 $z_E$ 中，同时净化 $z_I$。

#### 如何避免模式坍缩？
历史元学习方案失败的原因是批次内细胞系混合，导致 $z_E$ 估计为噪声，进而使 $R_E$ 退化为常数偏置。本方案通过 **CellBatchSampler** 保证批次内细胞系纯净，使 $z_E$ 估计稳定；通过原型动量更新提供平滑的环境表示；通过课程学习避免早期训练不稳定。

#### 温度固定的意义？
温度 $T$ 控制能量差的灵敏度。固定 $T=1.0$ 避免模型通过调整 $T \to 0$ 使概率饱和（Recall≈1, Precision≈0.5）。能量差 $(U_I - R_E)$ 的尺度由网络权重自然调节，无需额外温度参数。

### 物理/生物对应

1. **双流正交 → 染色质区室化**：细胞核内染色质分为 A/B 区室，分别对应活跃/沉默染色质。$z_I$ 类比于序列固有的亲和力（由 DNA 序列决定），$z_E$ 类比于染色质区室状态（细胞系特定）。正交性反映了序列亲和力与染色质状态在物理空间上的分离。

2. **对比学习 → 细胞类型身份识别**：$z_E$ 的对比损失迫使不同细胞系的特征分离，类似于免疫系统中细胞表面标志物的差异，使免疫细胞能区分自身与非自身。

3. **域对抗 → 进化保守性**：$z_I$ 的域对抗损失迫使模型忽略细胞系变异，只保留进化上保守的序列模块，类似于跨物种保守的调控元件。

4. **能量耗散 → 热力学平衡**：$U_I - R_E$ 对应结合自由能变，其中 $U_I$ 为结合焓（序列特异性），$R_E$ 为熵罚（环境抑制）。公式 $\sigma((U_I - R_E)/T)$ 直接来自配体-受体结合的热力学模型。

## 实施路线图

### 第一阶段：架构修改
1. **修改 PRISMModel.py**：
   - 增加环境编码器 $f_E'$（轻量 MLP），输入为 Backbone 中间层特征（例如池化后的序列特征）。
   - 增加内势预测器 $g_I$ 和阻抗预测器 $g_E$。
   - 增加 GRL 层和细胞系分类器 $D$。
   - 在 forward 中实现支持集-查询集划分，计算 $z_E$ 作为支持集环境特征的均值。
2. **实现损失模块**：
   - 正交损失（余弦相似度平方）。
   - 对比损失（InfoNCE）。
   - 原型损失（MSE）。
   - 域对抗损失（GRL + CrossEntropy）。
3. **修改采样器**：
   - 确保 `CellBatchSampler` 在训练时被使用，批次大小设为 64，支持集大小 32。

### 第二阶段：训练流程调整
1. **课程学习调度**：前 2 epoch 冻结环境相关参数，只训练 $f_I$ 和 $g_I$。
2. **损失权重调度**：初始权重 $\alpha=0.1, \beta=0.1, \gamma=0.05, \delta=0.05$，每 2 epoch 增加 0.05 直到上限（$\alpha=0.2, \beta=0.2, \gamma=0.1, \delta=0.1$）。
3. **监控指标**：
   - 训练/验证 AUPR、AUC、F1。
   - 正交损失值（应趋近于 0）。
   - 域对抗分类准确率（应趋近于随机猜测，即 $1/|\mathcal{C}|$）。
   - 对比损失（应稳步下降）。
   - 原型更新距离（应逐步减小）。

### 第三阶段：推理适配
1. **预测流程**：对于每个待预测细胞系，先随机抽取 $m$ 个样本作为支持集，计算 $z_E$，然后对所有样本应用能量公式。
2. **避免数据泄露**：支持集与查询集需来自同一细胞系，但互作标签未知（符合实际 OOD 场景）。

## 预期行为与验证

### 训练指标监控
- 训练 AUPR 应稳步上升，但不超过 0.90（警戒线）。
- 验证 AUPR（留出部分细胞系）应与训练 AUPR 同步上升，gap ≤ 0.15。
- 正交损失应快速下降至 $<10^{-3}$。
- 域对抗分类准确率应低于 30%（随机猜测约 16.7%，因有 6 个训练细胞系）。

### 测试期望
- 在 domain-kl/test 上，AUPR 应超过记录点4（0.71–0.72），目标 0.75+。
- 各细胞系 Recall 与 Precision 应平衡（Recall 0.6–0.8, Precision 0.6–0.8）。
- 未知细胞系的泛化性能应显著优于基线。

### 失败边界与应对
1. **梯度冲突导致训练发散**：降低 $\beta, \gamma, \delta$ 权重，或采用梯度裁剪。
2. **正交损失不下降**：增加 $\alpha$ 权重，或改为余弦相似度绝对值的均值。
3. **过拟合依然严重**：增加 Dropout（0.2）、权重衰减（1e-4），或提前停止。
4. **对比损失振荡**：减小 $\tau$（如 0.1），或增加批次大小。

### 退路方案
若双流正交难以优化，可退化为**单流对比解耦**：只使用 $f_E'$ 提取环境特征，$z_I$ 仍由 Backbone 输出，但不对 $z_I$ 施加域对抗，只保留正交损失。这简化了优化，但仍保持解耦核心思想。

---

**记录点23的本质创新在于将解耦问题从损失加权提升到表示几何的硬约束，并通过双流正交、对比学习、域对抗的三重约束，为能量耗散系统提供一个稳定、可解释、可泛化的数学基础。**